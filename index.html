<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MediCore - Expediente Cl√≠nico Electr√≥nico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    <!-- Chart.js para gr√°ficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-t-4 border-blue-600">
            <div class="text-center mb-8">
                <img src="logo.png" alt="MediCore Logo" class="w-64 h-64 mx-auto mb-6 object-contain">
            </div>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email / C√©dula</label>
                    <input type="email" id="login-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ejemplo@hospital.mx">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Contrase√±a</label>
                    <input type="password" id="login-password" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Rol de Usuario</label>
                    <select id="login-role" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="medico">M√©dico</option>
                        <option value="paciente">Paciente</option>
                        <option value="admin">Personal Administrativo</option>
                    </select>
                </div>
            </div>

            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg">
                Ingresar
            </button>

            <button type="button" id="create-test-user-btn" class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow-lg text-sm">
                <i class="fa-solid fa-user-plus mr-2"></i>Crear Usuario de Prueba
            </button>

            <p class="text-center text-sm text-gray-600 mt-4">
                ¬øNo tienes cuenta? <a href="#" id="show-signup" class="text-blue-600 hover:underline font-semibold">Reg√≠strate</a>
            </p>
        </div>
    </div>

    <!-- Signup Screen -->
    <div id="signup-screen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md border-t-4 border-green-600">
            <div class="text-center mb-8">
                <i class="fa-solid fa-user-plus text-green-600 text-5xl mb-4"></i>
                <h1 class="text-3xl font-black text-gray-900">Crear Cuenta</h1>
                <p class="text-sm text-gray-500 mt-2">MediCore - Sistema de Expediente Cl√≠nico</p>
            </div>

            <div class="space-y-4 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Email</label>
                    <input type="email" id="signup-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="email@hospital.mx">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Contrase√±a</label>
                    <input type="password" id="signup-password" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Confirmar Contrase√±a</label>
                    <input type="password" id="signup-password-confirm" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre</label>
                    <input type="text" id="signup-name" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Nombre">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Apellido</label>
                    <input type="text" id="signup-lastname" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none" placeholder="Apellido">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Rol</label>
                    <select id="signup-role" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none">
                        <option value="paciente">Paciente</option>
                        <option value="medico">M√©dico</option>
                        <option value="admin">Personal Administrativo</option>
                    </select>
                </div>
            </div>

            <button id="signup-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow-lg">
                Crear Cuenta
            </button>

            <p class="text-center text-sm text-gray-600 mt-4">
                ¬øYa tienes cuenta? <a href="#" id="show-login" class="text-green-600 hover:underline font-semibold">Inicia sesi√≥n</a>
            </p>
        </div>
    </div>

    <!-- Dashboard Screen -->
    <div id="dashboard-screen" class="hidden min-h-screen">
        <!-- Navbar -->
        <nav class="bg-white border-b border-gray-200 relative" style="font-family: 'Inter', sans-serif;">
            <img src="logo.png" alt="MediCore Logo" style="width: 180px; height: 180px; position: absolute; left: 24px; top: -50px;" class="object-contain">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <div></div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <p class="font-semibold text-gray-900" id="user-name">Usuario</p>
                        <p class="text-sm text-gray-600" id="user-role">Rol</p>
                    </div>
                    <button onclick="switchView('mi-cuenta')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition text-sm font-bold" id="btn-mi-cuenta" style="display:none;">
                        <i class="fa-solid fa-user-circle mr-2"></i>Mi Cuenta
                    </button>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition text-sm font-bold">
                        <i class="fa-solid fa-sign-out mr-2"></i>Salir
                    </button>
                </div>
            </div>
        </nav>

        <!-- Sidebar + Content -->
        <div class="flex">
            <!-- Sidebar -->
            <aside class="w-48 bg-white border-r border-gray-200 p-6 min-h-screen" style="font-family: 'Inter', sans-serif;">
                <div class="space-y-6">
                    <!-- M√©dico Menu -->
                    <div id="medico-menu" class="hidden space-y-3">
                        <button onclick="switchView('mis-pacientes')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 group hover:bg-blue-50" title="Pacientes" onmouseover="this.querySelector('i').style.color='#1465ff'" onmouseout="this.querySelector('i').style.color='#859ac1'">
                            <i class="fa-solid fa-users transition" style="color: #859ac1;"></i> <span class="text-gray-700">Pacientes</span>
                        </button>
                        <button onclick="switchView('nueva-consulta')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="Consultas">
                            <i class="fa-solid fa-stethoscope transition" style="color: #859ac1;"></i> <span class="text-gray-700">Consultas</span>
                        </button>
                        <button onclick="switchView('recetas')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="Recetas">
                            <i class="fa-solid fa-prescription-bottle transition" style="color: #859ac1;"></i> <span class="text-gray-700">Recetas</span>
                        </button>
                        <button onclick="switchView('agenda-operativa')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="Agenda">
                            <i class="fa-solid fa-calendar transition" style="color: #859ac1;"></i> <span class="text-gray-700">Agenda</span>
                        </button>
                        <button onclick="switchView('productos')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="Productos">
                            <i class="fa-solid fa-box transition" style="color: #859ac1;"></i> <span class="text-gray-700">Productos</span>
                        </button>
                        <button onclick="switchView('cobros')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="Cobros">
                            <i class="fa-solid fa-cash-register transition" style="color: #859ac1;"></i> <span class="text-gray-700">Cobros</span>
                        </button>
                    </div>

                    <!-- Paciente Menu -->
                    <div id="paciente-menu" class="hidden space-y-3">
                        <button onclick="switchView('mi-expediente')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="Expediente">
                            <i class="fa-solid fa-file-medical transition" style="color: #859ac1;"></i> <span class="text-gray-700">Expediente</span>
                        </button>
                        <button onclick="switchView('mis-citas')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="Citas">
                            <i class="fa-solid fa-calendar transition" style="color: #859ac1;"></i> <span class="text-gray-700">Citas</span>
                        </button>
                        <button onclick="switchView('resultados')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="Resultados">
                            <i class="fa-solid fa-flask-vial transition" style="color: #859ac1;"></i> <span class="text-gray-700">Resultados</span>
                        </button>
                    </div>

                    <!-- Admin Menu -->
                    <div id="admin-menu" class="hidden space-y-3">
                        <button onclick="switchView('pacientes')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="Pacientes">
                            <i class="fa-solid fa-person transition" style="color: #859ac1;"></i> <span class="text-gray-700">Pacientes</span>
                        </button>
                        <button onclick="switchView('medicos')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="M√©dicos">
                            <i class="fa-solid fa-user-doctor transition" style="color: #859ac1;"></i> <span class="text-gray-700">M√©dicos</span>
                        </button>
                        <button onclick="switchView('citas')" class="w-full text-left px-4 py-3 rounded-lg transition flex items-center gap-3 text-sm font-bold text-gray-700 hover:bg-blue-50" title="Citas">
                            <i class="fa-solid fa-calendar-check transition" style="color: #859ac1;"></i> <span class="text-gray-700">Citas</span>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8" style="background-color: #f9fbfc;">
                <!-- Mis Pacientes (M√©dico) -->
                <div id="mis-pacientes" class="view hidden" style="font-family: 'Inter', sans-serif;">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black text-gray-900">Mis Pacientes</h2>
                        <div class="relative inline-block group">
                            <button class="text-white font-bold px-6 py-3 rounded-lg transition flex items-center gap-2 shadow-lg" style="background-color: #1465ff;">
                                <i class="fa-solid fa-plus mr-2"></i> Nuevo Paciente
                                <i class="fa-solid fa-chevron-down ml-2"></i>
                            </button>
                            <div class="absolute right-0 mt-0 w-48 bg-white border border-gray-200 rounded-lg shadow-xl hidden group-hover:block z-10">
                                <button onclick="abrirModalNuevoPaciente()" class="w-full text-left px-4 py-3 hover:bg-blue-50 font-bold text-gray-900 border-b border-gray-200 flex items-center gap-2">
                                    <i class="fa-solid fa-user-plus" style="color: #1465ff;"></i> Crear Paciente
                                </button>
                                <button onclick="abrirModalImportarExcel()" class="w-full text-left px-4 py-3 hover:bg-blue-50 font-bold text-gray-900 flex items-center gap-2 rounded-b-lg">
                                    <i class="fa-solid fa-file-csv text-green-600"></i> Importar de Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Buscador de Pacientes -->
                    <div class="mb-6">
                        <div class="relative">
                            <i class="fa-solid fa-magnifying-glass absolute left-4 top-4 text-gray-400"></i>
                            <input type="text" id="buscar-pacientes" placeholder="Buscar por nombre, CURP o email..." class="w-full border border-gray-300 rounded-lg px-4 py-3 pl-12 outline-none font-bold shadow-sm" style="font-family: 'Inter', sans-serif;" oninput="filtrarPacientes()">
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="text-white" style="background-color: #1465ff;">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-black" style="font-family: 'Inter', sans-serif;">Nombre</th>
                                    <th class="px-6 py-4 text-left text-sm font-black" style="font-family: 'Inter', sans-serif;">CURP</th>
                                    <th class="px-6 py-4 text-left text-sm font-black" style="font-family: 'Inter', sans-serif;">Edad</th>
                                    <th class="px-6 py-4 text-left text-sm font-black" style="font-family: 'Inter', sans-serif;">Email</th>
                                    <th class="px-6 py-4 text-center text-sm font-black" style="font-family: 'Inter', sans-serif;">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="pacientes-tbody" class="divide-y divide-gray-200">
                                <tr class="hover:bg-gray-50 transition">
                                    <td class="px-6 py-4 text-gray-900 font-bold" style="font-family: 'Inter', sans-serif;">Cargando...</td>
                                    <td class="px-6 py-4 text-gray-500" style="font-family: 'Inter', sans-serif;">-</td>
                                    <td class="px-6 py-4 text-gray-500" style="font-family: 'Inter', sans-serif;">-</td>
                                    <td class="px-6 py-4 text-gray-500" style="font-family: 'Inter', sans-serif;">-</td>
                                    <td class="px-6 py-4 text-center" style="font-family: 'Inter', sans-serif;">-</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Mi Cuenta (M√©dico) -->
                <div id="mi-cuenta" class="view hidden">
                    <h2 class="text-3xl font-black text-gray-900 mb-6">Mi Cuenta - Perfil M√©dico</h2>
                    
                    <div class="grid grid-cols-3 gap-6">
                        <!-- Columna Izquierda: Datos Personales -->
                        <div class="col-span-1 space-y-4">
                            <!-- Foto de Perfil -->
                            <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                                <div class="flex flex-col items-center">
                                    <img id="med-foto-preview" src="https://via.placeholder.com/150" alt="Foto de perfil" class="w-24 h-24 rounded-full mb-4 object-cover border-4 border-gray-200">
                                    <input type="file" id="med-foto-input" accept="image/*" style="display:none;">
                                    <button onclick="document.getElementById('med-foto-input').click()" class="text-white font-bold px-4 py-2 rounded-lg transition text-sm" style="background-color: #1465ff;">
                                        <i class="fa-solid fa-camera mr-2"></i>Cambiar Foto
                                    </button>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-xl font-black text-gray-900 mb-6">Informaci√≥n Personal</h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Nombre Completo</label>
                                        <input type="text" id="med-nombre" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="Nombre del m√©dico">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">C√©dula Profesional *</label>
                                        <div class="flex gap-2">
                                            <input type="text" id="med-cedula" class="flex-1 border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="1234567">
                                            <button type="button" onclick="validarCedulaMedica()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-bold text-sm transition" title="Validar c√©dula con el SAT">
                                                <i class="fa-solid fa-check-double"></i>
                                            </button>
                                        </div>
                                        <div id="cedula-validation-status" class="text-xs mt-2 hidden"></div>
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">RFC (Registro Federal de Contribuyentes) *</label>
                                        <input type="text" id="med-rfc" maxlength="13" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold uppercase" placeholder="XXXX000000XXX">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Correo Electr√≥nico</label>
                                        <input type="email" id="med-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="doctor@hospital.mx">
                                    </div>
                                    
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Tel√©fono</label>
                                        <input type="tel" id="med-telefono" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="+52 123 456 7890">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Central: Especialidades y Competencias -->
                        <div class="col-span-1 space-y-4">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-xl font-black text-gray-900 mb-6">Especialidades M√©dicas</h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Especialidad Primaria *</label>
                                        <select id="med-especialidad-primaria" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                                            <option value="">Selecciona especialidad...</option>
                                            <option value="medicina-general">Medicina General</option>
                                            <option value="cardiologia">Cardiolog√≠a</option>
                                            <option value="pediatria">Pediatr√≠a</option>
                                            <option value="ginecologia">Ginecolog√≠a</option>
                                            <option value="dermatologia">Dermatolog√≠a</option>
                                            <option value="neurologia">Neurolog√≠a</option>
                                            <option value="oftalmologia">Oftalmolog√≠a</option>
                                            <option value="otorrino">Otorrinolaringolog√≠a</option>
                                            <option value="ortopedia">Ortopedia</option>
                                            <option value="psiquiatria">Psiquiatr√≠a</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Especialidad Secundaria</label>
                                        <select id="med-especialidad-secundaria" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                                            <option value="">Ninguna</option>
                                            <option value="medicina-general">Medicina General</option>
                                            <option value="cardiologia">Cardiolog√≠a</option>
                                            <option value="pediatria">Pediatr√≠a</option>
                                            <option value="ginecologia">Ginecolog√≠a</option>
                                            <option value="dermatologia">Dermatolog√≠a</option>
                                            <option value="neurologia">Neurolog√≠a</option>
                                            <option value="oftalmologia">Oftalmolog√≠a</option>
                                            <option value="otorrino">Otorrinolaringolog√≠a</option>
                                            <option value="ortopedia">Ortopedia</option>
                                            <option value="psiquiatria">Psiquiatr√≠a</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">N√∫mero de C√©dula Especialista</label>
                                        <input type="text" id="med-cedula-especialista" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="1234567">
                                    </div>

                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">A√±os de Experiencia</label>
                                        <input type="number" id="med-anos-experiencia" min="0" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="15">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Derecha: Permisos y Configuraci√≥n -->
                        <div class="col-span-1 space-y-4">
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h3 class="text-xl font-black text-gray-900 mb-6">Permisos y Configuraci√≥n</h3>
                                
                                <div class="space-y-4">
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <h4 class="font-bold text-blue-900 mb-3">Roles</h4>
                                        <label class="flex items-center gap-3 mb-2 cursor-pointer">
                                            <input type="checkbox" id="perm-consulta" checked disabled class="w-5 h-5 text-blue-600 rounded">
                                            <span class="text-sm font-bold text-gray-700">Crear Consultas</span>
                                        </label>
                                        <label class="flex items-center gap-3 mb-2 cursor-pointer">
                                            <input type="checkbox" id="perm-recetas" checked class="w-5 h-5 text-blue-600 rounded">
                                            <span class="text-sm font-bold text-gray-700">Crear Recetas</span>
                                        </label>
                                        <label class="flex items-center gap-3 cursor-pointer">
                                            <input type="checkbox" id="perm-laboratorio" class="w-5 h-5 text-blue-600 rounded">
                                            <span class="text-sm font-bold text-gray-700">Solicitar Laboratorio</span>
                                        </label>
                                    </div>

                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <h4 class="font-bold text-green-900 mb-3">‚è∞ Horarios de Atenci√≥n</h4>
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-xs font-bold text-gray-700 mb-1">Hora de Inicio</label>
                                                <input type="time" id="horario-inicio" class="w-full border border-green-300 rounded px-3 py-2 font-bold" value="08:00">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-bold text-gray-700 mb-1">Hora de Fin</label>
                                                <input type="time" id="horario-fin" class="w-full border border-green-300 rounded px-3 py-2 font-bold" value="17:00">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-bold text-gray-700 mb-2">D√≠as Laborales</label>
                                                <div class="space-y-2">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" class="dias-semana" value="lunes" checked class="w-4 h-4 text-green-600 rounded">
                                                        <span class="text-xs text-gray-700">Lunes</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" class="dias-semana" value="martes" checked class="w-4 h-4 text-green-600 rounded">
                                                        <span class="text-xs text-gray-700">Martes</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" class="dias-semana" value="miercoles" checked class="w-4 h-4 text-green-600 rounded">
                                                        <span class="text-xs text-gray-700">Mi√©rcoles</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" class="dias-semana" value="jueves" checked class="w-4 h-4 text-green-600 rounded">
                                                        <span class="text-xs text-gray-700">Jueves</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" class="dias-semana" value="viernes" checked class="w-4 h-4 text-green-600 rounded">
                                                        <span class="text-xs text-gray-700">Viernes</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="checkbox" class="dias-semana" value="sabado" class="w-4 h-4 text-green-600 rounded">
                                                        <span class="text-xs text-gray-700">S√°bado</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <h4 class="font-bold text-green-900 mb-3">Configuraci√≥n Cl√≠nica</h4>
                                        <label class="flex items-center gap-3 mb-2 cursor-pointer">
                                            <input type="checkbox" id="conf-agenda" checked class="w-5 h-5 text-green-600 rounded">
                                            <span class="text-sm font-bold text-gray-700">Usar Agenda</span>
                                        </label>
                                        <label class="flex items-center gap-3 cursor-pointer">
                                            <input type="checkbox" id="conf-cobros" checked class="w-5 h-5 text-green-600 rounded">
                                            <span class="text-sm font-bold text-gray-700">Registrar Cobros</span>
                                        </label>
                                    </div>

                                    <button onclick="guardarPerfil()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition mt-4">
                                        <i class="fa-solid fa-save mr-2"></i> Guardar Cambios
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Nueva Consulta (M√©dico) - CON TABS -->
                <div id="nueva-consulta" class="view hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-4xl font-black">Nueva Consulta</h2>
                                <p id="consulta-paciente-nombre" class="text-blue-100 mt-2">Selecciona un paciente</p>
                            </div>
                            <button onclick="switchView('mis-pacientes')" class="bg-white text-blue-600 font-bold px-6 py-3 rounded-lg hover:bg-blue-50 transition">
                                <i class="fa-solid fa-arrow-left mr-2"></i> Volver
                            </button>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <!-- Buscador Inteligente de Pacientes -->
                        <div class="border-b border-gray-200 p-6">
                            <label class="block text-sm font-bold text-gray-700 mb-3">Seleccionar Paciente</label>
                            <div class="relative">
                                <input type="text" id="buscar-paciente-consulta" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="Escribe nombre, apellido, email o CURP..." oninput="buscarPacienteConsulta()">
                                <div id="resultados-pacientes-consulta" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden z-50">
                                    <!-- Resultados dinamicos -->
                                </div>
                            </div>
                            <div id="paciente-seleccionado-info" class="mt-3 text-sm text-gray-600 hidden">
                                <span class="font-bold">Paciente seleccionado:</span>
                                <span id="paciente-seleccionado-texto" class="text-blue-600"></span>
                            </div>
                            <input type="hidden" id="select-paciente-consulta" value="">
                        </div>

                        <!-- Tabs Navigation -->
                        <div class="flex border-b border-gray-200 overflow-x-auto">
                            <button onclick="cambiarTab('historial')" class="tab-btn active px-6 py-4 font-bold text-sm whitespace-nowrap border-b-2 border-blue-600 text-blue-600">
                                <i class="fa-solid fa-history mr-2"></i> Historial
                            </button>
                            <button onclick="cambiarTab('notas')" class="tab-btn px-6 py-4 font-bold text-sm whitespace-nowrap border-b-2 border-transparent text-gray-600 hover:text-gray-900">
                                <i class="fa-solid fa-pen mr-2"></i> Notas
                            </button>
                            <button onclick="cambiarTab('exploracion')" class="tab-btn px-6 py-4 font-bold text-sm whitespace-nowrap border-b-2 border-transparent text-gray-600 hover:text-gray-900">
                                <i class="fa-solid fa-body mr-2"></i> Exploraci√≥n
                            </button>
                            <button onclick="cambiarTab('odontograma')" class="tab-btn px-6 py-4 font-bold text-sm whitespace-nowrap border-b-2 border-transparent text-gray-600 hover:text-gray-900">
                                <i class="fa-solid fa-tooth mr-2"></i> Odontograma
                            </button>
                            <button onclick="cambiarTab('examen')" class="tab-btn px-6 py-4 font-bold text-sm whitespace-nowrap border-b-2 border-transparent text-gray-600 hover:text-gray-900">
                                <i class="fa-solid fa-stethoscope mr-2"></i> Examen
                            </button>
                            <button onclick="cambiarTab('diagnostico')" class="tab-btn px-6 py-4 font-bold text-sm whitespace-nowrap border-b-2 border-transparent text-gray-600 hover:text-gray-900">
                                <i class="fa-solid fa-file-medical mr-2"></i> Diagn√≥stico
                            </button>
                            <button onclick="cambiarTab('cargos')" class="tab-btn px-6 py-4 font-bold text-sm whitespace-nowrap border-b-2 border-transparent text-gray-600 hover:text-gray-900">
                                <i class="fa-solid fa-receipt mr-2"></i> Cargos
                            </button>
                        </div>

                        <!-- Contenido de Tabs -->
                        <div class="p-6">
                            <!-- TAB: Historial -->
                            <div id="tab-historial" class="tab-content">
                                <h3 class="text-xl font-black text-gray-900 mb-4">Historial de Consultas</h3>
                                <div id="historial-consultas" class="space-y-3">
                                    <p class="text-gray-500 text-sm italic">Cargando historial...</p>
                                </div>
                            </div>

                            <!-- TAB: Notas de Padecimiento -->
                            <div id="tab-notas" class="tab-content hidden">
                                <h3 class="text-xl font-black text-gray-900 mb-4">Notas de Padecimiento Actual</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Motivo de Consulta</label>
                                        <input type="text" id="motivo-consulta" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Ej: Dolor de cabeza, fiebre...">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Notas Cl√≠nicas</label>
                                        <textarea id="notas-clinicas" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none h-32" placeholder="Descripci√≥n detallada del padecimiento..."></textarea>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <p class="text-xs text-gray-600 font-bold">üí° Sugerencia: Usa formato claro y estructurado</p>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: Exploraci√≥n Topogr√°fica Din√°mica -->
                            <div id="tab-exploracion" class="tab-content hidden">
                                <h3 class="text-xl font-black text-gray-900 mb-6">Exploraci√≥n Topogr√°fica Din√°mica</h3>
                                
                                <div class="grid grid-cols-12 gap-6">
                                    <!-- Panel de controles (izquierda) -->
                                    <div class="col-span-4 space-y-4">
                                        <!-- Selector de color -->
                                        <div>
                                            <label class="block text-sm font-bold text-gray-700 mb-2">Color del hallazgo</label>
                                            <div class="flex gap-2 flex-wrap">
                                                <button type="button" onclick="setTopographicColor('red')" class="w-10 h-10 rounded-lg bg-red-500 hover:ring-2 hover:ring-offset-2 hover:ring-red-500 transition" title="Lesi√≥n/Inflamaci√≥n"></button>
                                                <button type="button" onclick="setTopographicColor('yellow')" class="w-10 h-10 rounded-lg bg-yellow-400 hover:ring-2 hover:ring-offset-2 hover:ring-yellow-400 transition" title="Edema/Inflamaci√≥n leve"></button>
                                                <button type="button" onclick="setTopographicColor('blue')" class="w-10 h-10 rounded-lg bg-blue-500 hover:ring-2 hover:ring-offset-2 hover:ring-blue-500 transition" title="Equimosis/Hematoma"></button>
                                                <button type="button" onclick="setTopographicColor('green')" class="w-10 h-10 rounded-lg bg-green-500 hover:ring-2 hover:ring-offset-2 hover:ring-green-500 transition" title="Normal/Cicatriz"></button>
                                                <button type="button" onclick="setTopographicColor('purple')" class="w-10 h-10 rounded-lg bg-purple-500 hover:ring-2 hover:ring-offset-2 hover:ring-purple-500 transition" title="Otro"></button>
                                            </div>
                                            <p class="text-xs text-gray-500 mt-2">Color seleccionado: <span id="color-seleccionado" class="font-bold">Ninguno</span></p>
                                        </div>

                                        <!-- Descripci√≥n del hallazgo -->
                                        <div>
                                            <label class="block text-sm font-bold text-gray-700 mb-2">Descripci√≥n</label>
                                            <textarea id="topographic-description" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none h-20 text-sm" placeholder="Describe el hallazgo encontrado..."></textarea>
                                        </div>

                                        <!-- Botones de acci√≥n -->
                                        <div class="space-y-2">
                                            <button type="button" onclick="agregarHallazgoTopografico()" class="w-full text-white font-bold px-4 py-2 rounded-lg transition text-sm" style="background-color: #1465ff;">
                                                <i class="fa-solid fa-plus mr-2"></i> Agregar Hallazgo
                                            </button>
                                            <button type="button" onclick="limpiarTopografico()" class="w-full border border-gray-300 text-gray-700 font-bold px-4 py-2 rounded-lg hover:bg-gray-50 transition text-sm">
                                                <i class="fa-solid fa-eraser mr-2"></i> Limpiar
                                            </button>
                                            <button type="button" onclick="exportarExplotacionPDF()" class="w-full border border-gray-300 text-gray-700 font-bold px-4 py-2 rounded-lg hover:bg-gray-50 transition text-sm">
                                                <i class="fa-solid fa-file-pdf mr-2"></i> Exportar PDF
                                            </button>
                                        </div>

                                        <!-- Lista de hallazgos agregados -->
                                        <div>
                                            <label class="block text-sm font-bold text-gray-700 mb-2">Hallazgos Registrados</label>
                                            <div id="hallazgos-list" class="space-y-2 max-h-64 overflow-y-auto border border-gray-200 rounded-lg p-3">
                                                <p class="text-xs text-gray-400 italic">Sin hallazgos a√∫n</p>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Panel visual (figuras del cuerpo) -->
                                    <div class="col-span-8 space-y-4">
                                        <!-- Botones vista frontal/dorsal -->
                                        <div class="flex gap-2">
                                            <button type="button" onclick="cambiarVistaCuerpo('frontal')" class="flex-1 px-4 py-2 rounded-lg font-bold text-sm transition" id="btn-vista-frontal" style="background-color: #1465ff; color: white;">
                                                <i class="fa-solid fa-user mr-2"></i> Vista Frontal
                                            </button>
                                            <button type="button" onclick="cambiarVistaCuerpo('dorsal')" class="flex-1 px-4 py-2 rounded-lg font-bold text-sm border border-gray-300 text-gray-700 hover:bg-gray-50 transition" id="btn-vista-dorsal">
                                                <i class="fa-solid fa-rotate mr-2"></i> Vista Dorsal
                                            </button>
                                        </div>

                                        <!-- Figuras del cuerpo (SVG interactivo) -->
                                        <div class="flex justify-center items-center bg-gray-50 rounded-lg p-6 border border-gray-200 min-h-96">
                                            <svg id="svg-cuerpo-frontal" viewBox="0 0 200 500" class="w-48 h-full" style="max-height: 500px;">
                                                <!-- Cabeza -->
                                                <circle id="zona-head" cx="100" cy="50" r="25" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Cuello -->
                                                <rect id="zona-neck" x="90" y="75" width="20" height="20" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- T√≥rax -->
                                                <ellipse id="zona-chest" cx="100" cy="130" rx="35" ry="50" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Abdomen -->
                                                <rect id="zona-abdomen" x="75" y="185" width="50" height="60" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Brazo izquierdo -->
                                                <rect id="zona-left-arm" x="30" y="100" width="35" height="90" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Brazo derecho -->
                                                <rect id="zona-right-arm" x="135" y="100" width="35" height="90" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Pierna izquierda -->
                                                <rect id="zona-left-leg" x="70" y="260" width="20" height="120" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Pierna derecha -->
                                                <rect id="zona-right-leg" x="110" y="260" width="20" height="120" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Texto de instrucci√≥n -->
                                                <text x="100" y="20" text-anchor="middle" font-size="12" fill="#999">Haz clic en zonas para marcar</text>
                                            </svg>
                                            <svg id="svg-cuerpo-dorsal" viewBox="0 0 200 500" class="w-48 h-full hidden" style="max-height: 500px;">
                                                <!-- Cabeza (dorsal) -->
                                                <circle id="zona-head-back" cx="100" cy="50" r="25" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Cuello (dorsal) -->
                                                <rect id="zona-neck-back" x="90" y="75" width="20" height="20" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Espalda -->
                                                <ellipse id="zona-back" cx="100" cy="130" rx="35" ry="50" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Gl√∫teos -->
                                                <rect id="zona-buttocks" x="75" y="185" width="50" height="40" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Brazo izquierdo (dorsal) -->
                                                <rect id="zona-left-arm-back" x="30" y="100" width="35" height="90" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Brazo derecho (dorsal) -->
                                                <rect id="zona-right-arm-back" x="135" y="100" width="35" height="90" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Pierna izquierda (dorsal) -->
                                                <rect id="zona-left-leg-back" x="70" y="260" width="20" height="120" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Pierna derecha (dorsal) -->
                                                <rect id="zona-right-leg-back" x="110" y="260" width="20" height="120" fill="none" stroke="#999" stroke-width="2" style="cursor: pointer;"/>
                                                <!-- Texto de instrucci√≥n -->
                                                <text x="100" y="20" text-anchor="middle" font-size="12" fill="#999">Haz clic en zonas para marcar</text>
                                            </svg>
                                        </div>

                                        <!-- Leyenda de colores -->
                                        <div class="grid grid-cols-5 gap-2 text-xs">
                                            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-red-500 rounded"></div><span>Lesi√≥n</span></div>
                                            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-yellow-400 rounded"></div><span>Edema</span></div>
                                            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-blue-500 rounded"></div><span>Equimosis</span></div>
                                            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-green-500 rounded"></div><span>Normal</span></div>
                                            <div class="flex items-center gap-2"><div class="w-4 h-4 bg-purple-500 rounded"></div><span>Otro</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: Odontograma Profesional con Caras Dentales -->
                            <div id="tab-odontograma" class="tab-content hidden">
                                <h3 class="text-xl font-black text-gray-900 mb-6">Odontograma Profesional</h3>
                                
                                <div class="space-y-6">
                                    <!-- Panel de controles superior -->
                                    <div class="grid grid-cols-4 gap-4">
                                        <!-- Tipo de dentici√≥n -->
                                        <div>
                                            <label class="block text-xs font-bold text-gray-700 mb-2">Tipo</label>
                                            <div class="space-y-1">
                                                <label class="flex items-center gap-2 text-xs cursor-pointer">
                                                    <input type="radio" name="tipo-denticion" value="adulto" checked onchange="cambiarTipoDenticion('adulto')"> Adulto
                                                </label>
                                                <label class="flex items-center gap-2 text-xs cursor-pointer">
                                                    <input type="radio" name="tipo-denticion" value="infantil" onchange="cambiarTipoDenticion('infantil')"> Infantil
                                                </label>
                                            </div>
                                        </div>

                                        <!-- Selector de cara dental -->
                                        <div>
                                            <label class="block text-xs font-bold text-gray-700 mb-2">Cara Seleccionada</label>
                                            <p class="text-xs text-gray-600 px-2 py-1 bg-gray-100 rounded" id="cara-seleccionada">Ninguna</p>
                                        </div>

                                        <!-- Pieza seleccionada -->
                                        <div>
                                            <label class="block text-xs font-bold text-gray-700 mb-2">Pieza Seleccionada</label>
                                            <p class="text-xs text-gray-600 px-2 py-1 bg-gray-100 rounded" id="pieza-seleccionada">Ninguna</p>
                                        </div>

                                        <!-- Botones de acci√≥n r√°pida -->
                                        <div class="flex flex-col gap-1">
                                            <button type="button" onclick="limpiarOdontograma()" class="text-xs px-2 py-1 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition">
                                                <i class="fa-solid fa-eraser mr-1"></i> Limpiar
                                            </button>
                                            <button type="button" onclick="exportarOdontogramaPDF()" class="text-xs px-2 py-1 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 transition">
                                                <i class="fa-solid fa-file-pdf mr-1"></i> PDF
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Odontograma visual -->
                                    <div class="bg-gray-50 rounded-lg p-6 border border-gray-200 overflow-x-auto">
                                        <div id="odontograma-container" class="flex flex-col gap-8 min-w-max">
                                            <!-- Arcada Superior -->
                                            <div>
                                                <h4 class="text-xs font-bold text-gray-700 mb-2 text-center uppercase">Arcada Superior</h4>
                                                <div class="flex justify-center gap-1" id="arcada-superior">
                                                    <!-- Se genera din√°micamente -->
                                                </div>
                                            </div>

                                            <!-- L√≠nea separadora -->
                                            <div class="flex justify-center">
                                                <div class="w-full h-px bg-gray-400"></div>
                                            </div>

                                            <!-- Arcada Inferior -->
                                            <div>
                                                <h4 class="text-xs font-bold text-gray-700 mb-2 text-center uppercase">Arcada Inferior</h4>
                                                <div class="flex justify-center gap-1" id="arcada-inferior">
                                                    <!-- Se genera din√°micamente -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Procedimientos -->
                                    <div class="grid grid-cols-2 gap-4">
                                        <!-- Diagn√≥stico y Procedimiento -->
                                        <div>
                                            <label class="block text-xs font-bold text-gray-700 mb-2">Diagn√≥stico</label>
                                            <input type="text" id="diagnostico-proc" class="w-full border border-gray-300 rounded px-3 py-2 text-xs" placeholder="Ej: Caries">
                                        </div>

                                        <div>
                                            <label class="block text-xs font-bold text-gray-700 mb-2">Procedimiento</label>
                                            <select id="procedimiento-select" class="w-full border border-gray-300 rounded px-3 py-2 text-xs focus:ring-2 focus:ring-blue-500 outline-none">
                                                <option value="">Selecciona procedimiento...</option>
                                                <option value="Profil√°ctico">Profil√°ctico</option>
                                                <option value="Restauraci√≥n con Resina">Restauraci√≥n con Resina</option>
                                                <option value="Restauraci√≥n con Amalgama">Restauraci√≥n con Amalgama</option>
                                                <option value="Sellador">Sellador</option>
                                                <option value="Extracci√≥n">Extracci√≥n</option>
                                                <option value="Curetaje">Curetaje</option>
                                                <option value="Alargamiento de Corona">Alargamiento de Corona</option>
                                                <option value="Recubrimiento Gingival">Recubrimiento Gingival</option>
                                                <option value="Coronas/Puentes">Coronas/Puentes</option>
                                                <option value="Implante">Implante</option>
                                                <option value="Endodoncia">Endodoncia</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Bot√≥n para agregar procedimiento -->
                                    <button type="button" onclick="agregarProcedimientoDental()" class="w-full text-white font-bold px-4 py-2 rounded-lg transition text-sm" style="background-color: #1465ff;">
                                        <i class="fa-solid fa-plus mr-2"></i> Agregar Procedimiento
                                    </button>

                                    <!-- Tabla de procedimientos -->
                                    <div>
                                        <h4 class="text-sm font-bold text-gray-900 mb-3">Procedimientos Registrados</h4>
                                        <div class="overflow-x-auto border border-gray-200 rounded-lg">
                                            <table class="w-full text-xs">
                                                <thead class="bg-gray-100 border-b border-gray-200">
                                                    <tr>
                                                        <th class="px-3 py-2 text-left font-bold text-gray-700">Diagn√≥stico</th>
                                                        <th class="px-3 py-2 text-left font-bold text-gray-700">Procedimiento</th>
                                                        <th class="px-3 py-2 text-center font-bold text-gray-700">Pieza</th>
                                                        <th class="px-3 py-2 text-center font-bold text-gray-700">Cara</th>
                                                        <th class="px-3 py-2 text-center font-bold text-gray-700 w-16">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="procedimientos-tbody">
                                                    <tr>
                                                        <td colspan="5" class="px-3 py-4 text-center text-gray-500">Sin procedimientos registrados</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- Leyenda -->
                                    <div class="text-xs text-gray-600 p-3 bg-gray-50 rounded border border-gray-200">
                                        <p class="font-bold mb-2">Caras Dentales:</p>
                                        <div class="grid grid-cols-3 gap-2">
                                            <p><strong>V:</strong> Vestibular (frente)</p>
                                            <p><strong>O:</strong> Oclusal (masticatoria)</p>
                                            <p><strong>L:</strong> Lingual/Palatina (lengua)</p>
                                            <p><strong>M:</strong> Mesial (hacia la l√≠nea media)</p>
                                            <p><strong>D:</strong> Distal (lejos de la l√≠nea media)</p>
                                        </div>
                                    </div>

                                    <!-- Diagn√≥stico General -->
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Diagn√≥stico General</label>
                                        <textarea id="diagnostico-dental" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none h-20 text-sm" placeholder="Resumen de hallazgos odontol√≥gicos..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- TAB: Examen F√≠sico -->
                            <div id="tab-examen" class="tab-content hidden">
                                <h3 class="text-xl font-black text-gray-900 mb-4">Examen F√≠sico Completo</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-1">Frecuencia Card√≠aca</label>
                                        <input type="number" id="fc" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="bpm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-1">Frecuencia Respiratoria</label>
                                        <input type="number" id="fr" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="r/min">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-1">Saturaci√≥n O2</label>
                                        <input type="number" id="spo2" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="%">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-gray-700 mb-1">Ox√≠geno Suplementario</label>
                                        <input type="text" id="o2-suplementario" class="w-full border border-gray-300 rounded px-3 py-2 text-sm" placeholder="No / S√≠ (especificar)">
                                    </div>
                                </div>
                                <div class="mt-4">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Resumen del Examen</label>
                                    <textarea id="resumen-examen" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none h-24" placeholder="Resumen de hallazgos..."></textarea>
                                </div>
                            </div>

                            <!-- TAB: Diagn√≥stico y Tratamiento -->
                            <div id="tab-diagnostico" class="tab-content hidden">
                                <h3 class="text-xl font-black text-gray-900 mb-4">Diagn√≥stico y Plan de Tratamiento</h3>
                                <form id="diagnostico-form" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Diagn√≥stico Principal (CIE-10)</label>
                                        <div class="relative">
                                            <input type="text" id="diagnostico-principal" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Escribe c√≥digo o descripci√≥n..." autocomplete="off">
                                            <div id="cie10-dropdown-consulta" class="hidden absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg mt-1 shadow-lg max-h-64 overflow-y-auto z-10"></div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-2">Plan de Tratamiento</label>
                                        <textarea id="plan-tratamiento" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none h-24" placeholder="Describe el plan terap√©utico..."></textarea>
                                    </div>
                                </form>
                            </div>

                            <!-- TAB: Cargos -->
                            <div id="tab-cargos" class="tab-content hidden">
                                <h3 class="text-xl font-black text-gray-900 mb-4">Cargos de la Consulta</h3>
                                <div class="space-y-4">
                                    <div class="bg-blue-50 p-4 rounded-lg">
                                        <p class="text-sm font-bold text-gray-800">Busca servicios para agregar cargos</p>
                                    </div>
                                    <div class="relative">
                                        <input type="text" id="buscar-cargo" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Buscar servicio por nombre o c√≥digo..." oninput="buscarServiciosCargo()">
                                        <div id="servicios-disponibles" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden z-50">
                                            <!-- Resultados dinamicos -->
                                        </div>
                                    </div>
                                    <div id="cargos-lista" class="space-y-2 border rounded-lg p-4 bg-gray-50 max-h-48 overflow-y-auto">
                                        <p class="text-gray-500 text-sm italic">Sin cargos agregados</p>
                                    </div>
                                    <div class="border-t pt-4">
                                        <div class="flex justify-between items-center text-lg font-bold">
                                            <span>Total:</span>
                                            <span id="total-cargos" class="text-blue-600">$0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Botones de Acci√≥n -->
                        <div class="border-t border-gray-200 p-6 flex gap-3 justify-end">
                            <button onclick="switchView('mis-pacientes')" class="px-6 py-3 border border-gray-300 rounded-lg font-bold hover:bg-gray-50 transition">
                                Cancelar
                            </button>
                            <button onclick="guardarConsultaCompleta()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition">
                                <i class="fa-solid fa-save mr-2"></i> Guardar Consulta Completa
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Agenda Operativa Profesional (M√©dico) -->
                <div id="agenda-operativa" class="view hidden">
                    <!-- Header Profesional - STICKY -->
                    <div class="sticky top-0 z-40 bg-white rounded-xl shadow-lg p-4 mb-6" style="border-bottom: 2px solid #1465ff;">
                        <div class="flex justify-between items-center gap-6">
                            <!-- Selector de M√©dicos (izquierda) -->
                            <div class="flex-1">
                                <label class="text-xs font-bold text-gray-600 uppercase mb-2 block">M√©dico</label>
                                <div id="medicos-selector-grid" class="flex gap-2 flex-wrap">
                                    <!-- Se rellena din√°micamente con doctores -->
                                </div>
                            </div>

                            <!-- Controles de Vista (centro) -->
                            <div class="flex gap-1 border border-gray-300 rounded-lg p-1 bg-gray-50">
                                <button onclick="cambiarVistaAgenda('hoy')" class="px-3 py-1 rounded text-xs font-bold transition" id="btn-hoy" style="background-color: #1465ff; color: white;">HOY</button>
                                <button onclick="cambiarVistaAgenda('dia')" class="px-3 py-1 rounded text-xs font-bold transition hover:bg-gray-100" id="btn-dia">D√çA</button>
                                <button onclick="cambiarVistaAgenda('semana')" class="px-3 py-1 rounded text-xs font-bold transition hover:bg-gray-100" id="btn-semana">SEMANA</button>
                                <button onclick="cambiarVistaAgenda('mes')" class="px-3 py-1 rounded text-xs font-bold transition hover:bg-gray-100" id="btn-mes">MES</button>
                            </div>

                            <!-- Per√≠odo (centro-derecha) -->
                            <div class="text-center">
                                <p class="text-xs text-gray-600 font-bold uppercase">Per√≠odo</p>
                                <p class="text-sm font-black text-gray-900" id="rango-fechas">16 FEB - 22 FEB 2026</p>
                            </div>

                            <!-- Navegaci√≥n (derecha) -->
                            <div class="flex gap-2">
                                <button onclick="navegarAgenda(-1)" class="p-2 hover:bg-gray-100 rounded transition border border-gray-300" title="Semana anterior">
                                    <i class="fa-solid fa-chevron-left text-sm text-gray-700"></i>
                                </button>
                                <button onclick="navegarAgenda(0)" class="p-2 hover:bg-gray-100 rounded transition border border-gray-300" title="Hoy">
                                    <i class="fa-solid fa-calendar text-sm text-gray-700"></i>
                                </button>
                                <button onclick="navegarAgenda(1)" class="p-2 hover:bg-gray-100 rounded transition border border-gray-300" title="Semana siguiente">
                                    <i class="fa-solid fa-chevron-right text-sm text-gray-700"></i>
                                </button>
                            </div>

                            <!-- Botones de acci√≥n (derecha) -->
                            <div class="flex gap-2">
                                <button onclick="abrirModalNuevaCita()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded transition flex items-center gap-2 text-sm">
                                    <i class="fa-solid fa-plus"></i> NUEVA CITA
                                </button>
                                <button onclick="abrirConfiguracionAgenda()" class="p-2 hover:bg-gray-100 rounded transition border border-gray-300">
                                    <i class="fa-solid fa-cog text-sm text-gray-700"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Grid principal: Calendario + Sidebar -->
                    <div class="grid grid-cols-4 gap-6">
                        <!-- Calendario Semanal (3 columnas) -->
                        <div class="col-span-3">
                            <!-- Vista Calendario -->
                            <div id="agenda-calendario-container" class="bg-white rounded-xl shadow-lg overflow-hidden">
                                <!-- Se rellena din√°micamente -->
                            </div>
                        </div>

                        <!-- Sidebar Derecho (1 columna) -->
                        <div class="space-y-6">
                            <!-- Mini Calendario -->
                            <div class="bg-white rounded-xl shadow-lg p-4">
                                <div id="mini-calendario" class="space-y-4">
                                    <!-- Se rellena din√°micamente -->
                                </div>
                            </div>

                            <!-- Recordatorios Programados -->
                            <div class="bg-white rounded-xl shadow-lg p-4">
                                <h3 class="font-black text-gray-900 mb-4 flex items-center gap-2 text-sm">
                                    <i class="fa-solid fa-bell text-blue-600"></i> RECORDATORIOS PROGRAMADOS
                                </h3>
                                <div id="recordatorios-agenda" class="space-y-3 max-h-64 overflow-y-auto">
                                    <p class="text-xs text-gray-500 italic">Sin recordatorios</p>
                                </div>
                            </div>

                            <!-- Citas Pendientes -->
                            <div class="bg-white rounded-xl shadow-lg p-4">
                                <h3 class="font-black text-gray-900 mb-4 flex items-center gap-2 text-sm">
                                    <i class="fa-solid fa-hourglass-end text-orange-600"></i> CITAS PENDIENTES
                                </h3>
                                <div id="citas-pendientes-agenda" class="space-y-2 text-xs">
                                    <p class="text-gray-500 italic">Sin citas pendientes</p>
                                </div>
                            </div>

                            <!-- Enlaces Portales -->
                            <div class="bg-white rounded-xl shadow-lg p-4">
                                <h3 class="font-black text-gray-900 mb-4">Links de Portales</h3>
                                <div class="space-y-2">
                                    <button onclick="abrirLinkPortal('personal')" class="w-full text-left px-3 py-2 rounded-lg border border-blue-300 text-blue-600 hover:bg-blue-50 transition text-sm font-bold flex items-center gap-2">
                                        <i class="fa-solid fa-check text-blue-600"></i> Portal personal
                                    </button>
                                </div>
                                <button onclick="copiarLinkPortal()" class="w-full mt-3 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition text-sm">
                                    <i class="fa-solid fa-copy mr-2"></i> Copiar
                                </button>
                            </div>

                            <!-- Acciones Adicionales -->
                            <div class="bg-white rounded-xl shadow-lg p-4">
                                <button onclick="imprimirAgenda()" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 rounded-lg transition text-sm flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-print"></i> Imprimir Agenda
                                </button>
                                <button onclick="exportarAgendaCSV()" class="w-full mt-2 bg-gray-100 hover:bg-gray-200 text-gray-800 font-bold py-2 rounded-lg transition text-sm flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-download"></i> Descargar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cat√°logo de Servicios/Productos (M√©dico) -->
                <div id="productos" class="view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black text-gray-900">Cat√°logo de Servicios M√©dicos</h2>
                        <button onclick="abrirModalNuevoProducto()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-6 py-3 rounded-lg transition flex items-center gap-2 shadow-lg">
                            <i class="fa-solid fa-plus mr-2"></i> Nuevo Servicio
                        </button>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-black">C√≥digo</th>
                                    <th class="px-6 py-4 text-left text-sm font-black">Servicio/Producto</th>
                                    <th class="px-6 py-4 text-left text-sm font-black">Categor√≠a</th>
                                    <th class="px-6 py-4 text-right text-sm font-black">Precio</th>
                                    <th class="px-6 py-4 text-center text-sm font-black">Estado</th>
                                    <th class="px-6 py-4 text-center text-sm font-black">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productos-tbody" class="divide-y divide-gray-200">
                                <tr class="hover:bg-gray-50 transition">
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">Cargando servicios...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Sistema de Cobros (M√©dico) -->
                <div id="cobros" class="view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black text-gray-900">Sistema de Cobros</h2>
                        <button onclick="abrirModalNuevoCobro()" class="bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-3 rounded-lg transition flex items-center gap-2 shadow-lg">
                            <i class="fa-solid fa-receipt mr-2"></i> Nuevo Cobro
                        </button>
                    </div>

                    <div class="grid grid-cols-4 gap-4 mb-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <p class="text-sm text-gray-600 font-bold">Total Cobrado (Hoy)</p>
                            <p class="text-3xl font-black text-green-600" id="total-hoy">$0.00</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <p class="text-sm text-gray-600 font-bold">Total Cobrado (Mes)</p>
                            <p class="text-3xl font-black text-blue-600" id="total-mes">$0.00</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <p class="text-sm text-gray-600 font-bold">Pendiente de Cobro</p>
                            <p class="text-3xl font-black text-orange-600" id="total-pendiente">$0.00</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <p class="text-sm text-gray-600 font-bold">Transacciones</p>
                            <p class="text-3xl font-black text-gray-900" id="total-transacciones">0</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <table class="w-full">
                            <thead class="bg-gradient-to-r from-green-600 to-emerald-600 text-white">
                                <tr>
                                    <th class="px-6 py-4 text-left text-sm font-black">Paciente</th>
                                    <th class="px-6 py-4 text-left text-sm font-black">Servicio</th>
                                    <th class="px-6 py-4 text-right text-sm font-black">Monto</th>
                                    <th class="px-6 py-4 text-center text-sm font-black">Estado</th>
                                    <th class="px-6 py-4 text-center text-sm font-black">Fecha</th>
                                    <th class="px-6 py-4 text-center text-sm font-black">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cobros-tbody" class="divide-y divide-gray-200">
                                <tr class="hover:bg-gray-50 transition">
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">Cargando cobros...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Recetas Electr√≥nicas (M√©dico) -->
                <div id="recetas" class="view hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-black text-gray-900">Recetas Electr√≥nicas</h2>
                        <div class="flex gap-2">
                            <button onclick="exportarRecetaPDF()" class="bg-red-600 hover:bg-red-700 text-white font-bold px-4 py-2 rounded-lg transition" title="Exportar a PDF">
                                <i class="fa-solid fa-file-pdf mr-2"></i> PDF
                            </button>
                            <button onclick="compartirReceta('email')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-lg transition" title="Enviar por email">
                                <i class="fa-solid fa-paper-plane mr-2"></i> Enviar
                            </button>
                            <button onclick="abrirPlantillas()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 py-2 rounded-lg transition" title="Gestionar plantillas">
                                <i class="fa-solid fa-cog mr-2"></i> Plantillas
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-6">
                        <!-- Columna Izquierda: Formulario -->
                        <div class="col-span-2">
                            <div class="bg-white rounded-xl shadow-lg p-8 space-y-6">
                                <!-- Informaci√≥n del Paciente -->
                                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Paciente</label>
                                    <div class="relative">
                                        <input type="text" id="buscar-paciente-receta" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="Escribe nombre, apellido, email o CURP..." oninput="buscarPacienteReceta()">
                                        <div id="resultados-pacientes-receta" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden z-50">
                                            <!-- Resultados din√°micos -->
                                        </div>
                                    </div>
                                    <div id="paciente-receta-info" class="mt-3 text-sm text-gray-600 hidden">
                                        <span class="font-bold">Paciente seleccionado:</span>
                                        <span id="paciente-receta-texto" class="text-blue-600"></span>
                                    </div>
                                    <input type="hidden" id="receta-paciente" value="">
                                </div>

                                <!-- B√∫squeda de Medicamentos -->
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Buscar Medicamento</label>
                                    <div class="relative">
                                        <input type="text" id="buscar-medicamento" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Escribe nombre del medicamento...">
                                        <div id="medicamentos-dropdown" class="hidden absolute bg-white border border-gray-300 rounded-lg mt-1 shadow-xl max-h-64 overflow-y-auto w-full z-20">
                                            <!-- Resultados din√°micos -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Tabla de Medicamentos -->
                                <div>
                                    <div class="flex justify-between items-center mb-3">
                                        <label class="block text-sm font-bold text-gray-700">Medicamentos Prescritos</label>
                                        <span class="text-xs bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold" id="contador-medicamentos">0 medicamentos</span>
                                    </div>
                                    <div class="border rounded-lg overflow-hidden">
                                        <table class="w-full text-sm">
                                            <thead class="bg-gradient-to-r from-blue-600 to-blue-500 text-white">
                                                <tr>
                                                    <th class="px-4 py-3 text-left font-bold">Medicamento</th>
                                                    <th class="px-4 py-3 text-left font-bold">Dosis</th>
                                                    <th class="px-4 py-3 text-left font-bold">Frecuencia</th>
                                                    <th class="px-4 py-3 text-left font-bold">Duraci√≥n</th>
                                                    <th class="px-4 py-3 text-center font-bold">Acciones</th>
                                                </tr>
                                            </thead>
                                            <tbody id="medicamentos-tabla" class="divide-y bg-white">
                                                <tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 italic">Sin medicamentos agregados</td></tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Instrucciones M√©dicas -->
                                <div>
                                    <div class="flex justify-between items-center mb-3">
                                        <label class="block text-sm font-bold text-gray-700">Instrucciones M√©dicas</label>
                                        <button type="button" onclick="guardarComoPlantilla()" class="text-blue-600 hover:text-blue-700 text-xs font-bold">
                                            <i class="fa-solid fa-bookmark mr-1"></i> GUARDAR COMO PLANTILLA
                                        </button>
                                    </div>
                                    <div class="border border-gray-300 rounded-lg overflow-hidden">
                                        <div class="bg-gray-100 border-b border-gray-300 p-3 flex gap-2 flex-wrap">
                                            <button type="button" onclick="formatoTexto('bold')" class="bg-white px-3 py-1 rounded border border-gray-300 font-bold hover:bg-gray-50"><strong>H</strong></button>
                                            <button type="button" onclick="formatoTexto('italic')" class="bg-white px-3 py-1 rounded border border-gray-300 italic hover:bg-gray-50"><i>I</i></button>
                                            <button type="button" onclick="formatoTexto('underline')" class="bg-white px-3 py-1 rounded border border-gray-300 underline hover:bg-gray-50"><u>U</u></button>
                                            <div class="border-l border-gray-300"></div>
                                            <button type="button" onclick="formatoTexto('insertUnorderedList')" class="bg-white px-3 py-1 rounded border border-gray-300 hover:bg-gray-50"><i class="fa-solid fa-list"></i></button>
                                            <button type="button" onclick="formatoTexto('insertOrderedList')" class="bg-white px-3 py-1 rounded border border-gray-300 hover:bg-gray-50"><i class="fa-solid fa-list-ol"></i></button>
                                            <button type="button" onclick="formatoTexto('createLink')" class="bg-white px-3 py-1 rounded border border-gray-300 hover:bg-gray-50"><i class="fa-solid fa-link"></i></button>
                                        </div>
                                        <div id="instrucciones" contenteditable="true" class="w-full border-none px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none min-h-32 bg-white text-gray-700" placeholder="Empieza a escribir..."></div>
                                    </div>
                                    
                                    <!-- Secci√≥n Firma Digital -->
                                    <div class="border-t pt-4 mt-4">
                                        <h4 class="text-sm font-bold text-gray-700 mb-3">Firma Digital (e.firma SAT)</h4>
                                        <div id="firma-digital-container" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center bg-gray-50 cursor-pointer hover:bg-gray-100 transition" onclick="document.getElementById('firma-input').click()">
                                            <i class="fa-solid fa-pen-fancy text-blue-600 text-3xl mb-2"></i>
                                            <p class="text-sm text-gray-700 font-bold">Haz clic para firmar digitalmente</p>
                                            <p class="text-xs text-gray-500 mt-1">O carga un archivo .p12 (certificado SAT)</p>
                                        </div>
                                        <input type="file" id="firma-input" accept=".p12,.pfx" style="display: none;" onchange="cargarFirmaDigital()">
                                        <div id="firma-status" class="mt-2 text-xs hidden"></div>
                                    </div>
                                </div>

                                <!-- Botones de Acci√≥n -->
                                <div class="flex gap-3 pt-4 border-t">
                                    <button type="button" onclick="guardarReceta()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">
                                        <i class="fa-solid fa-save mr-2"></i> Guardar Receta
                                    </button>
                                    <button type="button" onclick="limpiarReceta()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg transition">
                                        <i class="fa-solid fa-trash mr-2"></i> Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Columna Derecha: Vista Previa -->
                        <div>
                            <div id="receta-preview-card" class="bg-white rounded-xl shadow-lg p-6 sticky top-6 border-2 border-gray-200">
                                <!-- Encabezado Receta -->
                                <div class="text-center border-b-2 border-gray-300 pb-4 mb-4">
                                    <h4 class="font-black text-lg text-gray-900">RECETA M√âDICA</h4>
                                    <p class="text-xs text-gray-600 font-bold">Electr√≥nica - V√°lida internacionalmente</p>
                                </div>

                                <!-- Datos Paciente -->
                                <div class="mb-4 text-sm">
                                    <p class="font-bold text-gray-800" id="preview-nombre-paciente">Paciente: -</p>
                                    <p class="text-xs text-gray-600" id="preview-cedula-paciente"></p>
                                </div>

                                <!-- Medicamentos -->
                                <div class="mb-4 border-t border-b border-gray-200 py-3">
                                    <p class="font-bold text-gray-800 text-sm mb-2">Medicamentos:</p>
                                    <div id="preview-medicamentos" class="text-xs text-gray-700 space-y-1">
                                        <p class="italic text-gray-500">Agrega medicamentos...</p>
                                    </div>
                                </div>

                                <!-- Instrucciones -->
                                <div class="mb-4 text-sm">
                                    <p class="font-bold text-gray-800 mb-1 text-xs">Instrucciones:</p>
                                    <div id="preview-instrucciones" class="text-xs text-gray-600 p-2 bg-gray-50 rounded border border-gray-200 min-h-20">
                                        <p class="italic text-gray-500">Escribe instrucciones...</p>
                                    </div>
                                </div>

                                <!-- Pie de P√°gina -->
                                <div class="border-t pt-3 text-xs text-gray-600">
                                    <p class="font-bold text-gray-800 mb-1">Validaciones:</p>
                                    <div class="space-y-1">
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-check text-green-600"></i>
                                            <span id="interacciones-count" class="text-xs">Interacciones: 0</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-check text-green-600"></i>
                                            <span id="duplicadas-count" class="text-xs">Terapia Duplicada: 0</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <i class="fa-solid fa-check text-green-600"></i>
                                            <span id="condiciones-count" class="text-xs">Condiciones: 0</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Logos Validadores -->
                                <div class="mt-4 pt-3 border-t text-center text-xs text-gray-500">
                                    <p class="font-bold mb-2">Validado por:</p>
                                    <div class="flex justify-center gap-3 text-gray-400">
                                        <span>‚úì Sistema Seguro</span>
                                        <span>‚úì Encriptado</span>
                                    </div>
                                </div>
                                
                                <!-- Firma Digital -->
                                <div id="firma-preview" class="mt-4 pt-4 border-t-2 border-blue-400 hidden">
                                    <div class="bg-blue-50 p-3 rounded border border-blue-200">
                                        <div class="flex items-center gap-2 mb-2">
                                            <i class="fa-solid fa-pen-fancy text-blue-600"></i>
                                            <span class="text-xs font-bold text-blue-900">Firmada Digitalmente (SAT)</span>
                                        </div>
                                        <p class="text-xs text-gray-700"><strong>C√©dula:</strong> <span id="firma-cedula-preview">-</span></p>
                                        <p class="text-xs text-gray-700"><strong>Certificado:</strong> <span id="firma-cert-preview">-</span></p>
                                        <p class="text-xs text-gray-700"><strong>Hash:</strong> <code class="bg-white px-1 py-0.5 rounded text-xs" id="firma-hash-preview">-</code></p>
                                        <p class="text-xs text-green-700 font-bold mt-2">‚úÖ V√°lida legalmente</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mi Expediente (Paciente) - CENTRO DE OPERACIONES -->
                <div id="mi-expediente" class="view hidden">
                    <!-- Barra Superior: Datos Paciente + Acciones -->
                    <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-4">
                                <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-2xl">
                                    <i class="fa-solid fa-user"></i>
                                </div>
                                <div>
                                    <h2 id="exp-nombre-header" class="text-4xl font-black">Juan Garc√≠a</h2>
                                    <p id="exp-edad-header" class="text-blue-100 text-sm">32 a√±os ‚Ä¢ <span id="exp-genero-header">Masculino</span></p>
                                    <p id="exp-cedula-header" class="text-blue-100 text-xs font-mono mt-1">CURP: LOXA811017HNEZXG08</p>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="switchView('nueva-consulta')" class="bg-white text-blue-600 font-bold px-6 py-3 rounded-lg hover:bg-blue-50 transition flex items-center gap-2">
                                    <i class="fa-solid fa-stethoscope"></i> Nueva Consulta
                                </button>
                                <button onclick="abrirModalAntecedentes()" class="bg-blue-700 hover:bg-blue-800 text-white font-bold px-4 py-3 rounded-lg transition flex items-center gap-2">
                                    <i class="fa-solid fa-file-medical"></i> Antecedentes
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Grid Principal: 3 Columnas -->
                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        
                        <!-- COLUMNA IZQUIERDA: Datos Paciente + Signos Vitales -->
                        <div class="lg:col-span-1 space-y-6">
                            <!-- Tarjeta Paciente -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <div class="text-center mb-4">
                                    <img id="exp-foto-preview" src="https://via.placeholder.com/80" alt="Foto de perfil" class="w-20 h-20 rounded-full mx-auto object-cover border-4 border-gray-200">
                                    <input type="file" id="exp-foto-input" accept="image/*" style="display:none;">
                                </div>
                                <button onclick="document.getElementById('exp-foto-input').click()" class="w-full text-white font-bold px-4 py-2 rounded-lg transition text-xs mb-4" style="background-color: #1465ff;">
                                    <i class="fa-solid fa-camera mr-2"></i>Cambiar Foto
                                </button>
                                <h3 id="exp-nombre" class="text-xl font-black text-gray-900 text-center">Juan Garc√≠a</h3>
                                <p id="exp-edad" class="text-sm text-gray-500 text-center">32 a√±os</p>
                                <hr class="my-4">
                                <div class="space-y-3 text-sm">
                                    <div>
                                        <p class="text-gray-400 font-bold">C√âDULA</p>
                                        <p id="exp-cedula" class="text-gray-900 font-bold">1234567890</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400 font-bold">EMAIL</p>
                                        <p id="exp-email" class="text-gray-900 font-bold">patient@hospital.mx</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-400 font-bold">TEL√âFONO</p>
                                        <p id="exp-telefono" class="text-gray-900 font-bold">-</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Signos Vitales -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h4 class="font-black text-gray-900 mb-4 flex items-center gap-2">
                                    <i class="fa-solid fa-heart text-red-600"></i> Signos Vitales
                                </h4>
                                <div class="space-y-3">
                                    <div class="bg-gradient-to-r from-purple-50 to-purple-100 p-3 rounded-lg">
                                        <p class="text-gray-500 text-xs font-bold">ALTURA</p>
                                        <p id="exp-altura" class="text-2xl font-black text-purple-600">1.78 m</p>
                                    </div>
                                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-3 rounded-lg">
                                        <p class="text-gray-500 text-xs font-bold">PESO</p>
                                        <p id="exp-peso" class="text-2xl font-black text-blue-600">76 kg</p>
                                    </div>
                                    <div class="bg-gradient-to-r from-green-50 to-green-100 p-3 rounded-lg">
                                        <p class="text-gray-500 text-xs font-bold">BMI</p>
                                        <p id="exp-bmi" class="text-2xl font-black text-green-600">23.99</p>
                                    </div>
                                    <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-3 rounded-lg">
                                        <p class="text-gray-500 text-xs font-bold">TEMPERATURA</p>
                                        <p id="exp-temp" class="text-2xl font-black text-orange-600">36.5¬∞C</p>
                                    </div>
                                </div>
                                <button onclick="switchView('formulario-vitales')" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition text-sm">
                                    <i class="fa-solid fa-edit mr-2"></i> Actualizar
                                </button>
                            </div>
                        </div>

                        <!-- COLUMNA CENTRAL: Resumen + Antecedentes -->
                        <div class="lg:col-span-2 space-y-6">
                            <!-- Resumen -->
                            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-l-4 border-blue-600 p-6">
                                <h4 class="font-black text-gray-900 mb-2 flex items-center gap-2">
                                    <i class="fa-solid fa-file-medical text-blue-600"></i> Resumen Cl√≠nico
                                </h4>
                                <p id="exp-resumen" class="text-gray-700 text-sm leading-relaxed">
                                    Paciente ha sido atendido en 3 ocasiones desde Octubre de 2023. Su √∫ltima consulta fue el 14 de marzo de 2025 por motivo de dolor tor√°cico. Actualmente inscrito en protocolo de nutrici√≥n y control de peso.
                                </p>
                            </div>

                            <!-- Alergias - DIN√ÅMICO -->
                            <div class="bg-red-50 rounded-xl border border-red-200 p-6">
                                <h4 class="font-black text-red-900 mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-triangle-exclamation text-red-600"></i> ALERGIAS
                                </h4>
                                <div id="exp-alergias-list" class="space-y-2">
                                    <p class="text-gray-500 text-sm italic">No hay alergias registradas</p>
                                </div>
                            </div>

                            <!-- Antecedentes Patol√≥gicos - DIN√ÅMICO -->
                            <div class="bg-blue-50 rounded-xl border border-blue-200 p-6">
                                <h4 class="font-black text-blue-900 mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-stethoscope text-blue-600"></i> ANTECEDENTES PATOL√ìGICOS
                                </h4>
                                <div id="exp-patologicos-list" class="space-y-2">
                                    <p class="text-gray-500 text-sm italic">No hay antecedentes patol√≥gicos</p>
                                </div>
                            </div>

                            <!-- Antecedentes No Patol√≥gicos - DIN√ÅMICO -->
                            <div class="bg-green-50 rounded-xl border border-green-200 p-6">
                                <h4 class="font-black text-green-900 mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-leaf text-green-600"></i> ANTECEDENTES NO PATOL√ìGICOS
                                </h4>
                                <div id="exp-no-patologicos-list" class="space-y-2">
                                    <p class="text-gray-500 text-sm italic">No hay antecedentes</p>
                                </div>
                            </div>

                            <!-- Historial de Consultas -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h4 class="font-black text-gray-900 mb-4">Historial de Consultas</h4>
                                <div id="exp-consultas" class="space-y-3">
                                    <div class="border-l-4 border-blue-600 pl-4 py-2">
                                        <p class="font-bold text-gray-900">Consulta General</p>
                                        <p class="text-sm text-gray-500">14 de marzo, 2025</p>
                                        <p class="text-sm text-gray-700">Dolor tor√°cico leve</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- COLUMNA DERECHA: Acciones R√°pidas -->
                        <div class="lg:col-span-1 space-y-6">
                            <!-- Botones de Acci√≥n -->
                            <div class="bg-white rounded-xl shadow-lg p-6 space-y-3">
                                <h4 class="font-black text-gray-900 mb-4">Acciones</h4>
                                <button onclick="switchView('formulario-vitales')" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-bold transition text-sm">
                                    <i class="fa-solid fa-heart mr-2"></i> Signos Vitales
                                </button>
                            </div>

                            <!-- Gr√°fica de Signos Vitales -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h4 class="font-black text-gray-900 mb-4">
                                    <i class="fa-solid fa-chart-line text-purple-600 mr-2"></i> Tendencias (7 d√≠as)
                                </h4>
                                <div class="relative h-64">
                                    <canvas id="chart-signos-vitales"></canvas>
                                </div>
                            </div>

                            <!-- Medicamentos Activos -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h4 class="font-black text-gray-900 mb-3">
                                    <i class="fa-solid fa-pills text-green-600 mr-2"></i> Medicamentos
                                </h4>
                                <div id="exp-medicamentos" class="space-y-2 text-sm">
                                    <div class="flex justify-between items-center bg-green-50 p-2 rounded">
                                        <span class="font-bold">Paracetamol</span>
                                        <span class="text-green-600 text-xs font-bold">ACTIVO</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Pr√≥ximas Citas -->
                            <div class="bg-white rounded-xl shadow-lg p-6">
                                <h4 class="font-black text-gray-900 mb-3">
                                    <i class="fa-solid fa-calendar text-blue-600 mr-2"></i> Pr√≥ximas Citas
                                </h4>
                                <div id="exp-citas" class="space-y-2 text-sm">
                                    <div class="border-l-4 border-blue-600 pl-3 py-2">
                                        <p class="font-bold text-gray-900">Seguimiento</p>
                                        <p class="text-gray-500">25 Jul, 4:30pm</p>
                                        <p class="text-blue-600 text-xs font-bold">Nutrici√≥n</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Antecedentes -->
                <div id="modal-antecedentes" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-96 overflow-y-auto">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 flex justify-between items-center">
                            <h3 class="text-2xl font-black">Antecedentes Cl√≠nicos</h3>
                            <button onclick="cerrarModalAntecedentes()" class="text-white hover:bg-blue-700 rounded-lg p-2 transition">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-8">
                            <div class="grid grid-cols-2 gap-8">
                                <!-- Columna Izquierda -->
                                <div class="space-y-4">
                                    <!-- Alergias -->
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                        <h4 class="font-black text-red-900 mb-3 flex items-center gap-2">
                                            <i class="fa-solid fa-triangle-exclamation text-red-600"></i> ALERGIAS
                                        </h4>
                                        <input type="text" id="input-alergias" class="w-full border border-red-300 rounded px-3 py-2 mb-2 text-sm" placeholder="Agregar alergia...">
                                        <div id="lista-alergias" class="space-y-2"></div>
                                        <button onclick="agregarAntecedente('alergias')" class="w-full mt-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded text-sm">+ Agregar</button>
                                    </div>

                                    <!-- Antecedentes Patol√≥gicos -->
                                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                        <h4 class="font-black text-blue-900 mb-3 flex items-center gap-2">
                                            <i class="fa-solid fa-stethoscope text-blue-600"></i> PATOL√ìGICOS
                                        </h4>
                                        <input type="text" id="input-patologicos" class="w-full border border-blue-300 rounded px-3 py-2 mb-2 text-sm" placeholder="Ej: Diabetes Tipo 2...">
                                        <div id="lista-patologicos" class="space-y-2"></div>
                                        <button onclick="agregarAntecedente('patologicos')" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded text-sm">+ Agregar</button>
                                    </div>

                                    <!-- Antecedentes No Patol√≥gicos -->
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <h4 class="font-black text-green-900 mb-3 flex items-center gap-2">
                                            <i class="fa-solid fa-leaf text-green-600"></i> NO PATOL√ìGICOS
                                        </h4>
                                        <input type="text" id="input-no-patologicos" class="w-full border border-green-300 rounded px-3 py-2 mb-2 text-sm" placeholder="Ej: Fumador, Consumo de alcohol...">
                                        <div id="lista-no-patologicos" class="space-y-2"></div>
                                        <button onclick="agregarAntecedente('no-patologicos')" class="w-full mt-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded text-sm">+ Agregar</button>
                                    </div>
                                </div>

                                <!-- Columna Derecha -->
                                <div class="space-y-4">
                                    <!-- Antecedentes Heredofamiliares -->
                                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                                        <h4 class="font-black text-purple-900 mb-3 flex items-center gap-2">
                                            <i class="fa-solid fa-sitemap text-purple-600"></i> HEREDOFAMILIARES
                                        </h4>
                                        <input type="text" id="input-heredofamiliares" class="w-full border border-purple-300 rounded px-3 py-2 mb-2 text-sm" placeholder="Ej: Diabetes en padre...">
                                        <div id="lista-heredofamiliares" class="space-y-2"></div>
                                        <button onclick="agregarAntecedente('heredofamiliares')" class="w-full mt-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded text-sm">+ Agregar</button>
                                    </div>

                                    <!-- Antecedentes Psiqui√°tricos -->
                                    <div class="bg-pink-50 border border-pink-200 rounded-lg p-4">
                                        <h4 class="font-black text-pink-900 mb-3 flex items-center gap-2">
                                            <i class="fa-solid fa-brain text-pink-600"></i> PSIQUI√ÅTRICOS
                                        </h4>
                                        <input type="text" id="input-psiquiatricos" class="w-full border border-pink-300 rounded px-3 py-2 mb-2 text-sm" placeholder="Ej: Ansiedad, Depresi√≥n...">
                                        <div id="lista-psiquiatricos" class="space-y-2"></div>
                                        <button onclick="agregarAntecedente('psiquiatricos')" class="w-full mt-2 bg-pink-600 hover:bg-pink-700 text-white font-bold py-2 rounded text-sm">+ Agregar</button>
                                    </div>

                                    <!-- Vacunas -->
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg p-4">
                                        <h4 class="font-black text-orange-900 mb-3 flex items-center gap-2">
                                            <i class="fa-solid fa-syringe text-orange-600"></i> VACUNAS
                                        </h4>
                                        <input type="text" id="input-vacunas" class="w-full border border-orange-300 rounded px-3 py-2 mb-2 text-sm" placeholder="Ej: COVID-19 (Feb 2026)...">
                                        <div id="lista-vacunas" class="space-y-2"></div>
                                        <button onclick="agregarAntecedente('vacunas')" class="w-full mt-2 bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded text-sm">+ Agregar</button>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-end gap-3 mt-8 border-t pt-4">
                                <button onclick="cerrarModalAntecedentes()" class="px-6 py-2 border border-gray-300 rounded-lg font-bold hover:bg-gray-50 transition">Cancelar</button>
                                <button onclick="guardarAntecedentes()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition">Guardar Cambios</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Nueva Cita -->
                <div id="modal-nueva-cita" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 flex justify-between items-center rounded-t-xl">
                            <h3 class="text-2xl font-black">Nueva Cita</h3>
                            <button onclick="cerrarModalNuevaCita()" class="text-white hover:bg-blue-700 rounded-lg p-2 transition">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-8 space-y-6">
                            <!-- Buscador Inteligente de Paciente -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Paciente *</label>
                                <div class="relative">
                                    <input type="text" id="cita-paciente" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="Escribe nombre, apellido o c√©dula..." oninput="buscarPacienteCita()">
                                    <div id="resultados-pacientes-cita" class="absolute top-full left-0 right-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-64 overflow-y-auto hidden z-50">
                                        <!-- Resultados din√°micos -->
                                    </div>
                                </div>
                                <input type="hidden" id="paciente-cita-id" value="">
                            </div>

                            <!-- Fecha y Hora -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Fecha</label>
                                    <input type="date" id="cita-fecha" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Hora</label>
                                    <input type="time" id="cita-hora" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                                </div>
                            </div>

                            <!-- Duraci√≥n y Tipo de Servicio -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Duraci√≥n (minutos)</label>
                                    <input type="number" id="cita-duracion" value="30" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Tipo de Servicio</label>
                                    <select id="cita-tipo" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                                        <option value="consulta-general">Consulta General</option>
                                        <option value="seguimiento">Seguimiento</option>
                                        <option value="procedimiento">Procedimiento</option>
                                        <option value="laboratorio">Laboratorio</option>
                                        <option value="imagenologia">Imagenolog√≠a</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Notas -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Notas</label>
                                <textarea id="cita-notas" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold resize-none" placeholder="Notas adicionales..."></textarea>
                            </div>

                            <!-- Botones -->
                            <div class="flex justify-end gap-3 border-t pt-6">
                                <button onclick="cerrarModalNuevaCita()" class="px-6 py-2 border border-gray-300 rounded-lg font-bold hover:bg-gray-50 transition">Cancelar</button>
                                <button id="btn-guardar-cita" onclick="guardarNuevaCita(this)" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition">
                                    <i class="fa-solid fa-plus mr-2"></i> Crear Cita
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Nuevo Paciente -->
                <div id="modal-nuevo-paciente" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 flex justify-between items-center rounded-t-xl">
                            <h3 class="text-2xl font-black">Crear Nuevo Paciente</h3>
                            <button onclick="cerrarModalNuevoPaciente()" class="text-white hover:bg-blue-700 rounded-lg p-2 transition">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-8 space-y-6">
                            <!-- Nombre -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Nombre Completo *</label>
                                <input type="text" id="nuevo-nombre" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="Juan Garc√≠a L√≥pez">
                            </div>

                            <!-- CURP y Fecha de Nacimiento -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">CURP (Centro √önico de Registro de Poblaci√≥n) *</label>
                                    <input type="text" id="nuevo-curp" maxlength="18" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold uppercase" placeholder="GARLO850215HDFLNN01">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Fecha de Nacimiento *</label>
                                    <input type="date" id="nuevo-fecha-nac" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" onchange="calcularEdad()">
                                </div>
                            </div>

                            <!-- Edad calculada autom√°ticamente -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Edad (Calculada)</label>
                                <input type="number" id="nuevo-edad" readonly class="w-full border border-gray-300 rounded-lg px-4 py-3 bg-gray-100 font-bold text-gray-700" placeholder="0">
                            </div>

                            <!-- Email y Tel√©fono -->
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Email *</label>
                                    <input type="email" id="nuevo-email" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="juan@ejemplo.com">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Tel√©fono/M√≥vil</label>
                                    <input type="tel" id="nuevo-telefono" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="+52 123 456 7890">
                                </div>
                            </div>

                            <!-- Sexo -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Sexo *</label>
                                <select id="nuevo-sexo" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                                    <option value="">Selecciona...</option>
                                    <option value="M">Masculino</option>
                                    <option value="F">Femenino</option>
                                </select>
                            </div>

                            <!-- Direcci√≥n -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Direcci√≥n Completa</label>
                                <input type="text" id="nuevo-direccion" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="Calle Principal 123, Apartamento 4B, Ciudad, Estado">
                            </div>

                            <!-- Botones -->
                            <div class="flex justify-end gap-3 border-t pt-6">
                                <button onclick="cerrarModalNuevoPaciente()" class="px-6 py-2 border border-gray-300 rounded-lg font-bold hover:bg-gray-50 transition">Cancelar</button>
                                <button onclick="guardarNuevoPaciente()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition">
                                    <i class="fa-solid fa-plus mr-2"></i> Crear Paciente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Importar Excel -->
                <div id="modal-importar-excel" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
                        <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-6 flex justify-between items-center rounded-t-xl">
                            <h3 class="text-2xl font-black">Importar Pacientes desde Excel</h3>
                            <button onclick="cerrarModalImportarExcel()" class="text-white hover:bg-green-700 rounded-lg p-2 transition">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-8 space-y-6">
                            <!-- Instrucciones -->
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <h4 class="font-black text-green-900 mb-3 flex items-center gap-2">
                                    <i class="fa-solid fa-circle-info text-green-600"></i> Instrucciones
                                </h4>
                                <ul class="text-sm text-gray-700 space-y-2 list-disc list-inside">
                                    <li>Descarga la plantilla de ejemplo</li>
                                    <li>Completa los datos de tus pacientes en el archivo CSV</li>
                                    <li>Guarda el archivo como CSV (separado por comas)</li>
                                    <li>Sube el archivo aqu√≠ para importar todos los pacientes</li>
                                </ul>
                            </div>

                            <!-- Bot√≥n Descargar Plantilla -->
                            <div>
                                <button onclick="descargarPlantilla()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-download"></i> Descargar Plantilla de Ejemplo (CSV)
                                </button>
                            </div>

                            <!-- Upload CSV -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Seleccionar archivo CSV *</label>
                                <input type="file" id="csv-archivo" accept=".csv" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none font-bold">
                            </div>

                            <!-- Previsualizador -->
                            <div id="csv-preview" class="hidden">
                                <h4 class="font-black text-gray-900 mb-3">Vista Previa de Datos</h4>
                                <div id="preview-tabla" class="overflow-x-auto border rounded-lg"></div>
                            </div>

                            <!-- Botones -->
                            <div class="flex justify-end gap-3 border-t pt-6">
                                <button onclick="cerrarModalImportarExcel()" class="px-6 py-2 border border-gray-300 rounded-lg font-bold hover:bg-gray-50 transition">Cancelar</button>
                                <button onclick="importarDesdeCsv()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition">
                                    <i class="fa-solid fa-upload mr-2"></i> Importar Pacientes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Nuevo Producto -->
                <div id="modal-nuevo-producto" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-6 flex justify-between items-center rounded-t-xl">
                            <h3 id="modal-titulo-producto" class="text-2xl font-black">Crear Nuevo Servicio/Producto</h3>
                            <button onclick="cerrarModalNuevoProducto()" class="text-white hover:bg-blue-700 rounded-lg p-2 transition">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-8 space-y-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">C√≥digo/SKU *</label>
                                <input type="text" id="prod-codigo" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="SRV-001">
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Nombre del Servicio/Producto *</label>
                                <input type="text" id="prod-nombre" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="Consulta General">
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Categor√≠a *</label>
                                    <select id="prod-categoria" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                                        <option value="">Selecciona...</option>
                                        <option value="consulta">Consulta</option>
                                        <option value="laboratorio">Laboratorio</option>
                                        <option value="imagenologia">Imagenolog√≠a</option>
                                        <option value="procedimiento">Procedimiento</option>
                                        <option value="medicinas">Medicinas</option>
                                        <option value="otros">Otros</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Precio (MXN) *</label>
                                    <input type="number" id="prod-precio" step="0.01" min="0" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="500.00">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Descripci√≥n</label>
                                <textarea id="prod-descripcion" rows="3" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none font-bold resize-none" placeholder="Descripci√≥n del servicio..."></textarea>
                            </div>

                            <div>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" id="prod-activo" checked class="w-5 h-5 text-blue-600 rounded">
                                    <span class="text-sm font-bold text-gray-700">Activo (disponible para cobros)</span>
                                </label>
                            </div>

                            <div class="flex justify-end gap-3 border-t pt-6">
                                <button onclick="cerrarModalNuevoProducto()" class="px-6 py-2 border border-gray-300 rounded-lg font-bold hover:bg-gray-50 transition">Cancelar</button>
                                <button id="btn-guardar-producto" onclick="guardarNuevoProducto()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition">
                                    <i class="fa-solid fa-plus mr-2"></i> Crear Servicio
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Nuevo Cobro -->
                <div id="modal-nuevo-cobro" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full">
                        <div class="bg-gradient-to-r from-green-600 to-emerald-600 text-white p-6 flex justify-between items-center rounded-t-xl">
                            <h3 class="text-2xl font-black">Registrar Nuevo Cobro</h3>
                            <button onclick="cerrarModalNuevoCobro()" class="text-white hover:bg-green-700 rounded-lg p-2 transition">
                                <i class="fa-solid fa-times text-xl"></i>
                            </button>
                        </div>
                        <div class="p-8 space-y-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Paciente *</label>
                                <select id="cobro-paciente" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none font-bold">
                                    <option value="">Selecciona un paciente...</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Servicio/Producto *</label>
                                <select id="cobro-producto" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none font-bold" onchange="actualizarMontoCobro()">
                                    <option value="">Selecciona un servicio...</option>
                                </select>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Monto (MXN)</label>
                                    <input type="number" id="cobro-monto" step="0.01" min="0" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none font-bold" placeholder="500.00">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">M√©todo de Pago *</label>
                                    <select id="cobro-metodo" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none font-bold">
                                        <option value="efectivo">Efectivo</option>
                                        <option value="tarjeta-credito">Tarjeta de Cr√©dito</option>
                                        <option value="tarjeta-debito">Tarjeta de D√©bito</option>
                                        <option value="transferencia">Transferencia Bancaria</option>
                                        <option value="cheque">Cheque</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Estado del Pago *</label>
                                <select id="cobro-estado" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none font-bold">
                                    <option value="pagado">Pagado</option>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="parcial">Pago Parcial</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Notas</label>
                                <textarea id="cobro-notas" rows="2" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-green-500 outline-none font-bold resize-none" placeholder="Notas sobre el cobro..."></textarea>
                            </div>

                            <div class="flex justify-end gap-3 border-t pt-6">
                                <button onclick="cerrarModalNuevoCobro()" class="px-6 py-2 border border-gray-300 rounded-lg font-bold hover:bg-gray-50 transition">Cancelar</button>
                                <button onclick="guardarNuevoCobro()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition">
                                    <i class="fa-solid fa-check mr-2"></i> Registrar Cobro
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario Signos Vitales -->
                <div id="formulario-vitales" class="view hidden">
                    <h2 class="text-3xl font-black text-gray-900 mb-6">Registrar Signos Vitales</h2>
                    <div class="bg-white rounded-xl shadow-lg p-8 max-w-2xl">
                        <form id="vitales-form" class="space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Altura (m)</label>
                                    <input type="number" id="altura" step="0.01" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="1.78">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Peso (kg)</label>
                                    <input type="number" id="peso" step="0.1" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="76">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Temperatura (¬∞C)</label>
                                <input type="number" id="temperatura" step="0.1" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="36.5">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Presi√≥n Sist√≥lica</label>
                                    <input type="number" id="presion-sistolica" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="120">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">Presi√≥n Diast√≥lica</label>
                                    <input type="number" id="presion-diastolica" class="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="80">
                                </div>
                            </div>
                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition">
                                Guardar Signos Vitales
                            </button>
                            <button type="button" onclick="switchView('mi-expediente')" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-900 font-bold py-3 rounded-lg transition">
                                Cancelar
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Gesti√≥n Pacientes (Admin) -->
                <div id="pacientes" class="view hidden">
                    <h2 class="text-3xl font-black text-gray-900 mb-6">Gesti√≥n de Pacientes</h2>
                    <div class="mb-6">
                        <button id="new-patient-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold transition">
                            <i class="fa-solid fa-plus mr-2"></i>Nuevo Paciente
                        </button>
                    </div>
                    <div id="pacientes-table" class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <!-- Tabla de pacientes -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // Cambiar color de iconos en sidebar al pasar el mouse
        document.querySelectorAll('aside button').forEach(btn => {
            const icon = btn.querySelector('i');
            if (icon) {
                btn.addEventListener('mouseenter', () => {
                    icon.style.color = '#1465ff';
                });
                btn.addEventListener('mouseleave', () => {
                    icon.style.color = '#859ac1';
                });
            }
        });

        // Cambiar color del icono cuando el bot√≥n est√° activo
        function switchView(viewName) {
            // Ocultar todas las vistas
            document.querySelectorAll('.view').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Mostrar la vista seleccionada
            const selectedView = document.getElementById(viewName);
            if (selectedView) {
                selectedView.classList.remove('hidden');
            }
            
            // Actualizar estilos de botones del sidebar
            document.querySelectorAll('aside button').forEach(btn => {
                btn.classList.remove('active');
                const icon = btn.querySelector('i');
                if (icon) icon.style.color = '#859ac1';
            });
            
            event.target.closest('button').classList.add('active');
            const activeIcon = event.target.closest('button').querySelector('i');
            if (activeIcon) activeIcon.style.color = '#1465ff';
            
            // Cargar datos espec√≠ficos de cada vista
            if (viewName === 'agenda-operativa') {
                cargarMedicosAgenda();
                renderizarAgenda();
            } else if (viewName === 'mis-pacientes') {
                loadMedicoPatients();
            }
        }
        
        // Alias para cargar pacientes
        async function cargarPacientes() {
            return loadMedicoPatients();
        }
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC1D-VFJhy2jWwx__Q67Dvdk0U6G5KUJZ4",
            authDomain: "medicore-879e2.firebaseapp.com",
            projectId: "medicore-879e2",
            storageBucket: "medicore-879e2.firebasestorage.app",
            messagingSenderId: "201528061875",
            appId: "1:201528061875:web:2904b0c5d3a17cdd5025c6"
        };

        let auth, db;
        let currentUser = null;
        let currentRole = null;
        let currentPatientId = null;  // Rastrear qu√© paciente se est√° viendo

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();

        console.log('‚úÖ Firebase inicializado');

        // ==================== VALIDACI√ìN DE C√âDULA M√âDICA Y FIRMA DIGITAL ====================
        
        // Validador de C√©dula M√©dica
        async function validarCedulaMedica() {
            const cedula = document.getElementById('med-cedula').value.trim();
            const statusDiv = document.getElementById('cedula-validation-status');
            
            if (!cedula) {
                statusDiv.innerHTML = '<span class="text-red-600">‚ö†Ô∏è Ingresa una c√©dula profesional</span>';
                statusDiv.classList.remove('hidden');
                return;
            }
            
            if (!/^\d{6,8}$/.test(cedula)) {
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Formato inv√°lido (debe contener 6-8 d√≠gitos)</span>';
                statusDiv.classList.remove('hidden');
                return;
            }
            
            statusDiv.innerHTML = '<span class="text-blue-600"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Validando...</span>';
            statusDiv.classList.remove('hidden');
            
            try {
                // Validaci√≥n local b√°sica de c√©dula
                const formatoCedula = /^\d{6,8}$/.test(cedula);
                
                if (!formatoCedula) {
                    throw new Error('Formato de c√©dula inv√°lido');
                }
                
                // Guardar en Firestore la c√©dula validada
                const rfc = document.getElementById('med-rfc')?.value || '';
                const email = document.getElementById('med-email')?.value || '';
                
                // Verificar si ya existe en base de datos
                const snapshot = await db.collection('cedulasValidadas')
                    .where('cedula', '==', cedula)
                    .get();
                
                if (snapshot.empty) {
                    // Crear registro de c√©dula validada
                    await db.collection('cedulasValidadas').add({
                        cedula: cedula,
                        rfc: rfc,
                        email: email,
                        validadaEn: firebase.firestore.FieldValue.serverTimestamp(),
                        vigencia: new Date(new Date().setFullYear(new Date().getFullYear() + 5)), // V√°lida por 5 a√±os
                        estado: 'activa'
                    });
                }
                
                statusDiv.innerHTML = '<span class="text-green-600">‚úÖ C√©dula v√°lida y registrada (Vigencia: 5 a√±os)</span>';
                document.getElementById('med-cedula').style.borderColor = '#10B981';
                
            } catch (error) {
                console.error('Error validando c√©dula:', error);
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Error: ' + error.message + '</span>';
                document.getElementById('med-cedula').style.borderColor = '#EF4444';
            }
        }
        
        // Variables para firma digital
        let firmaDigitalData = null;
        let cFirmaLoadingScript = false;
        
        // Cargar firma digital desde archivo .p12
        async function cargarFirmaDigital() {
            const file = document.getElementById('firma-input').files[0];
            const statusDiv = document.getElementById('firma-status');
            
            if (!file) return;
            
            // Validar que sea .p12 o .pfx
            if (!file.name.match(/\.(p12|pfx)$/i)) {
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Debe ser un archivo .p12 o .pfx</span>';
                statusDiv.classList.remove('hidden');
                return;
            }
            
            statusDiv.innerHTML = '<span class="text-blue-600"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Cargando certificado SAT...</span>';
            statusDiv.classList.remove('hidden');
            
            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        firmaDigitalData = {
                            archivo: e.target.result,
                            nombre: file.name,
                            cargadoEn: new Date(),
                            cedulaAsociada: document.getElementById('med-cedula')?.value || ''
                        };
                        
                        statusDiv.innerHTML = '<span class="text-green-600">‚úÖ Certificado SAT cargado correctamente</span>';
                        document.getElementById('firma-digital-container').style.borderColor = '#10B981';
                        document.getElementById('firma-digital-container').style.backgroundColor = '#ECFDF5';
                        
                    } catch (error) {
                        statusDiv.innerHTML = '<span class="text-red-600">‚ùå Error procesando certificado: ' + error.message + '</span>';
                    }
                };
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                console.error('Error cargando firma:', error);
                statusDiv.innerHTML = '<span class="text-red-600">‚ùå Error: ' + error.message + '</span>';
            }
        }
        
        // Firmar receta digitalmente
        async function firmarRecetaDigitalmente(recetaId) {
            if (!firmaDigitalData) {
                alert('‚ö†Ô∏è Debes cargar un certificado SAT primero');
                return false;
            }
            
            if (!currentUser) {
                alert('‚ö†Ô∏è Usuario no identificado');
                return false;
            }
            
            try {
                const fechaFirma = new Date();
                const firma = {
                    firmadoPor: currentUser.uid,
                    doctorNombre: document.getElementById('user-name')?.innerText || 'Dr. An√≥nimo',
                    cedulaMedica: document.getElementById('med-cedula')?.value || '',
                    certificadoSAT: firmaDigitalData.nombre,
                    fechaFirma: fechaFirma,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    hash: 'firma-digital-' + Math.random().toString(36).substr(2, 9),
                    vigencia: new Date(fechaFirma.setFullYear(fechaFirma.getFullYear() + 1))
                };
                
                // Guardar firma en Firestore
                await db.collection('patients').doc(currentUser.uid)
                    .collection('firmasDigitales').add(firma);
                
                return firma;
                
            } catch (error) {
                console.error('Error firmando receta:', error);
                alert('Error al firmar receta: ' + error.message);
                return false;
            }
        }

        // Alternar entre login y signup
        document.getElementById('show-signup').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('signup-screen').classList.remove('hidden');
        });

        document.getElementById('show-login').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('signup-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        });

        // Signup Handler
        document.getElementById('signup-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const passwordConfirm = document.getElementById('signup-password-confirm').value;
            const nombre = document.getElementById('signup-name').value;
            const apellido = document.getElementById('signup-lastname').value;
            const role = document.getElementById('signup-role').value;

            if (!email || !password || !nombre || !apellido) {
                alert('Por favor completa todos los campos');
                return;
            }

            if (password !== passwordConfirm) {
                alert('Las contrase√±as no coinciden');
                return;
            }

            const signupBtn = document.getElementById('signup-btn');
            const originalText = signupBtn.innerHTML;
            signupBtn.disabled = true;
            signupBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Creando cuenta...';

            try {
                // Crear usuario en Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const uid = userCredential.user.uid;

                // Crear documento en Firestore
                await db.collection('patients').doc(uid).set({
                    email: email,
                    nombre: nombre,
                    apellido: apellido,
                    role: role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    genero: '',
                    fechaNacimiento: '',
                    curp: '',
                    cedula: '',
                    telefono: '',
                    altura: null,
                    peso: null,
                    temperatura: null
                });

                alert('‚úÖ Cuenta creada exitosamente. Ahora inicia sesi√≥n.');
                // Limpiar formulario
                document.getElementById('signup-email').value = '';
                document.getElementById('signup-password').value = '';
                document.getElementById('signup-password-confirm').value = '';
                document.getElementById('signup-name').value = '';
                document.getElementById('signup-lastname').value = '';
                
                // Volver al login
                document.getElementById('signup-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            } catch (error) {
                console.error('Error signup:', error);
                let errorMsg = 'Error creando cuenta';
                if (error.code === 'auth/email-already-in-use') errorMsg = 'El email ya est√° registrado';
                else if (error.code === 'auth/weak-password') errorMsg = 'La contrase√±a es muy d√©bil';
                else if (error.code === 'auth/invalid-email') errorMsg = 'Email inv√°lido';
                alert(errorMsg);
            } finally {
                signupBtn.disabled = false;
                signupBtn.innerHTML = originalText;
            }
        });

        // Crear usuario de prueba
        document.getElementById('create-test-user-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const btn = e.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Creando...';

            try {
                // Crear usuario de prueba paciente
                const testEmail = 'paciente@test.com';
                const testPassword = 'TestPass123!';
                
                const userCredential = await auth.createUserWithEmailAndPassword(testEmail, testPassword);
                
                // Crear documento en Firestore
                await db.collection('patients').doc(userCredential.user.uid).set({
                    email: testEmail,
                    role: 'paciente',
                    nombre: 'Juan',
                    apellido: 'P√©rez',
                    genero: 'M',
                    fechaNacimiento: '1990-01-01',
                    curp: 'PEJJ900101HDFLLR00',
                    cedula: '12345678',
                    telefono: '5551234567',
                    altura: 1.75,
                    peso: 75,
                    temperatura: 36.5,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`‚úÖ Usuario de prueba creado:\n\nEmail: ${testEmail}\nContrase√±a: ${testPassword}\n\nUsalo para hacer login.`);
                
                // Rellenar los campos
                document.getElementById('login-email').value = testEmail;
                document.getElementById('login-password').value = testPassword;
                document.getElementById('login-role').value = 'paciente';
            } catch (error) {
                console.error('Error creando usuario:', error);
                if (error.code === 'auth/email-already-in-use') {
                    alert('El usuario de prueba ya existe.\n\nEmail: paciente@test.com\nContrase√±a: TestPass123!');
                    document.getElementById('login-email').value = 'paciente@test.com';
                    document.getElementById('login-password').value = 'TestPass123!';
                    document.getElementById('login-role').value = 'paciente';
                } else {
                    alert('Error creando usuario: ' + error.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Login Handler
        document.getElementById('login-btn').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const role = document.getElementById('login-role').value;

            if (!email || !password) {
                alert('Por favor completa todos los campos');
                return;
            }

            const loginBtn = document.getElementById('login-btn');
            const originalText = loginBtn.innerHTML;
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Ingresando...';

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                currentRole = role;
                showDashboard(role, email);
            } catch (error) {
                console.error('Error login:', error);
                let errorMsg = 'Email o contrase√±a incorrectos';
                if (error.code === 'auth/user-not-found') errorMsg = 'Usuario no registrado';
                else if (error.code === 'auth/invalid-email') errorMsg = 'Email inv√°lido';
                alert(errorMsg);
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = originalText;
            }
        });

        // Show Dashboard
        async function showDashboard(role, email) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard-screen').classList.remove('hidden');
            
            document.getElementById('user-name').innerText = email.split('@')[0];
            document.getElementById('user-role').innerText = role.charAt(0).toUpperCase() + role.slice(1);

            try {
                await currentUser.getIdTokenResult(true);
                console.log('‚úÖ Token actualizado con role:', role);
            } catch (error) {
                console.error('‚ö†Ô∏è Error actualizando token:', error);
            }

            // Si es paciente, asegurar que existe su documento en Firestore
            if (role === 'paciente') {
                try {
                    const patientDoc = await db.collection('patients').doc(currentUser.uid).get();
                    if (!patientDoc.exists) {
                        // Crear documento m√≠nimo para el paciente
                        await db.collection('patients').doc(currentUser.uid).set({
                            email: email,
                            role: 'paciente',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            nombre: email.split('@')[0],
                            apellido: '',
                            genero: '',
                            fechaNacimiento: '',
                            curp: '',
                            cedula: '',
                            telefono: '',
                            altura: null,
                            peso: null,
                            temperatura: null
                        });
                        console.log('‚úÖ Documento de paciente creado');
                    }
                } catch (error) {
                    console.error('Error creando documento de paciente:', error);
                }
            }

            document.getElementById('medico-menu').classList.toggle('hidden', role !== 'medico');
            document.getElementById('paciente-menu').classList.toggle('hidden', role !== 'paciente');
            document.getElementById('admin-menu').classList.toggle('hidden', role !== 'admin');
            document.getElementById('btn-mi-cuenta').style.display = role === 'medico' ? 'block' : 'none';
            
            // Inicializar agenda para m√©dicos
            if (role === 'medico') {
                cargarMedicosAgenda();
                agendaState.vistaActual = 'semana';
                agendaState.fechaActual = new Date();
            }

            if (role === 'medico') {
                switchView('mis-pacientes');
                loadMedicoPatients();
                // Inicializar SVG clickeable para exploraci√≥n topogr√°fica
                setTimeout(() => inicializarSVGClickeable(), 500);
                // Inicializar odontograma
                setTimeout(() => inicializarOdontograma(), 500);
            }
            else if (role === 'paciente') {
                switchView('mi-expediente');
                loadPatientRecord();
            }
            else {
                switchView('pacientes');
            }
        }
        
        // Cargar pacientes del m√©dico
        async function loadMedicoPatients() {
            try {
                const snapshot = await db.collection('patients')
                    .where('assignedDoctor', '==', currentUser.uid)
                    .get();
                
                const tbody = document.getElementById('pacientes-tbody');
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No tienes pacientes asignados</td></tr>';
                    return;
                }
                
                tbody.innerHTML = snapshot.docs.map(doc => {
                    const p = doc.data();
                    const fechaNac = new Date(p.fechaNacimiento);
                    const edad = new Date().getFullYear() - fechaNac.getFullYear();
                    
                    return `
                        <tr class="hover:bg-gray-50 transition" data-patient-id="${doc.id}">
                            <td class="px-6 py-4 text-gray-900 font-bold" style="font-family: 'Inter', sans-serif;">${p.nombre} ${p.apellido}</td>
                            <td class="px-6 py-4 text-gray-700 text-sm" style="font-family: 'Inter', sans-serif;">${p.curp || '-'}</td>
                            <td class="px-6 py-4 text-gray-700 text-sm" style="font-family: 'Inter', sans-serif;">${edad} a√±os</td>
                            <td class="px-6 py-4 text-gray-700 text-sm" style="font-family: 'Inter', sans-serif;">${p.email}</td>
                            <td class="px-6 py-4 text-center">
                                <button class="btn-ver-expediente text-white px-3 py-1 rounded text-xs font-bold transition" style="background-color: #1465ff; font-family: 'Inter', sans-serif;">
                                    Ver Expediente
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Agregar event listeners a los botones
                document.querySelectorAll('.btn-ver-expediente').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const patientId = this.closest('tr').dataset.patientId;
                        console.log('Abriendo expediente de paciente:', patientId);
                        viewPatientRecord(patientId);
                    });
                });
                
                console.log(`‚úÖ Pacientes cargados: ${snapshot.size}`);
                loadPatientOptions();
            } catch (error) {
                console.error('Error cargando pacientes:', error);
            }
        }
        
        // Cargar opciones de pacientes en select
        async function loadPatientOptions() {
            try {
                const snapshot = await db.collection('patients')
                    .where('assignedDoctor', '==', currentUser.uid)
                    .get();
                
                const select = document.getElementById('select-paciente');
                if (!select) {
                    console.warn('‚ö†Ô∏è Elemento select-paciente no encontrado en el DOM');
                    return;
                }
                
                select.innerHTML = '<option value="">Selecciona un paciente...</option>';
                
                snapshot.docs.forEach(doc => {
                    const p = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${p.nombre} ${p.apellido}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando opciones:', error);
            }
        }
        
        // Ver expediente de paciente desde tabla
        function viewPatientRecord(patientId) {
            currentPatientId = patientId;
            console.log('Visualizando paciente:', patientId);
            loadPatientRecordById(patientId);
            switchView('mi-expediente');
        }
        
        // Cargar expediente del paciente
        async function loadPatientRecord() {
            await loadPatientRecordById(currentUser.uid);
        }
        
        async function loadPatientRecordById(patientId) {
            try {
                const doc = await db.collection('patients').doc(patientId).get();
                
                if (!doc.exists) {
                    console.log('‚ö†Ô∏è Expediente no encontrado');
                    return;
                }
                
                const p = doc.data();
                
                // Calcular edad de forma segura
                let edad = 'No especificada';
                if (p.fechaNacimiento && typeof p.fechaNacimiento === 'string' && p.fechaNacimiento.trim()) {
                    try {
                        const fechaNac = new Date(p.fechaNacimiento);
                        edad = new Date().getFullYear() - fechaNac.getFullYear();
                    } catch (e) {
                        edad = 'No especificada';
                    }
                }
                
                const altura = parseFloat(p.altura || 1.78);
                const peso = parseFloat(p.peso || 76);
                const bmi = (peso / (altura * altura)).toFixed(2);
                
                // Actualizar datos b√°sicos - con validaci√≥n null
                const setTextContent = (id, value) => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = value;
                    else console.warn(`Elemento ${id} no encontrado`);
                };
                
                setTextContent('exp-nombre', `${p.nombre} ${p.apellido}`);
                setTextContent('exp-nombre-header', `${p.nombre} ${p.apellido}`);
                setTextContent('exp-edad', `${edad} a√±os`);
                setTextContent('exp-edad-header', `${edad} a√±os`);
                setTextContent('exp-genero-header', p.genero || 'No especificado');
                setTextContent('exp-cedula', p.cedula);
                setTextContent('exp-cedula-header', `CURP: ${p.curp || p.cedula || 'N/A'}`);
                setTextContent('exp-email', p.email);
                setTextContent('exp-telefono', p.telefono || '-');
                
                // Update patient photo
                if (p.fotoUrl) {
                    const fotoPreview = document.getElementById('exp-foto-preview');
                    if (fotoPreview) fotoPreview.src = p.fotoUrl;
                } else {
                    // Reset to placeholder if patient has no photo
                    const fotoPreview = document.getElementById('exp-foto-preview');
                    if (fotoPreview) fotoPreview.src = 'https://via.placeholder.com/80';
                }
                
                // Signos vitales
                setTextContent('exp-altura', `${altura} m`);
                setTextContent('exp-peso', `${peso} kg`);
                setTextContent('exp-bmi', bmi);
                setTextContent('exp-temp', `${p.temperatura || 36.5}¬∞C`);
                
                // Alergias
                const alergControl = document.getElementById('exp-alergias');
                if (alergControl) alergControl.textContent = p.alergias || 'Sin alergias registradas';
                
                // Antecedentes Din√°micos
                const antecedentes = p.antecedentes || {
                    alergias: [],
                    patologicos: [],
                    'no-patologicos': [],
                    heredofamiliares: [],
                    psiquiatricos: [],
                    vacunas: []
                };
                
                // Mostrar alergias
                const alergiasList = document.getElementById('exp-alergias-list');
                if (alergiasList && antecedentes.alergias && antecedentes.alergias.length > 0) {
                    alergiasList.innerHTML = antecedentes.alergias.map(alergia => `
                        <div class="bg-red-100 px-3 py-2 rounded-lg font-bold text-red-900">
                            <i class="fa-solid fa-ban mr-2"></i>${alergia}
                        </div>
                    `).join('');
                }
                
                // Mostrar patol√≥gicos
                const patologicosList = document.getElementById('exp-patologicos-list');
                if (patologicosList && antecedentes.patologicos && antecedentes.patologicos.length > 0) {
                    patologicosList.innerHTML = antecedentes.patologicos.map(pat => `
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-check text-blue-600 mt-1"></i>
                            <span class="text-gray-800 font-bold">${pat}</span>
                        </div>
                    `).join('');
                }
                
                // Mostrar no patol√≥gicos
                const noPatologicosList = document.getElementById('exp-no-patologicos-list');
                if (noPatologicosList && antecedentes['no-patologicos'] && antecedentes['no-patologicos'].length > 0) {
                    noPatologicosList.innerHTML = antecedentes['no-patologicos'].map(nopat => `
                        <div class="flex items-start gap-2">
                            <i class="fa-solid fa-leaf text-green-600 mt-1"></i>
                            <span class="text-gray-800 font-bold">${nopat}</span>
                        </div>
                    `).join('');
                }
                
                // Cargar consultas
                const consultasSnapshot = await db.collection('patients').doc(patientId)
                    .collection('consultations').orderBy('createdAt', 'desc').get();
                
                const consultasDiv = document.getElementById('exp-consultas');
                if (consultasDiv) {
                    if (consultasSnapshot.empty) {
                        consultasDiv.innerHTML = '<p class="text-gray-500">Sin consultas registradas</p>';
                    } else {
                        consultasDiv.innerHTML = consultasSnapshot.docs.map(doc => {
                            const c = doc.data();
                            const fecha = c.createdAt?.toDate().toLocaleDateString('es-MX') || 'Sin fecha';
                            return `
                                <div class="border-l-4 border-blue-600 pl-4 py-2">
                                    <p class="font-bold text-gray-900">${c.diagnostico}</p>
                                    <p class="text-sm text-gray-500">${fecha}</p>
                                    <p class="text-sm text-gray-700">${c.sintomas}</p>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
                console.log('‚úÖ Expediente cargado:', p.nombre);
                
                // Renderizar gr√°fica de signos vitales
                setTimeout(() => {
                    renderGraficaSignosVitales(p);
                }, 500);
                
                // Cargar medicamentos activos y pr√≥ximas citas
                await cargarMedicamentosActivos(patientId);
                await cargarProximasCitas(patientId);
                
            } catch (error) {
                console.error('Error cargando expediente:', error);
            }
        }
        
        // ==================== GR√ÅFICAS DE SIGNOS VITALES ====================
        
        let chartInstance = null;
        
        function renderGraficaSignosVitales(paciente) {
            // Generar datos hist√≥ricos (√∫ltimos 7 d√≠as)
            const hoy = new Date();
            const dias = [];
            const dataPeso = [];
            const dataPresion = [];
            const dataTemp = [];
            
            for (let i = 6; i >= 0; i--) {
                const fecha = new Date(hoy);
                fecha.setDate(fecha.getDate() - i);
                dias.push(fecha.toLocaleDateString('es-MX', { month: 'short', day: 'numeric' }));
                
                // Simular datos hist√≥ricos (en producci√≥n vendr√≠an de Firestore)
                const pesoBase = parseFloat(paciente.peso || 76);
                const presionBase = 120;
                const tempBase = parseFloat(paciente.temperatura || 36.5);
                
                dataPeso.push(pesoBase + (Math.random() - 0.5) * 2);
                dataPresion.push(presionBase + (Math.random() - 0.5) * 8);
                dataTemp.push(tempBase + (Math.random() - 0.5) * 0.8);
            }
            
            const ctx = document.getElementById('chart-signos-vitales');
            if (!ctx) return;
            
            // Destruir gr√°fica anterior si existe
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            // Crear nueva gr√°fica
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dias,
                    datasets: [
                        {
                            label: 'Peso (kg)',
                            data: dataPeso,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'PAS (mmHg)',
                            data: dataPresion,
                            borderColor: '#ef4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#ef4444',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Temp (¬∞C)',
                            data: dataTemp,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            yAxisID: 'y2'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 12, weight: 'bold' },
                                padding: 15,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            cornerRadius: 8,
                            titleFont: { size: 13, weight: 'bold' },
                            bodyFont: { size: 12 }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Peso (kg)',
                                font: { size: 12, weight: 'bold' },
                                color: '#3b82f6'
                            },
                            ticks: { color: '#3b82f6' },
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            min: 70,
                            max: 85
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'PAS (mmHg)',
                                font: { size: 12, weight: 'bold' },
                                color: '#ef4444'
                            },
                            ticks: { color: '#ef4444' },
                            grid: { drawOnChartArea: false },
                            min: 100,
                            max: 140
                        },
                        y2: {
                            type: 'linear',
                            display: false,
                            position: 'right',
                            min: 35,
                            max: 38
                        },
                        x: {
                            grid: { color: 'rgba(0, 0, 0, 0.05)' },
                            ticks: { font: { size: 11 } }
                        }
                    }
                }
            });
        }
        
        // ==================== SINCRONIZACI√ìN DE MEDICAMENTOS Y CITAS ====================
        
        // Cargar medicamentos activos desde recetas
        async function cargarMedicamentosActivos(patientId) {
            try {
                const prescriptionsSnapshot = await db.collection('patients')
                    .doc(patientId)
                    .collection('prescriptions')
                    .where('estado', '==', 'activa')
                    .get();
                
                const medicamentosMap = new Map();
                
                // Iterar sobre todas las recetas activas
                prescriptionsSnapshot.forEach(doc => {
                    const receta = doc.data();
                    if (receta.medicamentos && Array.isArray(receta.medicamentos)) {
                        receta.medicamentos.forEach(med => {
                            const key = med.nombre.toLowerCase();
                            if (!medicamentosMap.has(key)) {
                                medicamentosMap.set(key, {
                                    nombre: med.nombre,
                                    dosis: med.dosis,
                                    frecuencia: med.frecuencia,
                                    dias: med.dias,
                                    desde: receta.createdAt,
                                    recetaId: doc.id
                                });
                            }
                        });
                    }
                });
                
                // Mostrar medicamentos en el expediente
                const medicamentosDiv = document.getElementById('exp-medicamentos');
                if (medicamentosDiv) {
                    if (medicamentosMap.size === 0) {
                        medicamentosDiv.innerHTML = '<p class="text-gray-500 text-sm italic">Sin medicamentos activos</p>';
                    } else {
                        medicamentosDiv.innerHTML = Array.from(medicamentosMap.values()).map(med => `
                            <div class="flex justify-between items-start bg-green-50 p-3 rounded border border-green-200">
                                <div class="flex-1">
                                    <p class="font-bold text-gray-900 text-sm">${med.nombre}</p>
                                    <p class="text-xs text-gray-600">${med.dosis || '-'}</p>
                                    <p class="text-xs text-gray-500">${med.frecuencia || '-'} x ${med.dias || '-'} d√≠as</p>
                                </div>
                                <span class="text-green-600 text-xs font-bold bg-green-100 px-2 py-1 rounded">ACTIVO</span>
                            </div>
                        `).join('');
                    }
                }
                
                console.log('‚úÖ Medicamentos cargados:', medicamentosMap.size);
                
            } catch (error) {
                console.error('Error cargando medicamentos:', error);
            }
        }
        
        // Cargar pr√≥ximas citas del paciente
        async function cargarProximasCitas(patientId) {
            try {
                const ahora = new Date();
                
                const citasSnapshot = await db.collection('appointments')
                    .where('pacienteId', '==', patientId)
                    .where('estado', 'in', ['pendiente', 'confirmada'])
                    .get();
                
                // Filtrar y ordenar citas futuras
                const citasFuturas = citasSnapshot.docs
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data(),
                        fechaObj: doc.data().fechaHora?.toDate?.() || new Date(doc.data().fecha + 'T' + doc.data().hora)
                    }))
                    .filter(cita => cita.fechaObj > ahora)
                    .sort((a, b) => a.fechaObj - b.fechaObj)
                    .slice(0, 5); // Mostrar solo las pr√≥ximas 5
                
                // Mostrar citas en el expediente
                const citasDiv = document.getElementById('exp-citas');
                if (citasDiv) {
                    if (citasFuturas.length === 0) {
                        citasDiv.innerHTML = '<p class="text-gray-500 text-sm italic">Sin citas pr√≥ximas</p>';
                    } else {
                        citasDiv.innerHTML = citasFuturas.map(cita => {
                            const fechaFormato = cita.fechaObj.toLocaleDateString('es-MX', { 
                                month: 'short', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            const estadoColor = cita.estado === 'confirmada' ? 'green' : 'yellow';
                            const estadoIcon = cita.estado === 'confirmada' ? '‚úì' : '?';
                            
                            return `
                                <div class="border-l-4 border-blue-600 pl-3 py-2 bg-blue-50 rounded p-2">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-bold text-gray-900 text-sm">${cita.tipo === 'consulta-general' ? 'Consulta General' : cita.tipo.replace('-', ' ').toUpperCase()}</p>
                                            <p class="text-xs text-gray-600">${fechaFormato}</p>
                                            <p class="text-xs text-gray-500">${cita.duracion || 30} minutos</p>
                                        </div>
                                        <span class="text-xs font-bold bg-${estadoColor}-100 text-${estadoColor}-700 px-2 py-1 rounded">${estadoIcon} ${cita.estado}</span>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
                
                console.log('‚úÖ Citas cargadas:', citasFuturas.length);
                
            } catch (error) {
                console.error('Error cargando citas:', error);
            }
        }
        
        // Guardar signos vitales
        const vitalesForm = document.getElementById('vitales-form');
        console.log('Formulario de vitales encontrado:', !!vitalesForm);
        
        if (vitalesForm) {
            vitalesForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Guardando signos vitales...');
                console.log('Rol actual:', currentRole);
                console.log('ID paciente actual:', currentPatientId);
                console.log('ID usuario:', currentUser?.uid);
                
                try {
                    const altura = document.getElementById('altura').value;
                    const peso = document.getElementById('peso').value;
                    const temperatura = document.getElementById('temperatura').value;
                    const presionSistolica = document.getElementById('presion-sistolica').value;
                    const presionDiastolica = document.getElementById('presion-diastolica').value;
                    
                    console.log('Valores le√≠dos:', { altura, peso, temperatura, presionSistolica, presionDiastolica });
                    
                    // Validar que los campos requeridos est√©n completos
                    if (!altura || !peso || !temperatura) {
                        alert('‚ö†Ô∏è Por favor completa todos los campos requeridos (Altura, Peso, Temperatura)');
                        return;
                    }
                    
                    // Determinar qu√© ID usar: si es m√©dico, usar el paciente; si es paciente, usar su propio ID
                    const patientIdToUpdate = currentRole === 'medico' ? currentPatientId : currentUser.uid;
                    
                    console.log('ID a actualizar:', patientIdToUpdate);
                    
                    if (!patientIdToUpdate) {
                        alert('‚ö†Ô∏è Error: No se identific√≥ el paciente');
                        return;
                    }
                    
                    // Usar set con merge para crear o actualizar el documento
                    await db.collection('patients').doc(patientIdToUpdate).set({
                        altura: parseFloat(altura),
                        peso: parseFloat(peso),
                        temperatura: parseFloat(temperatura),
                        presionSistolica: presionSistolica ? parseFloat(presionSistolica) : null,
                        presionDiastolica: presionDiastolica ? parseFloat(presionDiastolica) : null,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    
                    console.log('‚úÖ Signos vitales guardados en Firestore');
                    alert('‚úÖ Signos vitales guardados correctamente');
                    vitalesForm.reset();
                    
                    // Esperar un poco para que Firestore sincronice
                    setTimeout(() => {
                        switchView('mi-expediente');
                        // Recargar el mismo paciente que se estaba viendo
                        if (currentRole === 'medico' && currentPatientId) {
                            loadPatientRecordById(currentPatientId);
                        } else {
                            loadPatientRecord();
                        }
                    }, 500);
                } catch (error) {
                    console.error('Error guardando signos vitales:', error);
                    alert('‚ùå Error al guardar signos vitales: ' + (error.message || 'Intenta de nuevo'));

                }
            });
        }
        
        // AUTOCOMPLETE CIE-10 (Compatible con ambas interfaces)
        let cie10Timeout;
        
        function setupCIE10Autocomplete(inputId, dropdownId) {
            const inputElement = document.getElementById(inputId);
            if (!inputElement) return;
            
            inputElement.addEventListener('input', async (e) => {
                const searchQuery = e.target.value.trim().toLowerCase();
                const dropdown = document.getElementById(dropdownId);
                
                clearTimeout(cie10Timeout);
                
                if (searchQuery.length === 0) {
                    dropdown.classList.add('hidden');
                    return;
                }
                
                dropdown.innerHTML = '<div class="p-3 text-gray-500 text-sm">üîç Buscando...</div>';
                dropdown.classList.remove('hidden');
                
                cie10Timeout = setTimeout(async () => {
                    try {
                        let allResults = [];
                        
                        const claveResults = await db.collection('cie10')
                            .where('clave', '>=', searchQuery.toUpperCase())
                            .where('clave', '<', searchQuery.toUpperCase() + '\uf8ff')
                            .limit(10)
                            .get();
                        
                        claveResults.forEach(doc => allResults.push(doc.data()));
                        
                        if (allResults.length < 10) {
                            const descResults = await db.collection('cie10')
                                .where('descripcion', '>=', searchQuery.toUpperCase())
                                .where('descripcion', '<', searchQuery.toUpperCase() + '\uf8ff')
                                .limit(10 - allResults.length)
                                .get();
                            
                            descResults.forEach(doc => {
                                if (!allResults.find(r => r.clave === doc.data().clave)) {
                                    allResults.push(doc.data());
                                }
                            });
                        }
                        
                        if (allResults.length === 0) {
                            dropdown.innerHTML = '<div class="p-3 text-gray-500 text-sm">‚ö†Ô∏è No se encontraron resultados</div>';
                            return;
                        }
                        
                        let html = '';
                        allResults.slice(0, 10).forEach(data => {
                            html += `
                                <div class="p-3 border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition"
                                     onclick="selectCIE10('${inputId}', '${data.clave}', '${data.descripcion.replace(/'/g, "\\'")}')">
                                    <div class="font-bold text-gray-900">${data.clave}</div>
                                    <div class="text-sm text-gray-600">${data.descripcion}</div>
                                    <div class="text-xs text-gray-500 mt-1">${data.grupo}</div>
                                </div>
                            `;
                        });
                        dropdown.innerHTML = html;
                    } catch (error) {
                        console.error('Error buscando CIE-10:', error);
                        dropdown.innerHTML = '<div class="p-3 text-red-500 text-sm">‚ùå Error en la b√∫squeda</div>';
                    }
                }, 300);
            });
        }
        
        // Seleccionar resultado de CIE-10
        function selectCIE10(inputId, clave, descripcion) {
            document.getElementById(inputId).value = `${clave} - ${descripcion}`;
            
            // Ocultar dropdown
            const dropdownId = inputId === 'diagnostico-principal' ? 'cie10-dropdown-consulta' : 'cie10-dropdown';
            const dropdown = document.getElementById(dropdownId);
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
        }
        
        // Configurar autocomplete para ambos campos
        setupCIE10Autocomplete('diagnostico-principal', 'cie10-dropdown-consulta');
        setupCIE10Autocomplete('diagnostico', 'cie10-dropdown');
        
        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('cie10-dropdown');
            if (dropdown && !e.target.closest('#diagnostico') && !e.target.closest('#cie10-dropdown')) {
                dropdown.classList.add('hidden');
            }
        });
        
        // Guardar consulta
        // ==================== NUEVA CONSULTA CON TABS ====================
        
        let consultaActual = {
            pacienteId: null,
            historial: [],
            notas: {},
            exploracion: {},
            odontograma: {},
            examen: {},
            diagnostico: {},
            cargos: []
        };

        // ==================== EXPLORACI√ìN TOPOGR√ÅFICA DIN√ÅMICA ====================
        let topographicData = {
            hallazgos: [],
            vistaActual: 'frontal',
            colorSeleccionado: null
        };

        function setTopographicColor(color) {
            topographicData.colorSeleccionado = color;
            const colorNames = {
                'red': 'Rojo (Lesi√≥n)',
                'yellow': 'Amarillo (Edema)',
                'blue': 'Azul (Equimosis)',
                'green': 'Verde (Normal)',
                'purple': 'P√∫rpura (Otro)'
            };
            document.getElementById('color-seleccionado').textContent = colorNames[color];
            
            // Actualizar estilos de botones
            document.querySelectorAll('[onclick*="setTopographicColor"]').forEach(btn => {
                btn.style.boxShadow = 'none';
                btn.style.opacity = '0.7';
            });
            event.target.style.opacity = '1';
            event.target.style.boxShadow = '0 0 0 3px rgba(0,0,0,0.1)';
        }

        function cambiarVistaCuerpo(vista) {
            topographicData.vistaActual = vista;
            
            const svgFrontal = document.getElementById('svg-cuerpo-frontal');
            const svgDorsal = document.getElementById('svg-cuerpo-dorsal');
            const btnFrontal = document.getElementById('btn-vista-frontal');
            const btnDorsal = document.getElementById('btn-vista-dorsal');
            
            if (vista === 'frontal') {
                svgFrontal.classList.remove('hidden');
                svgDorsal.classList.add('hidden');
                btnFrontal.style.backgroundColor = '#1465ff';
                btnFrontal.style.color = 'white';
                btnFrontal.classList.remove('border', 'border-gray-300', 'text-gray-700', 'hover:bg-gray-50');
                btnDorsal.style.backgroundColor = 'transparent';
                btnDorsal.style.color = '#666';
                btnDorsal.classList.add('border', 'border-gray-300', 'text-gray-700', 'hover:bg-gray-50');
            } else {
                svgFrontal.classList.add('hidden');
                svgDorsal.classList.remove('hidden');
                btnFrontal.style.backgroundColor = 'transparent';
                btnFrontal.style.color = '#666';
                btnFrontal.classList.add('border', 'border-gray-300', 'text-gray-700', 'hover:bg-gray-50');
                btnDorsal.style.backgroundColor = '#1465ff';
                btnDorsal.style.color = 'white';
                btnDorsal.classList.remove('border', 'border-gray-300', 'text-gray-700', 'hover:bg-gray-50');
            }
        }

        function agregarHallazgoTopografico() {
            if (!topographicData.colorSeleccionado) {
                alert('‚ö†Ô∏è Por favor selecciona un color');
                return;
            }
            
            const descripcion = document.getElementById('topographic-description').value.trim();
            if (!descripcion) {
                alert('‚ö†Ô∏è Por favor ingresa una descripci√≥n');
                return;
            }
            
            const hallazgo = {
                id: Date.now(),
                color: topographicData.colorSeleccionado,
                descripcion: descripcion,
                vista: topographicData.vistaActual,
                timestamp: new Date()
            };
            
            topographicData.hallazgos.push(hallazgo);
            actualizarListaHallazgos();
            
            // Limpiar campos
            document.getElementById('topographic-description').value = '';
            topographicData.colorSeleccionado = null;
            document.getElementById('color-seleccionado').textContent = 'Ninguno';
        }

        function actualizarListaHallazgos() {
            const listContainer = document.getElementById('hallazgos-list');
            
            if (topographicData.hallazgos.length === 0) {
                listContainer.innerHTML = '<p class="text-xs text-gray-400 italic">Sin hallazgos a√∫n</p>';
                return;
            }
            
            const colorNames = {
                'red': 'Lesi√≥n',
                'yellow': 'Edema',
                'blue': 'Equimosis',
                'green': 'Normal',
                'purple': 'Otro'
            };
            
            listContainer.innerHTML = topographicData.hallazgos.map(h => `
                <div class="flex items-start gap-2 p-2 bg-gray-50 rounded border-l-4" style="border-left-color: ${getColorCSS(h.color)};">
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold text-gray-700">${colorNames[h.color]} (${h.vista})</p>
                        <p class="text-xs text-gray-600 break-words">${h.descripcion}</p>
                    </div>
                    <button type="button" onclick="eliminarHallazgo(${h.id})" class="text-red-500 hover:text-red-700 flex-shrink-0">
                        <i class="fa-solid fa-trash text-sm"></i>
                    </button>
                </div>
            `).join('');
        }

        function getColorCSS(color) {
            const colors = {
                'red': '#ef4444',
                'yellow': '#facc15',
                'blue': '#3b82f6',
                'green': '#22c55e',
                'purple': '#a855f7'
            };
            return colors[color] || '#999';
        }

        function eliminarHallazgo(id) {
            topographicData.hallazgos = topographicData.hallazgos.filter(h => h.id !== id);
            actualizarListaHallazgos();
        }

        function limpiarTopografico() {
            if (topographicData.hallazgos.length === 0) {
                alert('‚ö†Ô∏è No hay hallazgos para limpiar');
                return;
            }
            
            if (confirm('¬øEst√° seguro de que desea limpiar todos los hallazgos?')) {
                topographicData.hallazgos = [];
                actualizarListaHallazgos();
                document.getElementById('topographic-description').value = '';
                topographicData.colorSeleccionado = null;
                document.getElementById('color-seleccionado').textContent = 'Ninguno';
                limpiarMarcasZonas();
            }
        }

        // Inicializar SVG clickeable
        function inicializarSVGClickeable() {
            const zonas = [
                'zona-head', 'zona-neck', 'zona-chest', 'zona-abdomen',
                'zona-left-arm', 'zona-right-arm', 'zona-left-leg', 'zona-right-leg',
                'zona-head-back', 'zona-neck-back', 'zona-back', 'zona-buttocks',
                'zona-left-arm-back', 'zona-right-arm-back', 'zona-left-leg-back', 'zona-right-leg-back'
            ];
            
            zonas.forEach(zonaId => {
                const elemento = document.getElementById(zonaId);
                if (elemento) {
                    elemento.addEventListener('click', (e) => marcarZona(zonaId, e));
                    elemento.addEventListener('mouseenter', () => {
                        elemento.style.strokeWidth = '3';
                    });
                    elemento.addEventListener('mouseleave', () => {
                        const hasColor = topographicData.zonasMarcadas && topographicData.zonasMarcadas[zonaId];
                        elemento.style.strokeWidth = hasColor ? '3' : '2';
                    });
                }
            });
        }

        // Inicializar objeto de zonas marcadas si no existe
        if (!topographicData.zonasMarcadas) {
            topographicData.zonasMarcadas = {};
        }

        function marcarZona(zonaId, event) {
            if (!topographicData.colorSeleccionado) {
                alert('‚ö†Ô∏è Por favor selecciona un color primero');
                return;
            }
            
            const elemento = event.target;
            const color = topographicData.colorSeleccionado;
            const colorCSS = getColorCSS(color);
            
            // Marcar la zona
            elemento.setAttribute('fill', colorCSS);
            elemento.setAttribute('fill-opacity', '0.6');
            elemento.setAttribute('stroke', colorCSS);
            elemento.setAttribute('stroke-width', '3');
            
            // Guardar en data
            topographicData.zonasMarcadas[zonaId] = {
                color: color,
                timestamp: new Date()
            };
            
            // Auto-generar descripci√≥n si est√° vac√≠o
            if (!document.getElementById('topographic-description').value) {
                const nombreZona = zonaId.replace('zona-', '').replace(/-/g, ' ');
                document.getElementById('topographic-description').value = `Hallazgo en ${nombreZona}`;
            }
        }

        function limpiarMarcasZonas() {
            const zonas = [
                'zona-head', 'zona-neck', 'zona-chest', 'zona-abdomen',
                'zona-left-arm', 'zona-right-arm', 'zona-left-leg', 'zona-right-leg',
                'zona-head-back', 'zona-neck-back', 'zona-back', 'zona-buttocks',
                'zona-left-arm-back', 'zona-right-arm-back', 'zona-left-leg-back', 'zona-right-leg-back'
            ];
            
            zonas.forEach(zonaId => {
                const elemento = document.getElementById(zonaId);
                if (elemento) {
                    elemento.setAttribute('fill', 'none');
                    elemento.setAttribute('stroke', '#999');
                    elemento.setAttribute('stroke-width', '2');
                }
            });
            
            topographicData.zonasMarcadas = {};
        }

        // Guardar exploraci√≥n topogr√°fica en consulta
        function guardarExploracionTopografica() {
            if (topographicData.hallazgos.length === 0 && Object.keys(topographicData.zonasMarcadas || {}).length === 0) {
                return;
            }
            
            consultaActual.exploracion = {
                hallazgos: topographicData.hallazgos,
                zonasMarcadas: topographicData.zonasMarcadas,
                timestamp: new Date()
            };
        }

        // Exportar PDF de exploraci√≥n topogr√°fica
        async function exportarExplotacionPDF() {
            if (topographicData.hallazgos.length === 0 && Object.keys(topographicData.zonasMarcadas || {}).length === 0) {
                alert('‚ö†Ô∏è No hay datos de exploraci√≥n para exportar');
                return;
            }
            
            try {
                // Crear elemento para el PDF
                const pdfContent = document.createElement('div');
                pdfContent.style.padding = '20px';
                pdfContent.style.backgroundColor = 'white';
                pdfContent.style.fontFamily = 'Arial, sans-serif';
                
                // Header
                const header = document.createElement('h1');
                header.textContent = 'Exploraci√≥n Topogr√°fica';
                header.style.fontSize = '24px';
                header.style.marginBottom = '10px';
                pdfContent.appendChild(header);
                
                const subheader = document.createElement('p');
                subheader.textContent = `Fecha: ${new Date().toLocaleDateString('es-MX')} - ${new Date().toLocaleTimeString('es-MX')}`;
                subheader.style.fontSize = '12px';
                subheader.style.color = '#666';
                subheader.style.marginBottom = '20px';
                pdfContent.appendChild(subheader);
                
                // SVG (captura de pantalla)
                const svgContainer = document.createElement('div');
                svgContainer.style.marginBottom = '20px';
                svgContainer.style.textAlign = 'center';
                
                const svgActual = topographicData.vistaActual === 'frontal' 
                    ? document.getElementById('svg-cuerpo-frontal') 
                    : document.getElementById('svg-cuerpo-dorsal');
                
                if (svgActual && !svgActual.classList.contains('hidden')) {
                    const svgClone = svgActual.cloneNode(true);
                    svgClone.style.width = '200px';
                    svgClone.style.height = 'auto';
                    svgContainer.appendChild(svgClone);
                }
                
                const vistaLabel = document.createElement('p');
                vistaLabel.textContent = `Vista: ${topographicData.vistaActual === 'frontal' ? 'Frontal' : 'Dorsal'}`;
                vistaLabel.style.fontSize = '12px';
                vistaLabel.style.color = '#666';
                svgContainer.appendChild(vistaLabel);
                pdfContent.appendChild(svgContainer);
                
                // Hallazgos
                const hallazgosTitle = document.createElement('h2');
                hallazgosTitle.textContent = 'Hallazgos Registrados';
                hallazgosTitle.style.fontSize = '16px';
                hallazgosTitle.style.marginTop = '20px';
                hallazgosTitle.style.marginBottom = '10px';
                pdfContent.appendChild(hallazgosTitle);
                
                const colorNames = {
                    'red': 'Lesi√≥n',
                    'yellow': 'Edema',
                    'blue': 'Equimosis',
                    'green': 'Normal',
                    'purple': 'Otro'
                };
                
                topographicData.hallazgos.forEach((h, index) => {
                    const hallazgoDiv = document.createElement('div');
                    hallazgoDiv.style.marginBottom = '15px';
                    hallazgoDiv.style.padding = '10px';
                    hallazgoDiv.style.borderLeft = `4px solid ${getColorCSS(h.color)}`;
                    hallazgoDiv.style.backgroundColor = '#f9f9f9';
                    
                    const titulo = document.createElement('p');
                    titulo.textContent = `${index + 1}. ${colorNames[h.color]} (${h.vista})`;
                    titulo.style.fontWeight = 'bold';
                    titulo.style.fontSize = '12px';
                    titulo.style.margin = '0 0 5px 0';
                    hallazgoDiv.appendChild(titulo);
                    
                    const desc = document.createElement('p');
                    desc.textContent = h.descripcion;
                    desc.style.fontSize = '11px';
                    desc.style.margin = '0';
                    desc.style.color = '#333';
                    hallazgoDiv.appendChild(desc);
                    
                    pdfContent.appendChild(hallazgoDiv);
                });
                
                // Usar html2pdf (agregar librer√≠a en el head si no est√°)
                if (typeof html2pdf === 'undefined') {
                    // Cargar html2pdf din√°micamente
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                    script.onload = () => {
                        const opt = {
                            margin: 10,
                            filename: `Exploracion_Topografica_${new Date().toISOString().slice(0,10)}.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2 },
                            jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
                        };
                        html2pdf().set(opt).from(pdfContent).save();
                    };
                    document.head.appendChild(script);
                } else {
                    const opt = {
                        margin: 10,
                        filename: `Exploracion_Topografica_${new Date().toISOString().slice(0,10)}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
                    };
                    html2pdf().set(opt).from(pdfContent).save();
                }
                
                alert('‚úÖ PDF generado correctamente');
            } catch (error) {
                console.error('Error generando PDF:', error);
                alert('‚ùå Error al generar PDF: ' + error.message);
            }
        }

        // ==================== ODONTOGRAMA PROFESIONAL CON CARAS DENTALES ====================
        let odontogramaData = {
            tipoDenticion: 'adulto',
            piezaSeleccionada: null,
            caraSeleccionada: null,
            procedimientos: [], // Array de {diagnostico, procedimiento, pieza, cara, comentarios}
            carasPorPieza: {} // {pieza: {V, O, L, M, D}}
        };

        // Mapa de colores para procedimientos
        const COLORES_PROCEDIMIENTOS = {
            'Profil√°ctico': '#e0f7fa',
            'Restauraci√≥n con Resina': '#c8e6c9',
            'Restauraci√≥n con Amalgama': '#d7ccc8',
            'Sellador': '#fff9c4',
            'Extracci√≥n': '#ffccbc',
            'Curetaje': '#f8bbd0',
            'Alargamiento de Corona': '#ffe0b2',
            'Recubrimiento Gingival': '#c5e1a5',
            'Coronas/Puentes': '#b3e5fc',
            'Implante': '#d1c4e9',
            'Endodoncia': '#ffcccc'
        };

        // Dientes adulto ISO 1992
        const DIENTES_ADULTO = [
            {id: '18', num: '18'}, {id: '17', num: '17'}, {id: '16', num: '16'}, {id: '15', num: '15'},
            {id: '14', num: '14'}, {id: '13', num: '13'}, {id: '12', num: '12'}, {id: '11', num: '11'},
            {id: '21', num: '21'}, {id: '22', num: '22'}, {id: '23', num: '23'}, {id: '24', num: '24'},
            {id: '25', num: '25'}, {id: '26', num: '26'}, {id: '27', num: '27'}, {id: '28', num: '28'},
            {id: '38', num: '38'}, {id: '37', num: '37'}, {id: '36', num: '36'}, {id: '35', num: '35'},
            {id: '34', num: '34'}, {id: '33', num: '33'}, {id: '32', num: '32'}, {id: '31', num: '31'},
            {id: '41', num: '41'}, {id: '42', num: '42'}, {id: '43', num: '43'}, {id: '44', num: '44'},
            {id: '45', num: '45'}, {id: '46', num: '46'}, {id: '47', num: '47'}, {id: '48', num: '48'}
        ];

        const DIENTES_INFANTIL = [
            {id: '55', num: '55'}, {id: '54', num: '54'}, {id: '53', num: '53'}, {id: '52', num: '52'},
            {id: '51', num: '51'}, {id: '61', num: '61'}, {id: '62', num: '62'}, {id: '63', num: '63'},
            {id: '64', num: '64'}, {id: '65', num: '65'}, {id: '85', num: '85'}, {id: '84', num: '84'},
            {id: '83', num: '83'}, {id: '82', num: '82'}, {id: '81', num: '81'}, {id: '71', num: '71'},
            {id: '72', num: '72'}, {id: '73', num: '73'}, {id: '74', num: '74'}, {id: '75', num: '75'}
        ];

        // Caras dentales: V (Vestibular), O (Oclusal), L (Lingual), M (Mesial), D (Distal)
        const CARAS = ['V', 'O', 'L', 'M', 'D'];
        const CARAS_NOMBRES = {
            'V': 'Vestibular',
            'O': 'Oclusal',
            'L': 'Lingual/Palatina',
            'M': 'Mesial',
            'D': 'Distal'
        };

        function cambiarTipoDenticion(tipo) {
            odontogramaData.tipoDenticion = tipo;
            odontogramaData.piezaSeleccionada = null;
            odontogramaData.caraSeleccionada = null;
            renderizarOdontograma();
            actualizarSeleccion();
        }

        function renderizarOdontograma() {
            const dientes = odontogramaData.tipoDenticion === 'adulto' ? DIENTES_ADULTO : DIENTES_INFANTIL;
            const arcadaSuperior = document.getElementById('arcada-superior');
            const arcadaInferior = document.getElementById('arcada-inferior');
            
            arcadaSuperior.innerHTML = '';
            arcadaInferior.innerHTML = '';

            dientes.forEach(diente => {
                const container = document.createElement('div');
                container.className = 'flex flex-col items-center';
                
                // N√∫mero de pieza
                const numeroDiv = document.createElement('div');
                numeroDiv.className = 'text-xs font-bold text-gray-600 mb-1';
                numeroDiv.textContent = diente.num;
                container.appendChild(numeroDiv);
                
                // Diente con 5 caras (dividido en 5 secciones)
                const dienteDiv = document.createElement('div');
                dienteDiv.className = 'relative w-8 h-8 border-2 border-gray-400 rounded';
                dienteDiv.style.display = 'grid';
                dienteDiv.style.gridTemplateColumns = '1fr 1fr';
                dienteDiv.style.gridTemplateRows = 'auto 1fr 1fr';
                dienteDiv.style.gap = '1px';
                dienteDiv.style.backgroundColor = '#f3f4f6';
                
                // O (Oclusal) - arriba centro
                const oclusales = document.createElement('button');
                oclusales.className = 'col-span-2 text-xs text-gray-700 hover:opacity-80 border border-gray-300 rounded-t';
                oclusales.textContent = 'O';
                oclusales.onclick = () => seleccionarCara(diente.num, 'O');
                oclusales.style.backgroundColor = obteneditorColorCara(diente.num, 'O');
                dienteDiv.appendChild(oclusales);
                
                // M (Mesial) - izquierda
                const mesial = document.createElement('button');
                mesial.className = 'text-xs text-gray-700 hover:opacity-80 border border-gray-300';
                mesial.textContent = 'M';
                mesial.onclick = () => seleccionarCara(diente.num, 'M');
                mesial.style.backgroundColor = obteneditorColorCara(diente.num, 'M');
                dienteDiv.appendChild(mesial);
                
                // D (Distal) - derecha
                const distal = document.createElement('button');
                distal.className = 'text-xs text-gray-700 hover:opacity-80 border border-gray-300';
                distal.textContent = 'D';
                distal.onclick = () => seleccionarCara(diente.num, 'D');
                distal.style.backgroundColor = obteneditorColorCara(diente.num, 'D');
                dienteDiv.appendChild(distal);
                
                // V (Vestibular) - abajo izquierda
                const vestibular = document.createElement('button');
                vestibular.className = 'text-xs text-gray-700 hover:opacity-80 border border-gray-300 rounded-bl';
                vestibular.textContent = 'V';
                vestibular.onclick = () => seleccionarCara(diente.num, 'V');
                vestibular.style.backgroundColor = obteneditorColorCara(diente.num, 'V');
                dienteDiv.appendChild(vestibular);
                
                // L (Lingual) - abajo derecha
                const lingual = document.createElement('button');
                lingual.className = 'text-xs text-gray-700 hover:opacity-80 border border-gray-300 rounded-br';
                lingual.textContent = 'L';
                lingual.onclick = () => seleccionarCara(diente.num, 'L');
                lingual.style.backgroundColor = obteneditorColorCara(diente.num, 'L');
                dienteDiv.appendChild(lingual);
                
                // Click en el diente selecciona la pieza
                dienteDiv.onclick = (e) => {
                    if (e.target === dienteDiv) {
                        seleccionarPieza(diente.num);
                    }
                };
                dienteDiv.style.cursor = 'pointer';
                
                container.appendChild(dienteDiv);
                
                // Agregar a la arcada correspondiente
                const esInferior = diente.num.startsWith('3') || diente.num.startsWith('4');
                if (esInferior) {
                    arcadaInferior.appendChild(container);
                } else {
                    arcadaSuperior.appendChild(container);
                }
            });
        }

        function obteneditorColorCara(pieza, cara) {
            // Buscar si existe un procedimiento para esta pieza y cara
            const procedimiento = odontogramaData.procedimientos.find(
                p => p.pieza === pieza && p.cara === cara
            );
            
            if (procedimiento) {
                return COLORES_PROCEDIMIENTOS[procedimiento.procedimiento] || '#e0e7ff';
            }
            
            return 'white';
        }

        function seleccionarPieza(pieza) {
            odontogramaData.piezaSeleccionada = pieza;
            actualizarSeleccion();
        }

        function seleccionarCara(pieza, cara) {
            odontogramaData.piezaSeleccionada = pieza;
            odontogramaData.caraSeleccionada = cara;
            actualizarSeleccion();
        }

        function actualizarSeleccion() {
            document.getElementById('pieza-seleccionada').textContent = odontogramaData.piezaSeleccionada || 'Ninguna';
            document.getElementById('cara-seleccionada').textContent = odontogramaData.caraSeleccionada ? CARAS_NOMBRES[odontogramaData.caraSeleccionada] : 'Ninguna';
        }

        function agregarProcedimientoDental() {
            if (!odontogramaData.piezaSeleccionada) {
                alert('‚ö†Ô∏è Por favor selecciona una pieza dental');
                return;
            }
            
            if (!odontogramaData.caraSeleccionada) {
                alert('‚ö†Ô∏è Por favor selecciona una cara (V, O, L, M, D)');
                return;
            }
            
            const diagnostico = document.getElementById('diagnostico-proc').value.trim();
            if (!diagnostico) {
                alert('‚ö†Ô∏è Por favor ingresa un diagn√≥stico');
                return;
            }
            
            const procedimiento = document.getElementById('procedimiento-select').value;
            if (!procedimiento) {
                alert('‚ö†Ô∏è Por favor selecciona un procedimiento');
                return;
            }
            
            // Agregar procedimiento
            const nuevoProc = {
                id: Date.now(),
                diagnostico: diagnostico,
                procedimiento: procedimiento,
                pieza: odontogramaData.piezaSeleccionada,
                cara: odontogramaData.caraSeleccionada,
                comentarios: ''
            };
            
            odontogramaData.procedimientos.push(nuevoProc);
            
            // Limpiar formulario
            document.getElementById('diagnostico-proc').value = '';
            document.getElementById('procedimiento-select').value = '';
            
            // Actualizar vistas
            renderizarOdontograma();
            actualizarTablaProcedimientos();
        }

        function actualizarTablaProcedimientos() {
            const tbody = document.getElementById('procedimientos-tbody');
            
            if (odontogramaData.procedimientos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-center text-gray-500">Sin procedimientos registrados</td></tr>';
                return;
            }
            
            tbody.innerHTML = odontogramaData.procedimientos.map(proc => `
                <tr class="border-t border-gray-200 hover:bg-gray-50">
                    <td class="px-3 py-2 text-gray-700">${proc.diagnostico}</td>
                    <td class="px-3 py-2 text-gray-700">${proc.procedimiento}</td>
                    <td class="px-3 py-2 text-center font-bold text-gray-900">${proc.pieza}</td>
                    <td class="px-3 py-2 text-center"><span class="bg-gray-200 px-2 py-1 rounded text-xs">${CARAS_NOMBRES[proc.cara]}</span></td>
                    <td class="px-3 py-2 text-center space-x-1">
                        <button type="button" onclick="editarProcedimiento(${proc.id})" class="text-blue-600 hover:text-blue-900 text-xs" title="Comentarios">
                            <i class="fa-solid fa-comment"></i>
                        </button>
                        <button type="button" onclick="eliminarProcedimiento(${proc.id})" class="text-red-600 hover:text-red-900 text-xs" title="Eliminar">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function editarProcedimiento(procId) {
            const proc = odontogramaData.procedimientos.find(p => p.id === procId);
            if (!proc) return;
            
            const nuevoComentario = prompt('Agregar comentarios:', proc.comentarios);
            if (nuevoComentario !== null) {
                proc.comentarios = nuevoComentario;
                actualizarTablaProcedimientos();
            }
        }

        function eliminarProcedimiento(procId) {
            if (confirm('¬øEliminar este procedimiento?')) {
                odontogramaData.procedimientos = odontogramaData.procedimientos.filter(p => p.id !== procId);
                renderizarOdontograma();
                actualizarTablaProcedimientos();
            }
        }

        function limpiarOdontograma() {
            if (odontogramaData.procedimientos.length === 0) {
                alert('‚ö†Ô∏è No hay datos para limpiar');
                return;
            }
            
            if (confirm('¬øLimpiar todo el odontograma?')) {
                odontogramaData.procedimientos = [];
                odontogramaData.piezaSeleccionada = null;
                odontogramaData.caraSeleccionada = null;
                document.getElementById('diagnostico-dental').value = '';
                document.getElementById('diagnostico-proc').value = '';
                document.getElementById('procedimiento-select').value = '';
                renderizarOdontograma();
                actualizarTablaProcedimientos();
                actualizarSeleccion();
            }
        }

        function exportarOdontogramaPDF() {
            if (odontogramaData.procedimientos.length === 0) {
                alert('‚ö†Ô∏è Sin procedimientos para exportar');
                return;
            }
            
            try {
                const pdfContent = document.createElement('div');
                pdfContent.style.padding = '20px';
                pdfContent.style.fontFamily = 'Arial, sans-serif';
                
                const title = document.createElement('h1');
                title.textContent = 'Odontograma';
                title.style.marginBottom = '10px';
                pdfContent.appendChild(title);
                
                const fecha = document.createElement('p');
                fecha.textContent = `Fecha: ${new Date().toLocaleDateString('es-MX')}`;
                fecha.style.color = '#666';
                fecha.style.marginBottom = '20px';
                pdfContent.appendChild(fecha);
                
                // Tabla de procedimientos
                const tableHTML = `
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <tr style="background-color: #f3f4f6; border-bottom: 2px solid #d1d5db;">
                            <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left; font-weight: bold;">Diagn√≥stico</th>
                            <th style="border: 1px solid #d1d5db; padding: 8px; text-align: left; font-weight: bold;">Procedimiento</th>
                            <th style="border: 1px solid #d1d5db; padding: 8px; text-align: center; font-weight: bold;">Pieza</th>
                            <th style="border: 1px solid #d1d5db; padding: 8px; text-align: center; font-weight: bold;">Cara</th>
                        </tr>
                        ${odontogramaData.procedimientos.map(p => `
                            <tr>
                                <td style="border: 1px solid #d1d5db; padding: 8px;">${p.diagnostico}</td>
                                <td style="border: 1px solid #d1d5db; padding: 8px;">${p.procedimiento}</td>
                                <td style="border: 1px solid #d1d5db; padding: 8px; text-align: center; font-weight: bold;">${p.pieza}</td>
                                <td style="border: 1px solid #d1d5db; padding: 8px; text-align: center;">${CARAS_NOMBRES[p.cara]}</td>
                            </tr>
                        `).join('')}
                    </table>
                `;
                pdfContent.innerHTML += tableHTML;
                
                const diagnostico = document.getElementById('diagnostico-dental').value;
                if (diagnostico) {
                    const diagDiv = document.createElement('div');
                    diagDiv.innerHTML = `<strong>Diagn√≥stico General:</strong><p>${diagnostico}</p>`;
                    pdfContent.appendChild(diagDiv);
                }
                
                if (typeof html2pdf === 'undefined') {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                    script.onload = () => {
                        const opt = {
                            margin: 10,
                            filename: `Odontograma_${new Date().toISOString().slice(0,10)}.pdf`,
                            image: { type: 'jpeg', quality: 0.98 },
                            html2canvas: { scale: 2 },
                            jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
                        };
                        html2pdf().set(opt).from(pdfContent).save();
                    };
                    document.head.appendChild(script);
                } else {
                    const opt = {
                        margin: 10,
                        filename: `Odontograma_${new Date().toISOString().slice(0,10)}.pdf`,
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
                    };
                    html2pdf().set(opt).from(pdfContent).save();
                }
                
                alert('‚úÖ PDF generado');
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        function inicializarOdontograma() {
            renderizarOdontograma();
            actualizarSeleccion();
            actualizarTablaProcedimientos();
        }
        
        // Cambiar tab
        function cambiarTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Mostrar tab seleccionado
            const tabElement = document.getElementById(`tab-${tabName}`);
            if (tabElement) {
                tabElement.classList.remove('hidden');
            }
            
            // Actualizar botones
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('text-blue-600', 'border-blue-600');
                btn.classList.add('text-gray-600', 'border-transparent');
            });
            
            event.target.closest('.tab-btn').classList.add('text-blue-600', 'border-blue-600');
            
            // Cargar contenido si es historial
            if (tabName === 'historial' && consultaActual.pacienteId) {
                cargarHistorialConsultas(consultaActual.pacienteId);
            }
        }
        
        // Actualizar nombre del paciente en la cabecera
        function actualizarNombrePaciente() {
            const select = document.getElementById('select-paciente-consulta');
            const pacienteId = select.value;
            const nombreElement = document.getElementById('consulta-paciente-nombre');
            
            if (pacienteId) {
                db.collection('patients').doc(pacienteId).get().then(doc => {
                    if (doc.exists) {
                        const p = doc.data();
                        nombreElement.textContent = `${p.nombre} ${p.apellido} ‚Ä¢ ${p.cedula}`;
                        consultaActual.pacienteId = pacienteId;
                    }
                });
            } else {
                nombreElement.textContent = 'Selecciona un paciente';
            }
        }
        
        // Cargar historial de consultas
        async function cargarHistorialConsultas(pacienteId) {
            try {
                const snapshot = await db.collection('patients').doc(pacienteId)
                    .collection('consultations').orderBy('createdAt', 'desc').limit(10).get();
                
                const historialDiv = document.getElementById('historial-consultas');
                if (snapshot.empty) {
                    historialDiv.innerHTML = '<p class="text-gray-500 text-sm italic">Sin consultas previas</p>';
                    return;
                }
                
                historialDiv.innerHTML = snapshot.docs.map(doc => {
                    const c = doc.data();
                    const fecha = c.createdAt?.toDate().toLocaleDateString('es-MX', { 
                        year: 'numeric', month: 'long', day: 'numeric' 
                    }) || 'Sin fecha';
                    
                    return `
                        <div class="border-l-4 border-blue-600 pl-4 py-3 bg-blue-50 rounded">
                            <p class="font-bold text-gray-900">${c.diagnostico}</p>
                            <p class="text-xs text-gray-500 mt-1">${fecha}</p>
                            <p class="text-sm text-gray-700 mt-2">${c.sintomas}</p>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error cargando historial:', error);
            }
        }
        
        // Guardar consulta completa
        async function guardarConsultaCompleta() {
            const pacienteId = document.getElementById('select-paciente-consulta').value;
            
            if (!pacienteId) {
                alert('Por favor selecciona un paciente');
                return;
            }
            
            // Validar m√≠nimamente que haya diagn√≥stico
            const diagnosticoPrincipal = document.getElementById('diagnostico-principal').value;
            if (!diagnosticoPrincipal) {
                alert('Por favor agrega un diagn√≥stico principal');
                return;
            }
            
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Guardando...';
                
                // Guardar exploraci√≥n topogr√°fica en consultaActual
                guardarExploracionTopografica();
                
                // Recopilar toda la informaci√≥n
                const consultaData = {
                    // Informaci√≥n b√°sica
                    pacienteId: pacienteId,
                    doctorId: currentUser.uid,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    
                    // Notas de Padecimiento
                    motivoConsulta: document.getElementById('motivo-consulta').value,
                    notasClinicas: document.getElementById('notas-clinicas').value,
                    
                    // Exploraci√≥n Topogr√°fica Din√°mica
                    exploracionTopografica: consultaActual.exploracion,
                    
                    // Odontograma Din√°mico
                    odontograma: {
                        tipoDenticion: odontogramaData.tipoDenticion,
                        dientes: odontogramaData.dientes,
                        diagnostico: document.getElementById('diagnostico-dental').value,
                        timestamp: new Date()
                    },
                    
                    // Examen F√≠sico
                    examenFisico: {
                        fc: document.getElementById('fc').value,
                        fr: document.getElementById('fr').value,
                        spo2: document.getElementById('spo2').value,
                        o2Suplementario: document.getElementById('o2-suplementario').value,
                        resumen: document.getElementById('resumen-examen').value
                    },
                    
                    // Diagn√≥stico y Tratamiento
                    diagnosticoPrincipal: diagnosticoPrincipal,
                    planTratamiento: document.getElementById('plan-tratamiento').value,
                    
                    // Cargos
                    cargos: consultaActual.cargos
                };
                
                // Guardar en Firestore
                await db.collection('patients').doc(pacienteId).collection('consultations').doc().set(consultaData);
                
                alert('‚úÖ Consulta completa guardada correctamente');
                
                // Resetear formulario
                limpiarFormularioConsulta();
                switchView('mis-pacientes');
                loadMedicoPatients();
                
            } catch (error) {
                console.error('Error guardando consulta:', error);
                alert('Error al guardar la consulta: ' + error.message);
            } finally {
                const btn = event.target;
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Guardar Consulta Completa';
            }
        }
        
        // Limpiar formulario
        function limpiarFormularioConsulta() {
            document.querySelectorAll('#nueva-consulta input[type="text"], #nueva-consulta input[type="number"], #nueva-consulta textarea, #nueva-consulta select').forEach(el => {
                if (el.id !== 'select-paciente-consulta') {
                    el.value = '';
                }
            });
            consultaActual = {
                pacienteId: null,
                historial: [],
                notas: {},
                exploracion: {},
                odontograma: {},
                examen: {},
                diagnostico: {},
                cargos: []
            };
        }
        
        // Cargar pacientes en select de Nueva Consulta (almacenarlos para b√∫squeda inteligente)
        let pacientesConsultaCache = [];
        
        function cargarPacientesConsulta() {
            if (currentRole !== 'medico') return;
            
            db.collection('patients')
                .where('assignedDoctor', '==', currentUser.uid)
                .get()
                .then(snapshot => {
                    pacientesConsultaCache = [];
                    snapshot.forEach(doc => {
                        pacientesConsultaCache.push({
                            id: doc.id,
                            nombre: doc.data().nombre || '',
                            apellido: doc.data().apellido || '',
                            cedula: doc.data().cedula || '',
                            email: doc.data().email || '',
                            curp: doc.data().curp || '',
                            telefono: doc.data().telefono || ''
                        });
                    });
                });
        }
        
        // B√∫squeda inteligente de pacientes en Nueva Consulta
        function buscarPacienteConsulta() {
            const termino = document.getElementById('buscar-paciente-consulta').value.toLowerCase().trim();
            const contenedor = document.getElementById('resultados-pacientes-consulta');
            
            if (!termino) {
                contenedor.classList.add('hidden');
                return;
            }
            
            const resultados = pacientesConsultaCache.filter(p => {
                const nombre = `${p.nombre} ${p.apellido}`.toLowerCase();
                const email = p.email.toLowerCase();
                const curp = p.curp.toLowerCase();
                const cedula = p.cedula.toLowerCase();
                
                return nombre.includes(termino) || email.includes(termino) || 
                       curp.includes(termino) || cedula.includes(termino);
            });
            
            if (resultados.length === 0) {
                contenedor.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">No se encontraron pacientes</div>';
                contenedor.classList.remove('hidden');
                return;
            }
            
            contenedor.innerHTML = resultados.map(p => `
                <div class="px-4 py-3 border-b border-gray-200 cursor-pointer hover:bg-blue-50 transition" onclick="seleccionarPacienteConsulta('${p.id}', '${p.nombre} ${p.apellido}', '${p.cedula}', '${p.email}')">
                    <div class="font-bold text-gray-900">${p.nombre} ${p.apellido}</div>
                    <div class="text-xs text-gray-600">CURP: ${p.curp} | Email: ${p.email} | C√©dula: ${p.cedula}</div>
                </div>
            `).join('');
            
            contenedor.classList.remove('hidden');
        }
        
        // Seleccionar paciente de la b√∫squeda
        function seleccionarPacienteConsulta(pacienteId, nombre, cedula, email) {
            document.getElementById('select-paciente-consulta').value = pacienteId;
            document.getElementById('buscar-paciente-consulta').value = nombre;
            document.getElementById('paciente-seleccionado-texto').textContent = `${nombre} (${cedula}) - ${email}`;
            document.getElementById('paciente-seleccionado-info').classList.remove('hidden');
            document.getElementById('resultados-pacientes-consulta').classList.add('hidden');
            actualizarNombrePaciente();
        }
        
        // ==================== B√öSQUEDA Y GESTI√ìN DE CARGOS EN NUEVA CONSULTA ====================
        
        // B√∫squeda de servicios para agregar cargos
        function buscarServiciosCargo() {
            const termino = document.getElementById('buscar-cargo').value.toLowerCase().trim();
            const contenedor = document.getElementById('servicios-disponibles');
            
            if (!termino) {
                contenedor.classList.add('hidden');
                return;
            }
            
            // Filtrar servicios activos que coincidan con la b√∫squeda
            const resultados = productosCache.filter(s => {
                const codigo = s.codigo.toLowerCase();
                const nombre = s.nombre.toLowerCase();
                const categoria = s.categoria.toLowerCase();
                
                return s.activo && (codigo.includes(termino) || nombre.includes(termino) || categoria.includes(termino));
            });
            
            if (resultados.length === 0) {
                contenedor.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">No se encontraron servicios activos</div>';
                contenedor.classList.remove('hidden');
                return;
            }
            
            contenedor.innerHTML = resultados.map(s => `
                <div class="px-4 py-3 border-b border-gray-200 cursor-pointer hover:bg-green-50 transition flex justify-between items-center" onclick="agregarCargo('${s.id}', '${s.nombre}', ${s.precio})">
                    <div>
                        <div class="font-bold text-gray-900">${s.nombre}</div>
                        <div class="text-xs text-gray-600">C√≥digo: ${s.codigo} | Categor√≠a: ${s.categoria}</div>
                    </div>
                    <div class="font-bold text-green-600">$${parseFloat(s.precio).toFixed(2)}</div>
                </div>
            `).join('');
            
            contenedor.classList.remove('hidden');
        }
        
        // Agregar cargo a la consulta
        function agregarCargo(servicioId, nombre, precio) {
            // Agregar a consultaActual.cargos
            if (!consultaActual.cargos) {
                consultaActual.cargos = [];
            }
            
            consultaActual.cargos.push({
                id: Date.now(),
                servicioId: servicioId,
                nombre: nombre,
                precio: precio
            });
            
            // Actualizar lista de cargos
            actualizarListaCargos();
            
            // Limpiar b√∫squeda
            document.getElementById('buscar-cargo').value = '';
            document.getElementById('servicios-disponibles').classList.add('hidden');
        }
        
        // Actualizar lista de cargos mostrados
        function actualizarListaCargos() {
            const lista = document.getElementById('cargos-lista');
            
            if (!consultaActual.cargos || consultaActual.cargos.length === 0) {
                lista.innerHTML = '<p class="text-gray-500 text-sm italic">Sin cargos agregados</p>';
                document.getElementById('total-cargos').textContent = '$0.00';
                return;
            }
            
            let total = 0;
            lista.innerHTML = consultaActual.cargos.map(cargo => {
                total += cargo.precio;
                return `
                    <div class="flex justify-between items-center bg-white p-3 rounded border border-gray-200 hover:shadow-sm transition">
                        <div>
                            <div class="font-bold text-gray-900">${cargo.nombre}</div>
                            <div class="text-xs text-gray-600">ID Servicio: ${cargo.servicioId}</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-blue-600">$${parseFloat(cargo.precio).toFixed(2)}</span>
                            <button type="button" onclick="eliminarCargo(${cargo.id})" class="text-red-600 hover:text-red-900 text-sm">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('total-cargos').textContent = `$${total.toFixed(2)}`;
        }
        
        // Eliminar cargo de la consulta
        function eliminarCargo(cargoId) {
            consultaActual.cargos = consultaActual.cargos.filter(c => c.id !== cargoId);
            actualizarListaCargos();
        }
        
        // ==================== MIS PACIENTES - B√öSQUEDA Y CREACI√ìN ====================
        
        // Filtrar pacientes por b√∫squeda
        function filtrarPacientes() {
            const busqueda = document.getElementById('buscar-pacientes').value.toLowerCase();
            const filas = document.querySelectorAll('#pacientes-tbody tr');
            
            filas.forEach(fila => {
                const texto = fila.textContent.toLowerCase();
                fila.style.display = texto.includes(busqueda) ? '' : 'none';
            });
        }
        
        // Abrir modal Nuevo Paciente
        function abrirModalNuevoPaciente() {
            document.getElementById('modal-nuevo-paciente').classList.remove('hidden');
            limpiarFormularioNuevoPaciente();
        }
        
        // Cerrar modal Nuevo Paciente
        function cerrarModalNuevoPaciente() {
            document.getElementById('modal-nuevo-paciente').classList.add('hidden');
            limpiarFormularioNuevoPaciente();
        }
        
        // Limpiar formulario Nuevo Paciente
        function limpiarFormularioNuevoPaciente() {
            document.getElementById('nuevo-nombre').value = '';
            document.getElementById('nuevo-curp').value = '';
            document.getElementById('nuevo-fecha-nac').value = '';
            document.getElementById('nuevo-edad').value = '';
            document.getElementById('nuevo-email').value = '';
            document.getElementById('nuevo-telefono').value = '';
            document.getElementById('nuevo-sexo').value = '';
            document.getElementById('nuevo-direccion').value = '';
        }

        // Calcular edad desde fecha de nacimiento
        function calcularEdad() {
            const fechaNac = document.getElementById('nuevo-fecha-nac').value;
            if (!fechaNac) {
                document.getElementById('nuevo-edad').value = '';
                return;
            }
            
            const hoy = new Date();
            const nacimiento = new Date(fechaNac);
            let edad = hoy.getFullYear() - nacimiento.getFullYear();
            const mes = hoy.getMonth() - nacimiento.getMonth();
            
            if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
                edad--;
            }
            
            document.getElementById('nuevo-edad').value = edad;
        }
        
        // Guardar Nuevo Paciente
        async function guardarNuevoPaciente() {
            const nombre = document.getElementById('nuevo-nombre').value.trim();
            const curp = document.getElementById('nuevo-curp').value.trim().toUpperCase();
            const fechaNac = document.getElementById('nuevo-fecha-nac').value;
            const email = document.getElementById('nuevo-email').value.trim();
            const telefono = document.getElementById('nuevo-telefono').value.trim();
            const sexo = document.getElementById('nuevo-sexo').value;
            const direccion = document.getElementById('nuevo-direccion').value.trim();
            
            if (!nombre || !curp || !fechaNac || !email || !sexo) {
                alert('Por favor completa los campos requeridos (*)');
                return;
            }
            
            if (curp.length !== 18) {
                alert('El CURP debe tener 18 caracteres');
                return;
            }
            
            if (!email.includes('@')) {
                alert('Por favor ingresa un email v√°lido');
                return;
            }
            
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Guardando...';
                
                const fechaNacimiento = new Date(fechaNac);
                const edad = new Date().getFullYear() - fechaNacimiento.getFullYear();
                
                await db.collection('patients').doc().set({
                    nombre: nombre.split(' ')[0],
                    apellido: nombre.includes(' ') ? nombre.split(' ').slice(1).join(' ') : '',
                    curp: curp,
                    sexo: sexo,
                    edad: edad,
                    email: email,
                    telefono: telefono,
                    direccion: direccion,
                    fechaNacimiento: fechaNacimiento,
                    assignedDoctor: currentUser.uid,
                    createdAt: new Date(),
                    updatedAt: new Date(),
                    antecedentes: {
                        alergias: [],
                        patologicos: [],
                        'no-patologicos': [],
                        heredofamiliares: [],
                        psiquiatricos: [],
                        vacunas: []
                    }
                });
                
                alert('‚úÖ Paciente creado correctamente');
                cerrarModalNuevoPaciente();
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Crear Paciente';
                loadMedicoPatients();
                
            } catch (error) {
                console.error('Error creando paciente:', error);
                alert('Error al crear paciente: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Crear Paciente';
            }
        }
        
        // Abrir modal Importar Excel
        function abrirModalImportarExcel() {
            document.getElementById('modal-importar-excel').classList.remove('hidden');
            document.getElementById('csv-archivo').value = '';
            document.getElementById('csv-preview').classList.add('hidden');
            
            // Agregar listener para previsualizador
            document.getElementById('csv-archivo').addEventListener('change', previsualizarCsv);
        }
        
        // Cerrar modal Importar Excel
        function cerrarModalImportarExcel() {
            document.getElementById('modal-importar-excel').classList.add('hidden');
            document.getElementById('csv-archivo').value = '';
            document.getElementById('csv-preview').classList.add('hidden');
        }
        
        // Previsualizador de CSV
        function previsualizarCsv(event) {
            const archivo = event.target.files[0];
            if (!archivo) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lineas = csv.split('\\n').filter(l => l.trim());
                
                if (lineas.length < 2) {
                    alert('El archivo CSV debe tener encabezados y al menos una fila de datos');
                    return;
                }
                
                const encabezados = lineas[0].split(',').map(h => h.trim());
                const datos = lineas.slice(1, Math.min(6, lineas.length)).map(linea => 
                    linea.split(',').map(d => d.trim())
                );
                
                let html = '<table class="w-full border-collapse">';
                html += '<thead class="bg-gray-200"><tr>' + encabezados.map(h => 
                    `<th class="border border-gray-300 px-3 py-2 text-left font-bold text-xs">${h}</th>`
                ).join('') + '</tr></thead>';
                html += '<tbody>' + datos.map(fila => 
                    '<tr>' + fila.map(d => 
                        `<td class="border border-gray-300 px-3 py-2 text-xs">${d}</td>`
                    ).join('') + '</tr>'
                ).join('') + '</tbody></table>';
                
                document.getElementById('preview-tabla').innerHTML = html;
                document.getElementById('csv-preview').classList.remove('hidden');
            };
            reader.readAsText(archivo);
        }
        
        // Descargar plantilla de ejemplo
        function descargarPlantilla() {
            const plantilla = `nombre,curp,fecha_nacimiento,sexo,email,telefono,direccion
Juan Garc√≠a L√≥pez,GARLO850215HDFLNN01,1985-02-15,M,juan@hospital.mx,+52 123 456 7890,Calle Principal 123
Mar√≠a L√≥pez Rodr√≠guez,LOPM870512HDFRNR02,1987-05-12,F,maria@hospital.mx,+52 987 654 3210,Avenida Secundaria 456
Carlos Rodr√≠guez Gonz√°lez,ROGC741203HDFNLS03,1974-12-03,M,carlos@hospital.mx,+52 555 555 5555,Calle Tercera 789
Ana Mart√≠nez S√°nchez,MASA950623HDFTNA04,1995-06-23,F,ana@hospital.mx,+52 444 444 4444,Avenida Cuarta 321
Roberto P√©rez L√≥pez,PELOR640815HDFPLB05,1964-08-15,M,roberto@hospital.mx,+52 333 333 3333,Calle Quinta 654`;
            
            const blob = new Blob([plantilla], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'plantilla-pacientes.csv';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }
        
        // Importar pacientes desde CSV
        async function importarDesdeCsv() {
            const archivo = document.getElementById('csv-archivo').files[0];
            if (!archivo) {
                alert('Por favor selecciona un archivo CSV');
                return;
            }
            
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Importando...';
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const csv = e.target.result;
                    const lineas = csv.split('\\n').filter(l => l.trim());
                    
                    if (lineas.length < 2) {
                        alert('El archivo CSV debe tener encabezados y datos');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-upload mr-2"></i> Importar Pacientes';
                        return;
                    }
                    
                    const encabezados = lineas[0].split(',').map(h => h.trim());
                    const pacientes = [];
                    
                    // Parsear datos
                    for (let i = 1; i < lineas.length; i++) {
                        if (!lineas[i].trim()) continue;
                        
                        const valores = lineas[i].split(',').map(v => v.trim());
                        const paciente = {};
                        
                        encabezados.forEach((enc, idx) => {
                            paciente[enc.toLowerCase()] = valores[idx] || '';
                        });
                        
                        if (paciente.nombre && paciente.curp && paciente.email && paciente.fecha_nacimiento) {
                            pacientes.push(paciente);
                        }
                    }
                    
                    if (pacientes.length === 0) {
                        alert('No se encontraron pacientes v√°lidos en el archivo');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-upload mr-2"></i> Importar Pacientes';
                        return;
                    }
                    
                    // Guardar pacientes en lotes
                    let guardados = 0;
                    for (const p of pacientes) {
                        try {
                            const fechaNac = new Date(p.fecha_nacimiento);
                            const edad = new Date().getFullYear() - fechaNac.getFullYear();
                            
                            await db.collection('patients').doc().set({
                                nombre: p.nombre.split(' ')[0],
                                apellido: p.nombre.includes(' ') ? p.nombre.split(' ').slice(1).join(' ') : '',
                                curp: p.curp.toUpperCase(),
                                sexo: p.sexo || '',
                                edad: edad,
                                email: p.email,
                                telefono: p.telefono || '',
                                direccion: p.direccion || '',
                                fechaNacimiento: fechaNac,
                                assignedDoctor: currentUser.uid,
                                createdAt: new Date(),
                                updatedAt: new Date(),
                                antecedentes: {
                                    alergias: [],
                                    patologicos: [],
                                    'no-patologicos': [],
                                    heredofamiliares: [],
                                    psiquiatricos: [],
                                    vacunas: []
                                }
                            });
                            guardados++;
                        } catch (err) {
                            console.error('Error guardando paciente:', p.nombre, err);
                        }
                    }
                    
                    alert(`‚úÖ Se importaron ${guardados} pacientes correctamente`);
                    cerrarModalImportarExcel();
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-upload mr-2"></i> Importar Pacientes';
                    loadMedicoPatients();
                };
                
                reader.readAsText(archivo);
            } catch (error) {
                console.error('Error importando CSV:', error);
                alert('Error al importar CSV: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-upload mr-2"></i> Importar Pacientes';
            }
        }
        
        // ==================== RECETAS ELECTR√ìNICAS ====================
        
        // Variables globales para recetas
        let medicamentosReceta = [];
        let plantillasRecetas = [];
        let medicamentosBDCache = [];
        
        // Base de datos de medicamentos ampliada (mejores pr√°cticas internacionales)
        const medicamentosBD = [
            { nombre: 'Paracetamol', dosis: '500mg', grupo: 'Analg√©sico', presentacion: 'Comprimidos', interacciones: [], contraindicaciones: [] },
            { nombre: 'Ibuprofeno', dosis: '400mg', grupo: 'Antiinflamatorio', presentacion: 'Comprimidos', interacciones: ['Paracetamol'], contraindicaciones: ['Embarazo'] },
            { nombre: 'Amoxicilina', dosis: '500mg', grupo: 'Antibi√≥tico', presentacion: 'C√°psulas', interacciones: [], contraindicaciones: ['Alergia Penicilina'] },
            { nombre: 'Omeprazol', dosis: '20mg', grupo: 'Anti√°cido', presentacion: 'C√°psulas', interacciones: [], contraindicaciones: [] },
            { nombre: 'Metformina', dosis: '500mg', grupo: 'Antidiab√©tico', presentacion: 'Comprimidos', interacciones: [], contraindicaciones: [] },
            { nombre: 'Loratadina', dosis: '10mg', grupo: 'Antihistam√≠nico', presentacion: 'Comprimidos', interacciones: [], contraindicaciones: [] },
            { nombre: 'Ranitidina', dosis: '150mg', grupo: 'Anti√°cido', presentacion: 'Comprimidos', interacciones: ['Omeprazol'], contraindicaciones: [] },
            { nombre: 'Dipirona', dosis: '500mg', grupo: 'Analg√©sico', presentacion: 'Comprimidos', interacciones: ['Paracetamol'], contraindicaciones: [] },
            { nombre: 'Clonazepam', dosis: '0.5mg', grupo: 'Ansiol√≠tico', presentacion: 'Comprimidos', interacciones: [], contraindicaciones: ['Embarazo', 'Depresi√≥n'] },
            { nombre: 'Lisinopril', dosis: '10mg', grupo: 'Antihipertensivo', presentacion: 'Comprimidos', interacciones: [], contraindicaciones: ['Embarazo'] }
        ];
        
        medicamentosBDCache = medicamentosBD;
        
        // Variables para cache de pacientes en recetas
        let pacientesRecetaCache = [];
        
        // Cargar pacientes para b√∫squeda en recetas
        function cargarPacientesReceta() {
            if (currentRole !== 'medico') return;
            
            db.collection('patients')
                .where('assignedDoctor', '==', currentUser.uid)
                .get()
                .then(snapshot => {
                    pacientesRecetaCache = [];
                    snapshot.forEach(doc => {
                        pacientesRecetaCache.push({
                            id: doc.id,
                            nombre: doc.data().nombre || '',
                            apellido: doc.data().apellido || '',
                            cedula: doc.data().cedula || '',
                            email: doc.data().email || '',
                            curp: doc.data().curp || ''
                        });
                    });
                });
        }
        
        // B√∫squeda fuzzy de pacientes en recetas
        function buscarPacienteReceta() {
            const termino = document.getElementById('buscar-paciente-receta').value.toLowerCase().trim();
            const contenedor = document.getElementById('resultados-pacientes-receta');
            
            if (!termino) {
                contenedor.classList.add('hidden');
                return;
            }
            
            const resultados = pacientesRecetaCache.filter(p => {
                const nombre = `${p.nombre} ${p.apellido}`.toLowerCase();
                const email = p.email.toLowerCase();
                const curp = p.curp.toLowerCase();
                const cedula = p.cedula.toLowerCase();
                
                return nombre.includes(termino) || email.includes(termino) || 
                       curp.includes(termino) || cedula.includes(termino);
            });
            
            if (resultados.length === 0) {
                contenedor.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">No se encontraron pacientes</div>';
                contenedor.classList.remove('hidden');
                return;
            }
            
            contenedor.innerHTML = resultados.map(p => `
                <div class="px-4 py-3 border-b border-gray-200 cursor-pointer hover:bg-blue-50 transition" onclick="seleccionarPacienteReceta('${p.id}', '${p.nombre} ${p.apellido}', '${p.cedula}', '${p.email}')">
                    <div class="font-bold text-gray-900">${p.nombre} ${p.apellido}</div>
                    <div class="text-xs text-gray-600">CURP: ${p.curp} | Email: ${p.email} | C√©dula: ${p.cedula}</div>
                </div>
            `).join('');
            
            contenedor.classList.remove('hidden');
        }
        
        // Seleccionar paciente en receta
        function seleccionarPacienteReceta(pacienteId, nombre, cedula, email) {
            document.getElementById('receta-paciente').value = pacienteId;
            document.getElementById('buscar-paciente-receta').value = nombre;
            document.getElementById('paciente-receta-texto').textContent = `${nombre} (${cedula}) - ${email}`;
            document.getElementById('paciente-receta-info').classList.remove('hidden');
            document.getElementById('resultados-pacientes-receta').classList.add('hidden');
            actualizarPreview();
        }
        
        // B√∫squeda inteligente de medicamentos
        let medicamentoTimeout;
        document.getElementById('buscar-medicamento')?.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            const dropdown = document.getElementById('medicamentos-dropdown');
            
            clearTimeout(medicamentoTimeout);
            
            if (query.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            
            medicamentoTimeout = setTimeout(() => {
                const resultados = medicamentosBDCache.filter(m => 
                    m.nombre.toLowerCase().includes(query) ||
                    m.grupo.toLowerCase().includes(query)
                );
                
                if (resultados.length === 0) {
                    dropdown.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm italic">No hay resultados</div>';
                    dropdown.classList.remove('hidden');
                    return;
                }
                
                dropdown.innerHTML = resultados.map(med => `
                    <div class="px-4 py-3 border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition" onclick="agregarMedicamento('${med.nombre.replace(/'/g, "\\'")}', '${med.dosis}', '${med.grupo}', '${med.presentacion}')">
                        <div class="font-bold text-gray-900">${med.nombre}</div>
                        <div class="text-xs text-gray-600">${med.dosis} ‚Ä¢ ${med.grupo} ‚Ä¢ ${med.presentacion}</div>
                    </div>
                `).join('');
                dropdown.classList.remove('hidden');
            }, 300);
        });
        
        // Agregar medicamento a la tabla
        function agregarMedicamento(nombre, dosis, grupo, presentacion) {
            const id = Date.now();
            medicamentosReceta.push({ 
                id, 
                nombre, 
                dosis, 
                grupo,
                presentacion,
                frecuencia: '', 
                dias: '',
                comentarios: ''
            });
            document.getElementById('buscar-medicamento').value = '';
            document.getElementById('medicamentos-dropdown').classList.add('hidden');
            renderizarTabla();
            actualizarPreview();
            actualizarContador();
        }
        
        // Renderizar tabla de medicamentos
        function renderizarTabla() {
            const tbody = document.getElementById('medicamentos-tabla');
            
            if (medicamentosReceta.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500 italic">Sin medicamentos agregados</td></tr>';
                return;
            }
            
            tbody.innerHTML = medicamentosReceta.map(med => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-3">
                        <div class="font-bold text-gray-900">${med.nombre}</div>
                        <div class="text-xs text-gray-600">${med.dosis} ‚Ä¢ ${med.grupo}</div>
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" placeholder="Ej: 500mg" value="${med.dosis}" 
                               onchange="actualizarMedicamento(${med.id}, 'dosis', this.value)"
                               class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" placeholder="Ej: c/8 hrs" value="${med.frecuencia}" 
                               onchange="actualizarMedicamento(${med.id}, 'frecuencia', this.value)"
                               class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
                    </td>
                    <td class="px-4 py-3">
                        <input type="text" placeholder="Ej: 7 d√≠as" value="${med.dias}" 
                               onchange="actualizarMedicamento(${med.id}, 'dias', this.value)"
                               class="w-full border border-gray-300 rounded px-2 py-1 text-xs">
                    </td>
                    <td class="px-4 py-3 text-center">
                        <button type="button" onclick="eliminarMedicamento(${med.id})" class="text-red-600 hover:text-red-900 text-lg font-bold" title="Eliminar">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Actualizar medicamento
        function actualizarMedicamento(id, campo, valor) {
            const med = medicamentosReceta.find(m => m.id === id);
            if (med) {
                med[campo] = valor;
                actualizarPreview();
            }
        }
        
        // Eliminar medicamento
        function eliminarMedicamento(id) {
            medicamentosReceta = medicamentosReceta.filter(m => m.id !== id);
            renderizarTabla();
            actualizarPreview();
            actualizarContador();
        }
        
        // Actualizar contador de medicamentos
        function actualizarContador() {
            const contador = document.getElementById('contador-medicamentos');
            if (contador) {
                const cantidad = medicamentosReceta.length;
                contador.textContent = cantidad === 1 ? '1 medicamento' : `${cantidad} medicamentos`;
            }
        }
        
        // Actualizar vista previa
        function actualizarPreview() {
            const pacienteSelect = document.getElementById('receta-paciente');
            const pacienteId = pacienteSelect.value;
            
            if (pacienteId) {
                db.collection('patients').doc(pacienteId).get().then(doc => {
                    if (doc.exists) {
                        const p = doc.data();
                        document.getElementById('preview-nombre-paciente').textContent = `Paciente: ${p.nombre} ${p.apellido || ''}`;
                        document.getElementById('preview-cedula-paciente').textContent = `C√©dula: ${p.cedula || 'N/A'} | Edad: ${p.edad || 'N/A'}`;
                    }
                });
            } else {
                document.getElementById('preview-nombre-paciente').textContent = 'Paciente: -';
                document.getElementById('preview-cedula-paciente').textContent = '';
            }
            
            if (medicamentosReceta.length === 0) {
                document.getElementById('preview-medicamentos').innerHTML = '<p class="italic text-gray-500">Agrega medicamentos...</p>';
            } else {
                document.getElementById('preview-medicamentos').innerHTML = medicamentosReceta.map(m => `
                    <div class="text-xs mb-2 pb-2 border-b border-gray-200">
                        <p class="font-bold text-gray-900">${m.nombre} ${m.dosis}</p>
                        <p class="text-gray-600">${m.frecuencia || '-'} √ó ${m.dias || '-'}</p>
                    </div>
                `).join('');
            }
            
            // Actualizar instrucciones
            const instruccionesDiv = document.getElementById('instrucciones');
            const instruccionesPreview = document.getElementById('preview-instrucciones');
            if (instruccionesDiv) {
                const texto = instruccionesDiv.innerText || '';
                instruccionesPreview.innerHTML = texto ? `<p class="text-xs text-gray-700">${texto}</p>` : '<p class="italic text-gray-500">Escribe instrucciones...</p>';
            }
            
            // Actualizar vista de firma digital
            const firmaPreview = document.getElementById('firma-preview');
            if (firmaDigitalData) {
                firmaPreview.classList.remove('hidden');
                document.getElementById('firma-cedula-preview').textContent = document.getElementById('med-cedula')?.value || 'N/A';
                document.getElementById('firma-cert-preview').textContent = firmaDigitalData.nombre;
                document.getElementById('firma-hash-preview').textContent = 'receta-' + Math.random().toString(36).substr(2, 9);
            } else {
                firmaPreview.classList.add('hidden');
            }
        }
        
        // Actualizar preview cuando cambia el paciente
        document.getElementById('receta-paciente')?.addEventListener('change', actualizarPreview);
        
        // Guardar receta
        function guardarReceta() {
            if (medicamentosReceta.length === 0) {
                alert('‚ö†Ô∏è Agrega al menos un medicamento');
                return;
            }
            
            const pacienteId = document.getElementById('receta-paciente').value;
            if (!pacienteId) {
                alert('‚ö†Ô∏è Selecciona un paciente');
                return;
            }
            
            const instrucciones = document.getElementById('instrucciones')?.innerText || '';
            
            if (!instrucciones.trim()) {
                alert('‚ö†Ô∏è Agrega instrucciones m√©dicas');
                return;
            }
            
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Guardando...';
                
                // Crear objeto de receta con firma digital si est√° disponible
                const recetaData = {
                    medicamentos: medicamentosReceta.map(m => ({
                        nombre: m.nombre,
                        dosis: m.dosis,
                        grupo: m.grupo,
                        presentacion: m.presentacion,
                        frecuencia: m.frecuencia,
                        dias: m.dias,
                        comentarios: m.comentarios
                    })),
                    instrucciones: instrucciones,
                    doctorId: currentUser.uid,
                    createdAt: firebase.firestore.Timestamp.now(),
                    estado: 'activa'
                };
                
                // Agregar firma digital si est√° disponible
                if (firmaDigitalData) {
                    const cedula = document.getElementById('med-cedula')?.value || '';
                    recetaData.firmaDigital = {
                        cedulaMedica: cedula,
                        certificado: firmaDigitalData.nombre,
                        firmadoEn: firebase.firestore.FieldValue.serverTimestamp(),
                        vigencia: new Date(new Date().setFullYear(new Date().getFullYear() + 1)),
                        hash: 'receta-' + Math.random().toString(36).substr(2, 9),
                        validaParaSAT: true
                    };
                }
                
                db.collection('patients').doc(pacienteId).collection('prescriptions').doc().set(recetaData).then((docRef) => {
                    let mensaje = '‚úÖ Receta guardada correctamente';
                    if (recetaData.firmaDigital) {
                        mensaje += '\nüîê Firmada digitalmente con certificado SAT';
                    }
                    alert(mensaje);
                    limpiarReceta();
                }).catch(error => {
                    alert('‚ùå Error al guardar: ' + error.message);
                }).finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Guardar Receta';
                });
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }
        
        // Limpiar receta
        function limpiarReceta() {
            medicamentosReceta = [];
            document.getElementById('receta-paciente').value = '';
            document.getElementById('buscar-medicamento').value = '';
            const instrDiv = document.getElementById('instrucciones');
            if (instrDiv) instrDiv.innerHTML = '';
            renderizarTabla();
            actualizarPreview();
            actualizarContador();
        }
        
        // Aplicar formato de texto
        function formatoTexto(comando, valor = null) {
            document.execCommand(comando, false, valor);
            document.getElementById('instrucciones').focus();
        }
        
        // Guardar como plantilla
        function guardarComoPlantilla() {
            if (medicamentosReceta.length === 0) {
                alert('‚ö†Ô∏è Agrega medicamentos primero');
                return;
            }
            
            const nombre = prompt('¬øC√≥mo deseas llamar esta plantilla?');
            if (!nombre) return;
            
            plantillasRecetas.push({
                id: Date.now(),
                nombre: nombre,
                medicamentos: [...medicamentosReceta],
                instrucciones: document.getElementById('instrucciones').innerText
            });
            
            alert('‚úÖ Plantilla guardada como: ' + nombre);
        }
        
        // Abrir plantillas
        function abrirPlantillas() {
            if (plantillasRecetas.length === 0) {
                alert('‚ÑπÔ∏è No hay plantillas guardadas');
                return;
            }
            
            const lista = plantillasRecetas.map((p, i) => `${i + 1}. ${p.nombre}`).join('\n');
            alert('Plantillas guardadas:\n' + lista);
        }
        
        // Exportar receta a PDF
        function exportarRecetaPDF() {
            if (medicamentosReceta.length === 0) {
                alert('‚ö†Ô∏è No hay receta para exportar');
                return;
            }
            
            alert('‚ÑπÔ∏è Exportar PDF en desarrollo');
        }
        
        // Compartir receta
        function compartirReceta(medio) {
            if (medicamentosReceta.length === 0) {
                alert('‚ö†Ô∏è No hay receta para compartir');
                return;
            }
            
            const pacienteId = document.getElementById('receta-paciente').value;
            if (!pacienteId) {
                alert('‚ö†Ô∏è Selecciona un paciente');
                return;
            }
            
            alert('‚ÑπÔ∏è Funci√≥n de compartir en desarrollo');
        }
        
        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#buscar-medicamento') && !e.target.closest('#medicamentos-dropdown')) {
                document.getElementById('medicamentos-dropdown')?.classList.add('hidden');
            }
        });
        
        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#buscar-medicamento') && !e.target.closest('#medicamentos-dropdown')) {
                document.getElementById('medicamentos-dropdown')?.classList.add('hidden');
            }
        });

        // ==================== ANTECEDENTES CL√çNICOS ====================
        
        let antecedentesTemp = {
            alergias: [],
            patologicos: [],
            'no-patologicos': [],
            heredofamiliares: [],
            psiquiatricos: [],
            vacunas: []
        };

        // Abrir modal
        function abrirModalAntecedentes() {
            document.getElementById('modal-antecedentes').classList.remove('hidden');
            cargarAntecedentesFromFirestore();
        }

        // Cerrar modal
        function cerrarModalAntecedentes() {
            document.getElementById('modal-antecedentes').classList.add('hidden');
        }

        // Cargar antecedentes desde Firestore
        async function cargarAntecedentesFromFirestore() {
            if (!currentUser) return;
            
            try {
                const doc = await db.collection('patients').doc(currentUser.uid).get();
                if (doc.exists) {
                    antecedentesTemp = doc.data().antecedentes || {
                        alergias: [],
                        patologicos: [],
                        'no-patologicos': [],
                        heredofamiliares: [],
                        psiquiatricos: [],
                        vacunas: []
                    };
                    renderAntecedentes();
                }
            } catch (error) {
                console.error('Error cargando antecedentes:', error);
            }
        }

        // Agregar antecedente
        function agregarAntecedente(tipo) {
            const input = document.getElementById(`input-${tipo}`);
            const valor = input.value.trim();
            
            if (!valor) {
                alert('Por favor ingresa un valor');
                return;
            }
            
            if (!antecedentesTemp[tipo]) {
                antecedentesTemp[tipo] = [];
            }
            
            antecedentesTemp[tipo].push(valor);
            input.value = '';
            renderAntecedentes();
        }

        // Eliminar antecedente
        function eliminarAntecedente(tipo, index) {
            antecedentesTemp[tipo].splice(index, 1);
            renderAntecedentes();
        }

        // Renderizar antecedentes
        function renderAntecedentes() {
            const tipos = ['alergias', 'patologicos', 'no-patologicos', 'heredofamiliares', 'psiquiatricos', 'vacunas'];
            
            tipos.forEach(tipo => {
                const lista = document.getElementById(`lista-${tipo}`);
                if (!lista) return;
                
                lista.innerHTML = (antecedentesTemp[tipo] || []).map((item, idx) => `
                    <div class="flex justify-between items-center bg-white p-2 rounded border text-sm">
                        <span>${item}</span>
                        <button onclick="eliminarAntecedente('${tipo}', ${idx})" class="text-red-600 hover:text-red-900 font-bold">‚úï</button>
                    </div>
                `).join('');
            });
        }

        // Guardar antecedentes a Firestore
        async function guardarAntecedentes() {
            if (!currentUser) {
                alert('Error: usuario no identificado');
                return;
            }
            
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Guardando...';
                
                // Determinar qu√© ID usar: si es m√©dico, usar el paciente; si es paciente, usar su propio ID
                const patientIdToUpdate = currentRole === 'medico' ? currentPatientId : currentUser.uid;
                
                if (!patientIdToUpdate) {
                    alert('‚ö†Ô∏è Error: No se identific√≥ el paciente');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i>Guardar Cambios';
                    return;
                }
                
                await db.collection('patients').doc(patientIdToUpdate).update({
                    antecedentes: antecedentesTemp
                });
                
                alert('‚úÖ Antecedentes guardados correctamente');
                cerrarModalAntecedentes();
                
                // Recargar el mismo paciente que se estaba viendo
                if (currentRole === 'medico' && currentPatientId) {
                    loadPatientRecordById(currentPatientId);
                } else {
                    loadPatientRecord();
                }
            } catch (error) {
                console.error('Error guardando antecedentes:', error);
                alert('Error al guardar antecedentes');
            }
        }

        // ==================== AGENDA OPERATIVA PROFESIONAL ====================
        
        let agendaState = {
            vistaActual: 'semana',
            fechaActual: new Date(),
            citas: [],
            recordatorios: [],
            medicoSeleccionado: null
        };

        // Cargar y mostrar m√©dicos disponibles
        async function cargarMedicosAgenda() {
            try {
                const medicosSnapshot = await db.collection('doctors').get();
                const medicosSelectorDiv = document.getElementById('medicos-selector-grid');
                
                if (!medicosSelectorDiv) return;
                
                let html = '';
                let firstMedico = true;
                
                medicosSnapshot.forEach(doc => {
                    const medico = doc.data();
                    const esSeleccionado = agendaState.medicoSeleccionado === doc.id || (firstMedico && !agendaState.medicoSeleccionado);
                    
                    if (firstMedico && !agendaState.medicoSeleccionado) {
                        agendaState.medicoSeleccionado = doc.id;
                        firstMedico = false;
                    }
                    
                    const bgColor = esSeleccionado ? '#1465ff' : 'white';
                    const textColor = esSeleccionado ? 'white' : '#374151';
                    const borderColor = esSeleccionado ? '#1465ff' : '#d1d5db';
                    
                    html += `
                        <button onclick="seleccionarMedicoAgenda('${doc.id}', this)" 
                            style="padding: 6px 12px; border: 1px solid ${borderColor}; background: ${bgColor}; color: ${textColor}; border-radius: 6px; font-size: 10px; font-weight: bold; cursor: pointer; transition: all 0.2s; white-space: nowrap;">
                            ${medico.nombre || 'Dr. ' + medico.apellido || 'M√©dico'}
                        </button>
                    `;
                });
                
                medicosSelectorDiv.innerHTML = html;
            } catch (error) {
                console.error('Error cargando m√©dicos:', error);
            }
        }
        
        // Seleccionar m√©dico en agenda
        function seleccionarMedicoAgenda(medicoId, btnElement) {
            agendaState.medicoSeleccionado = medicoId;
            
            // Actualizar estilos de botones
            const botones = document.getElementById('medicos-selector-grid').querySelectorAll('button');
            botones.forEach(btn => {
                btn.style.backgroundColor = 'white';
                btn.style.color = '#374151';
                btn.style.borderColor = '#d1d5db';
            });
            
            // Marcar como seleccionado
            btnElement.style.backgroundColor = '#1465ff';
            btnElement.style.color = 'white';
            btnElement.style.borderColor = '#1465ff';
            
            // Recargar agenda
            renderizarAgenda();
        }

        // Cambiar vista de agenda
        function cambiarVistaAgenda(vista) {
            agendaState.vistaActual = vista;
            
            // Actualizar botones activos
            ['hoy', 'dia', 'semana', 'mes'].forEach(v => {
                const btn = document.getElementById(`btn-${v}`);
                if (btn) {
                    if (v === vista) {
                        btn.style.backgroundColor = '#1465ff';
                        btn.style.color = 'white';
                        btn.style.borderColor = '#1465ff';
                    } else {
                        btn.style.backgroundColor = 'white';
                        btn.style.color = '#333';
                        btn.style.borderColor = '#ddd';
                    }
                }
            });
            
            renderizarAgenda();
        }

        // Navegar en agenda
        function navegarAgenda(dias) {
            if (dias === 0) {
                agendaState.fechaActual = new Date();
            } else {
                agendaState.fechaActual.setDate(agendaState.fechaActual.getDate() + dias);
            }
            renderizarAgenda();
        }

        // Renderizar agenda seg√∫n vista
        async function renderizarAgenda() {
            const container = document.getElementById('agenda-calendario-container');
            const vista = agendaState.vistaActual;
            
            if (vista === 'semana') {
                await renderizarAgendaSemanal(container);
            } else if (vista === 'dia') {
                renderizarAgendaDiaria(container);
            } else if (vista === 'mes') {
                renderizarAgendaMensual(container);
            }
            
            actualizarRangoFechas();
            renderizarMiniCalendario();
            actualizarRecordatorios();
        }

        // Renderizar vista semanal (NUEVA: Con slots de 15 minutos - 4 por hora)
        async function renderizarAgendaSemanal(container) {
            const fechaInicio = new Date(agendaState.fechaActual);
            const dia = fechaInicio.getDay();
            fechaInicio.setDate(fechaInicio.getDate() - (dia === 0 ? 6 : dia - 1));
            
            // Obtener horarios del doctor actual
            let horarioInicio = '08:00';
            let horarioFin = '17:00';
            let diasLaborales = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes'];
            
            const docSelectorId = agendaState.medicoSeleccionado || currentUser.uid;
            
            try {
                const docSnap = await db.collection('doctors').doc(docSelectorId).get();
                if (docSnap.exists && docSnap.data().horarios) {
                    horarioInicio = docSnap.data().horarios.inicio || '08:00';
                    horarioFin = docSnap.data().horarios.fin || '17:00';
                    diasLaborales = docSnap.data().horarios.diasLaborales || diasLaborales;
                }
            } catch (error) {
                console.log('Usando horarios por defecto');
            }
            
            // Obtener citas de la semana
            let citasMap = new Map();
            let pacientesCache = {};
            
            try {
                const citasSnapshot = await db.collection('appointments')
                    .where('doctorId', '==', docSelectorId)
                    .get();
                
                const fechaFin = new Date(fechaInicio.getTime() + 7 * 24 * 60 * 60 * 1000);
                
                citasSnapshot.forEach(doc => {
                    const cita = doc.data();
                    const citaFecha = cita.fechaHora?.toDate?.() || new Date(cita.fecha + 'T' + cita.hora);
                    
                    if (citaFecha >= fechaInicio && citaFecha < fechaFin) {
                        const key = cita.fecha + '_' + cita.hora;
                        citasMap.set(key, {id: doc.id, ...cita});
                    }
                });
                
                // Pre-cargar datos de pacientes
                const pacientesIds = Array.from(citasMap.values()).map(c => c.pacienteId);
                const uniquePacientesIds = [...new Set(pacientesIds)];
                
                for (const pacienteId of uniquePacientesIds) {
                    try {
                        const pacDoc = await db.collection('patients').doc(pacienteId).get();
                        if (pacDoc.exists) {
                            pacientesCache[pacienteId] = pacDoc.data().nombre || 'Paciente';
                        }
                    } catch (e) {
                        pacientesCache[pacienteId] = 'Paciente';
                    }
                }
            } catch (error) {
                console.error('Error cargando citas:', error);
            }
            
            // Convertir horarios a minutos
            const [hiH, hiM] = horarioInicio.split(':').map(Number);
            const [hfH, hfM] = horarioFin.split(':').map(Number);
            const minutosInicio = hiH * 60 + hiM;
            const minutosFin = hfH * 60 + hfM;
            
            let html = '<div style="overflow-x: auto; max-height: 70vh;">';
            html += '<table style="width: 100%; border-collapse: collapse;">';
            
            // Encabezado STICKY
            html += '<thead style="position: sticky; top: 0; z-index: 20;">';
            html += '<tr style="border-bottom: 2px solid #1465ff; background: white;">';
            html += '<td style="width: 60px; padding: 8px 4px; background: white; font-weight: bold; text-align: center; font-size: 10px; border-right: 1px solid #e5e7eb; position: sticky; left: 0; z-index: 21;">HORA</td>';
            
            const diasSemana = ['LUNES', 'MARTES', 'MI√âRCOLES', 'JUEVES', 'VIERNES', 'S√ÅBADO', 'DOMINGO'];
            const diasSemanaLowercase = ['lunes', 'martes', 'miercoles', 'jueves', 'viernes', 'sabado', 'domingo'];
            
            for (let i = 0; i < 7; i++) {
                const fecha = new Date(fechaInicio);
                fecha.setDate(fecha.getDate() + i);
                const num = fecha.getDate();
                const esHoy = fecha.toDateString() === new Date().toDateString();
                const esLaborable = diasLaborales.includes(diasSemanaLowercase[i]);
                
                html += `<td style="width: 140px; padding: 8px 4px; background: ${esHoy ? '#dbeafe' : (esLaborable ? '#f9fafb' : '#f3f4f6')}; font-weight: bold; text-align: center; font-size: 10px; border-right: 1px solid #e5e7eb; color: #1f2937;">
                    <div style="font-size: 10px; font-weight: bold;">${diasSemana[i]}</div>
                    <div style="font-size: 9px; color: #666;">${num}</div>
                </td>`;
            }
            html += '</tr>';
            html += '</thead>';
            
            // Cuerpo con slots de 15 minutos (4 por hora)
            html += '<tbody>';
            
            // Bloquear horas cerradas ANTES de inicio
            const [inicioH, inicioM] = horarioInicio.split(':').map(Number);
            const [finalH, finalM] = horarioFin.split(':').map(Number);
            const minutosFinal = finalH * 60 + finalM;
            
            // Generar TODAS las horas del d√≠a (0-23)
            for (let horaActual = 0; horaActual < 24; horaActual++) {
                for (let slot = 0; slot < 4; slot++) {
                    const minutoSlot = (slot * 15);
                    const minutosTotal = horaActual * 60 + minutoSlot;
                    
                    const horas = Math.floor(minutosTotal / 60);
                    const mins = minutosTotal % 60;
                    const horaStr = `${String(horas).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
                    
                    const mostrarHora = slot === 0;
                    const esFueraDeHorario = minutosTotal < minutosInicio || minutosTotal >= minutosFinal;
                    
                    html += '<tr style="height: 28px; border-bottom: 1px solid #e5e7eb;">';
                    
                    if (mostrarHora) {
                        const bgHora = esFueraDeHorario ? '#d1d5db' : '#f9fafb';
                        const colorHora = esFueraDeHorario ? '#666' : '#374151';
                        html += `<td style="padding: 2px 4px; text-align: center; font-weight: bold; font-size: 9px; background: ${bgHora}; border-right: 1px solid #e5e7eb; vertical-align: center; position: sticky; left: 0; z-index: 10; color: ${colorHora};" rowspan="4">${String(horas).padStart(2, '0')}:00</td>`;
                    }
                    
                    for (let i = 0; i < 7; i++) {
                        const fecha = new Date(fechaInicio);
                        fecha.setDate(fecha.getDate() + i);
                        const fechaStr = fecha.toISOString().split('T')[0];
                        const esLaborable = diasLaborales.includes(diasSemanaLowercase[i]);
                        const key = fechaStr + '_' + horaStr;
                        const cita = citasMap.get(key);
                        
                        // Determinar color de fondo
                        let bgColor, borderColor, contenido, cursor, onclick;
                        
                        if (esFueraDeHorario) {
                            // Fuera de horario laboral
                            bgColor = '#d1d5db';
                            borderColor = '#c4b5fd';
                            contenido = '';
                            cursor = 'not-allowed';
                            onclick = '';
                        } else if (cita) {
                            // Cita existente
                            const colorMap = {
                                'consulta-general': '#dbeafe',
                                'seguimiento': '#dcfce7',
                                'urgencia': '#fee2e2',
                                'procedimiento': '#fef3c7',
                                'default': '#f0f9ff'
                            };
                            bgColor = colorMap[cita.tipo] || colorMap.default;
                            borderColor = '#3b82f6';
                            const nombrePaciente = pacientesCache[cita.pacienteId] || 'Paciente';
                            contenido = `<span style="font-size: 7px; font-weight: bold; color: #1e40af;">${nombrePaciente}</span><br><span style="font-size: 6px; color: #666;">${cita.tipo.replace('-', ' ')}</span>`;
                            cursor = 'default';
                            onclick = '';
                        } else {
                            // Disponible
                            bgColor = esLaborable ? 'white' : '#f3f4f6';
                            borderColor = '#e5e7eb';
                            contenido = '';
                            cursor = esLaborable ? 'pointer' : 'not-allowed';
                            onclick = esLaborable ? `onclick="abrirModalNuevaCitaConHora('${fechaStr}', '${horaStr}')"` : '';
                        }
                        
                        html += `<td style="padding: 2px; border: 1px solid ${borderColor}; background: ${bgColor}; cursor: ${cursor}; vertical-align: center; text-align: center; font-size: 8px; transition: background-color 0.2s;" ${onclick}>
                            ${contenido}
                        </td>`;
                    }
                    html += '</tr>';
                }
            }
            
            html += '</tbody>';
            html += '</table>';
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // Nueva funci√≥n para abrir modal con fecha y hora espec√≠fica
        function abrirModalNuevaCitaConHora(fecha, hora) {
            document.getElementById('modal-nueva-cita').classList.remove('hidden');
            document.getElementById('cita-paciente').value = '';
            document.getElementById('paciente-cita-id').value = '';
            document.getElementById('cita-fecha').value = fecha;
            document.getElementById('cita-hora').value = hora;
            document.getElementById('cita-duracion').value = '30';
            document.getElementById('cita-tipo').value = 'consulta-general';
            document.getElementById('cita-notas').value = '';
            document.getElementById('resultados-pacientes-cita').classList.add('hidden');
            
            // Cargar pacientes para el buscador
            cargarPacientesAgendaLista();
        }

        // Renderizar vista diaria
        function renderizarAgendaDiaria(container) {
            const fecha = agendaState.fechaActual;
            const diasSemana = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            const mesNombre = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            let html = '<div style="padding: 20px;">';
            html += `<h3 style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">${diasSemana[fecha.getDay()]} ${fecha.getDate()} de ${mesNombre[fecha.getMonth()]}</h3>`;
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">';
            
            const horas = Array.from({length: 17}, (_, i) => 6 + i);
            horas.forEach(hora => {
                html += `<div style="padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; hover:shadow: 0 2px 8px rgba(0,0,0,0.1);" onclick="abrirModalNuevaCita()">
                    <div style="font-weight: bold; font-size: 16px;">${hora}:00 - ${hora + 1}:00</div>
                    <div style="font-size: 13px; color: #666; margin-top: 5px;">Disponible</div>
                </div>`;
            });
            
            html += '</div>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Renderizar vista mensual
        function renderizarAgendaMensual(container) {
            const fecha = agendaState.fechaActual;
            const mesNombre = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            let html = '<div style="padding: 20px;">';
            html += `<h3 style="font-size: 24px; font-weight: bold; margin-bottom: 20px;">${mesNombre[fecha.getMonth()]} ${fecha.getFullYear()}</h3>`;
            
            // Mini calendario del mes
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;">';
            
            const diasSemana = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            diasSemana.forEach(d => {
                html += `<div style="text-align: center; font-weight: bold; padding: 10px; background: #f3f4f6;">${d}</div>`;
            });
            
            const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1).getDay();
            const diasMes = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0).getDate();
            
            // D√≠as en blanco del mes anterior
            for (let i = 0; i < primerDia; i++) {
                html += '<div style="padding: 10px;"></div>';
            }
            
            // D√≠as del mes actual
            for (let i = 1; i <= diasMes; i++) {
                const esHoy = i === new Date().getDate() && fecha.getMonth() === new Date().getMonth();
                html += `<div style="padding: 10px; text-align: center; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; background: ${esHoy ? '#dbeafe' : 'white'}; font-weight: ${esHoy ? 'bold' : 'normal'};" onclick="abrirModalNuevaCita()">${i}</div>`;
            }
            
            html += '</div>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Renderizar mini calendario
        function renderizarMiniCalendario() {
            const container = document.getElementById('mini-calendario');
            const fecha = new Date();
            const mesNombre = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            let html = `<h4 style="font-weight: bold; text-align: center; margin-bottom: 10px;">${mesNombre[fecha.getMonth()]} ${fecha.getFullYear()}</h4>`;
            
            html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; font-size: 11px;">';
            
            const diasSemana = ['D', 'L', 'M', 'M', 'J', 'V', 'S'];
            diasSemana.forEach(d => {
                html += `<div style="font-weight: bold; padding: 5px;">${d}</div>`;
            });
            
            const primerDia = new Date(fecha.getFullYear(), fecha.getMonth(), 1).getDay();
            const diasMes = new Date(fecha.getFullYear(), fecha.getMonth() + 1, 0).getDate();
            
            for (let i = 0; i < primerDia; i++) {
                html += '<div style="padding: 5px;"></div>';
            }
            
            for (let i = 1; i <= diasMes; i++) {
                const esHoy = i === fecha.getDate();
                html += `<div style="padding: 5px; border-radius: 4px; background: ${esHoy ? '#1465ff' : '#f3f4f6'}; color: ${esHoy ? 'white' : 'black'}; font-weight: ${esHoy ? 'bold' : 'normal'}; cursor: pointer;" onclick="seleccionarDiaAgenda(${i})">${i}</div>`;
            }
            
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Actualizar rango de fechas
        function actualizarRangoFechas() {
            const elemento = document.getElementById('rango-fechas');
            if (!elemento) return;
            
            const fecha = agendaState.fechaActual;
            const meses = ['ENE', 'FEB', 'MAR', 'ABR', 'MAY', 'JUN', 'JUL', 'AGO', 'SEP', 'OCT', 'NOV', 'DIC'];
            
            if (agendaState.vistaActual === 'semana') {
                const inicio = new Date(fecha);
                const fin = new Date(fecha);
                fin.setDate(fin.getDate() + 6);
                elemento.textContent = `${inicio.getDate()} ${meses[inicio.getMonth()].toUpperCase()} ${inicio.getFullYear()} - ${fin.getDate()} ${meses[fin.getMonth()].toUpperCase()} ${fin.getFullYear()}`;
            } else if (agendaState.vistaActual === 'dia') {
                elemento.textContent = `${fecha.getDate()} ${meses[fecha.getMonth()].toUpperCase()} ${fecha.getFullYear()}`;
            } else if (agendaState.vistaActual === 'mes') {
                elemento.textContent = `${meses[fecha.getMonth()].toUpperCase()} ${fecha.getFullYear()}`;
            }
        }

        // Actualizar recordatorios
        function actualizarRecordatorios() {
            const container = document.getElementById('recordatorios-agenda');
            if (!container) return;
            
            // Recordatorios de ejemplo
            const recordatorios = [
                { fecha: '20 FEB', paciente: 'Agust√≠n Lozano', tipo: 'Recordar Cita' }
            ];
            
            if (recordatorios.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 italic">Sin recordatorios</p>';
            } else {
                container.innerHTML = recordatorios.map(r => `
                    <div class="border-l-4 border-blue-500 bg-blue-50 p-3 rounded">
                        <div class="font-bold text-sm text-gray-900">${r.fecha}</div>
                        <div class="text-xs text-gray-600">${r.paciente}</div>
                        <div class="text-xs text-blue-600 font-semibold">${r.tipo}</div>
                    </div>
                `).join('');
            }
        }

        // Funciones auxiliares
        function seleccionarDiaAgenda(dia) {
            agendaState.fechaActual.setDate(dia);
            renderizarAgenda();
        }

        function abrirConfiguracionAgenda() {
            alert('‚öôÔ∏è Configuraci√≥n de Agenda - Pr√≥ximamente');
        }

        function abrirLinkPortal(tipo) {
            alert('üîó Abriendo portal...');
        }

        function copiarLinkPortal() {
            const enlace = 'https://app.nimbo-x.com/c/atencion';
            navigator.clipboard.writeText(enlace);
            alert('‚úÖ Enlace copiado al portapapeles');
        }

        function imprimirAgenda() {
            window.print();
        }

        function exportarAgendaCSV() {
            alert('üì• Descargar agenda en desarrollo');
        }

        // Variables para cache de pacientes en citas
        let pacientesCitaCache = [];

        // Abrir modal Nueva Cita
        function abrirModalNuevaCita(pacienteId = null) {
            document.getElementById('modal-nueva-cita').classList.remove('hidden');
            document.getElementById('cita-paciente').value = '';
            document.getElementById('paciente-cita-id').value = '';
            document.getElementById('resultados-pacientes-cita').classList.add('hidden');
            
            // Cargar pacientes para el buscador
            cargarPacientesAgendaLista();
            
            // Establecer fecha m√≠nima a hoy
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById('cita-fecha').min = hoy;
            document.getElementById('cita-fecha').value = hoy;
            document.getElementById('cita-hora').value = '10:00';
        }
        
        // Cargar pacientes para autocompletar en agenda
        // Cerrar modal Nueva Cita
        function cerrarModalNuevaCita() {
            document.getElementById('modal-nueva-cita').classList.add('hidden');
            document.getElementById('cita-paciente').value = '';
            document.getElementById('paciente-cita-id').value = '';
            document.getElementById('cita-fecha').value = '';
            document.getElementById('cita-hora').value = '';
            document.getElementById('cita-duracion').value = '30';
            document.getElementById('cita-tipo').value = 'consulta-general';
            document.getElementById('cita-notas').value = '';
            document.getElementById('resultados-pacientes-cita').classList.add('hidden');
        }

        // B√∫squeda fuzzy de pacientes en citas
        function buscarPacienteCita() {
            const termino = document.getElementById('cita-paciente').value.toLowerCase().trim();
            const contenedor = document.getElementById('resultados-pacientes-cita');
            
            if (!termino) {
                contenedor.classList.add('hidden');
                return;
            }
            
            const resultados = pacientesCitaCache.filter(p => {
                const nombre = `${p.nombre} ${p.apellido}`.toLowerCase();
                const cedula = p.cedula.toLowerCase();
                
                return nombre.includes(termino) || cedula.includes(termino);
            });
            
            if (resultados.length === 0) {
                contenedor.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">No se encontraron pacientes</div>';
                contenedor.classList.remove('hidden');
                return;
            }
            
            contenedor.innerHTML = resultados.map(p => `
                <div class="px-4 py-3 border-b border-gray-200 cursor-pointer hover:bg-blue-50 transition" onclick="seleccionarPacienteCitaFuzzy('${p.id}', '${p.nombre} ${p.apellido}')">
                    <div class="font-bold text-gray-900">${p.nombre} ${p.apellido}</div>
                    <div class="text-xs text-gray-600">C√©dula: ${p.cedula}</div>
                </div>
            `).join('');
            
            contenedor.classList.remove('hidden');
        }

        // Seleccionar paciente en cita (fuzzy)
        function seleccionarPacienteCitaFuzzy(pacienteId, nombre) {
            document.getElementById('cita-paciente').value = nombre;
            document.getElementById('paciente-cita-id').value = pacienteId;
            document.getElementById('resultados-pacientes-cita').classList.add('hidden');
        }

        // Cargar pacientes para b√∫squeda en citas
        async function cargarPacientesAgendaLista() {
            try {
                const snapshot = await db.collection('patients')
                    .where('assignedDoctor', '==', currentUser.uid)
                    .get();
                
                pacientesCitaCache = [];
                snapshot.forEach(doc => {
                    pacientesCitaCache.push({
                        id: doc.id,
                        nombre: doc.data().nombre || '',
                        apellido: doc.data().apellido || '',
                        curp: doc.data().curp || '',
                        cedula: doc.data().cedula || '',
                        email: doc.data().email || ''
                    });
                });
            } catch (error) {
                console.error('Error cargando pacientes para agenda:', error);
            }
        }

        // Mostrar pacientes en tabla de agenda
        function mostrarPacientesAgendaLista(pacientes) {
            const tbody = document.getElementById('agenda-pacientes-tbody');
            
            if (pacientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No hay pacientes registrados</td></tr>';
                return;
            }
            
            tbody.innerHTML = pacientes.map(p => `
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 text-gray-900 font-bold">${p.nombre} ${p.apellido}</td>
                    <td class="px-6 py-4 text-gray-700 text-sm">${p.curp}</td>
                    <td class="px-6 py-4 text-gray-700 text-sm">${p.email}</td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="abrirModalNuevaCita('${p.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold transition">
                            Agendar
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Filtrar pacientes en tabla de agenda
        function filtrarPacientesAgendaLista() {
            const busqueda = document.getElementById('buscar-pacientes-agenda').value.toLowerCase();
            
            if (busqueda === '') {
                mostrarPacientesAgendaLista(pacientesAgendaGlobal);
            } else {
                const filtrados = pacientesAgendaGlobal.filter(p =>
                    p.nombre.toLowerCase().includes(busqueda) ||
                    p.apellido.toLowerCase().includes(busqueda) ||
                    p.curp.toLowerCase().includes(busqueda) ||
                    p.email.toLowerCase().includes(busqueda)
                );
                mostrarPacientesAgendaLista(filtrados);
            }
        }

        // Guardar cita en Firestore
        async function guardarNuevaCita(btn) {
            if (!currentUser) {
                alert('Error: usuario no identificado');
                return;
            }

            const pacienteId = document.getElementById('paciente-cita-id').value;
            const fecha = document.getElementById('cita-fecha').value;
            const hora = document.getElementById('cita-hora').value;
            const duracion = parseInt(document.getElementById('cita-duracion').value);
            const tipo = document.getElementById('cita-tipo').value;
            const notas = document.getElementById('cita-notas').value;

            if (!pacienteId || !fecha || !hora) {
                alert('Por favor completa todos los campos requeridos');
                return;
            }

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Guardando...';

                // Crear documento de cita
                const fechaHora = new Date(`${fecha}T${hora}`);
                
                await db.collection('appointments').add({
                    doctorId: currentUser.uid,
                    pacienteId: pacienteId,
                    fecha: fecha,
                    hora: hora,
                    fechaHora: fechaHora,
                    duracion: duracion,
                    tipo: tipo,
                    notas: notas,
                    estado: 'pendiente',
                    createdAt: new Date(),
                    updatedAt: new Date()
                });

                alert('‚úÖ Cita creada correctamente');
                cerrarModalNuevaCita();
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Crear Cita';
                
                // Recargar agenda semanal
                const container = document.getElementById('agenda-container');
                if (container) {
                    await renderizarAgendaSemanal(container);
                }
            } catch (error) {
                console.error('Error guardando cita:', error);
                alert('Error al guardar cita: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Crear Cita';
            }
        }

        // Inicializar FullCalendar
        function inicializarAgenda() {
            const calendarEl = document.getElementById('agenda-calendar');
            if (!calendarEl || agendaCalendar) return;

            agendaCalendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                height: 'auto',
                eventSources: [
                    {
                        id: 'appointments',
                        events: async function(info, successCallback, failureCallback) {
                            try {
                                const snapshot = await db.collection('appointments')
                                    .where('doctorId', '==', currentUser.uid)
                                    .get();
                                
                                const events = [];
                                snapshot.forEach(doc => {
                                    const cita = doc.data();
                                    const colores = {
                                        'pendiente': '#9CA3AF',
                                        'confirmada': '#3B82F6',
                                        'en-consulta': '#EF4444',
                                        'completada': '#10B981'
                                    };
                                    
                                    events.push({
                                        id: doc.id,
                                        title: `${cita.tipo} - ${cita.pacienteId}`,
                                        start: `${cita.fecha}T${cita.hora}`,
                                        duration: `00:${cita.duracion < 60 ? cita.duracion : '00'}:00`,
                                        backgroundColor: colores[cita.estado] || '#9CA3AF',
                                        borderColor: colores[cita.estado] || '#9CA3AF',
                                        extendedProps: {
                                            pacienteId: cita.pacienteId,
                                            estado: cita.estado,
                                            tipo: cita.tipo,
                                            duracion: cita.duracion,
                                            notas: cita.notas
                                        }
                                    });
                                });
                                
                                successCallback(events);
                            } catch (error) {
                                console.error('Error cargando eventos:', error);
                                failureCallback(error);
                            }
                        }
                    }
                ],
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    alert(`
Cita: ${info.event.title}
Paciente: ${props.pacienteId}
Estado: ${props.estado}
Tipo: ${props.tipo}
Duraci√≥n: ${props.duracion} min
Notas: ${props.notas || 'Sin notas'}
                    `);
                }
            });

            agendaCalendar.render();
        }

        // ==================== PRODUCTOS/SERVICIOS M√âDICOS ====================
        
        let productosCache = [];
        
        // Abrir modal Nuevo Producto
        function abrirModalNuevoProducto() {
            document.getElementById('modal-nuevo-producto').classList.remove('hidden');
            document.getElementById('modal-titulo-producto').textContent = 'Crear Nuevo Servicio/Producto';
            const btnGuardar = document.getElementById('btn-guardar-producto');
            btnGuardar.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Crear Servicio';
            btnGuardar.onclick = guardarNuevoProducto;
            limpiarFormularioProducto();
        }
        
        // Cerrar modal Nuevo Producto
        function cerrarModalNuevoProducto() {
            document.getElementById('modal-nuevo-producto').classList.add('hidden');
            limpiarFormularioProducto();
        }
        
        // Limpiar formulario producto
        function limpiarFormularioProducto() {
            document.getElementById('prod-codigo').value = '';
            document.getElementById('prod-nombre').value = '';
            document.getElementById('prod-categoria').value = '';
            document.getElementById('prod-precio').value = '';
            document.getElementById('prod-descripcion').value = '';
            document.getElementById('prod-activo').checked = true;
        }
        
        // Guardar nuevo producto
        async function guardarNuevoProducto() {
            const codigo = document.getElementById('prod-codigo').value.trim();
            const nombre = document.getElementById('prod-nombre').value.trim();
            const categoria = document.getElementById('prod-categoria').value;
            const precio = parseFloat(document.getElementById('prod-precio').value);
            const descripcion = document.getElementById('prod-descripcion').value.trim();
            const activo = document.getElementById('prod-activo').checked;
            
            if (!codigo || !nombre || !categoria || !precio) {
                alert('Por favor completa los campos requeridos (*)');
                return;
            }
            
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Guardando...';
                
                await db.collection('servicios').doc().set({
                    codigo: codigo,
                    nombre: nombre,
                    categoria: categoria,
                    precio: precio,
                    descripcion: descripcion,
                    activo: activo,
                    doctorId: currentUser.uid,
                    createdAt: firebase.firestore.Timestamp.now(),
                    updatedAt: firebase.firestore.Timestamp.now()
                });
                
                alert('‚úÖ Servicio creado correctamente');
                cerrarModalNuevoProducto();
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Crear Servicio';
                cargarProductos();
            } catch (error) {
                console.error('Error creando servicio:', error);
                alert('Error al crear servicio: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Crear Servicio';
            }
        }
        
        // Cargar productos
        async function cargarProductos() {
            try {
                const snapshot = await db.collection('servicios')
                    .where('doctorId', '==', currentUser.uid)
                    .get();
                
                productosCache = [];
                const tbody = document.getElementById('productos-tbody');
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay servicios registrados</td></tr>';
                    return;
                }
                
                tbody.innerHTML = snapshot.docs.map(doc => {
                    const p = doc.data();
                    productosCache.push({id: doc.id, ...p});
                    const estado = p.activo ? '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">Activo</span>' : '<span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-xs font-bold">Inactivo</span>';
                    
                    return `
                        <tr class="hover:bg-gray-50 transition cursor-pointer" onclick="editarProducto('${doc.id}')">
                            <td class="px-6 py-4 text-gray-900 font-bold text-sm">${p.codigo}</td>
                            <td class="px-6 py-4 text-gray-900 font-bold">${p.nombre}</td>
                            <td class="px-6 py-4 text-gray-700 text-sm">${p.categoria}</td>
                            <td class="px-6 py-4 text-right text-gray-900 font-bold">$${p.precio.toFixed(2)}</td>
                            <td class="px-6 py-4 text-center">${estado}</td>
                            <td class="px-6 py-4 text-center space-x-2" onclick="event.stopPropagation();">
                                <button onclick="eliminarProducto('${doc.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-bold transition">Eliminar</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error cargando productos:', error);
            }
        }
        
        // Editar producto
        async function editarProducto(id) {
            try {
                const doc = await db.collection('servicios').doc(id).get();
                if (!doc.exists) {
                    alert('Servicio no encontrado');
                    return;
                }
                
                const p = doc.data();
                
                // Llenar el modal con los datos del producto
                document.getElementById('prod-codigo').value = p.codigo || '';
                document.getElementById('prod-nombre').value = p.nombre || '';
                document.getElementById('prod-categoria').value = p.categoria || '';
                document.getElementById('prod-precio').value = p.precio || '';
                document.getElementById('prod-descripcion').value = p.descripcion || '';
                document.getElementById('prod-activo').checked = p.activo || false;
                
                // Cambiar el t√≠tulo del modal
                document.getElementById('modal-titulo-producto').textContent = 'Editar Servicio/Producto';
                
                // Cambiar el bot√≥n de env√≠o
                const btnGuardar = document.getElementById('btn-guardar-producto');
                btnGuardar.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Actualizar Servicio';
                btnGuardar.onclick = () => guardarEdicionProducto(id);
                
                // Abrir el modal
                document.getElementById('modal-nuevo-producto').classList.remove('hidden');
            } catch (error) {
                console.error('Error cargando producto para edici√≥n:', error);
                alert('Error al cargar el servicio');
            }
        }
        
        // Guardar edici√≥n de producto
        async function guardarEdicionProducto(id) {
            const codigo = document.getElementById('prod-codigo').value.trim();
            const nombre = document.getElementById('prod-nombre').value.trim();
            const categoria = document.getElementById('prod-categoria').value.trim();
            const precio = parseFloat(document.getElementById('prod-precio').value);
            const descripcion = document.getElementById('prod-descripcion').value.trim();
            const activo = document.getElementById('prod-activo').checked;
            
            if (!codigo || !nombre || !categoria || !precio) {
                alert('Por favor completa todos los campos requeridos (*)');
                return;
            }
            
            try {
                const btn = document.getElementById('btn-guardar-producto');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Actualizando...';
                
                await db.collection('servicios').doc(id).update({
                    codigo,
                    nombre,
                    categoria,
                    precio,
                    descripcion,
                    activo
                });
                
                alert('‚úÖ Servicio actualizado correctamente');
                cerrarModalNuevoProducto();
                cargarProductos();
                
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> Crear Servicio';
            } catch (error) {
                console.error('Error actualizando producto:', error);
                alert('Error al actualizar: ' + error.message);
                const btn = document.getElementById('btn-guardar-producto');
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Actualizar Servicio';
            }
        }
        
        function eliminarProducto(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este servicio?')) {
                db.collection('servicios').doc(id).delete().then(() => {
                    alert('‚úÖ Servicio eliminado');
                    cargarProductos();
                }).catch(err => console.error('Error:', err));
            }
        }

        // ==================== SISTEMA DE COBROS ====================
        
        // Abrir modal Nuevo Cobro
        function abrirModalNuevoCobro() {
            document.getElementById('modal-nuevo-cobro').classList.remove('hidden');
            cargarPacientesCobro();
            cargarProductosCobro();
            limpiarFormularioCobro();
        }
        
        // Cerrar modal Nuevo Cobro
        function cerrarModalNuevoCobro() {
            document.getElementById('modal-nuevo-cobro').classList.add('hidden');
            limpiarFormularioCobro();
        }
        
        // Limpiar formulario cobro
        function limpiarFormularioCobro() {
            document.getElementById('cobro-paciente').value = '';
            document.getElementById('cobro-producto').value = '';
            document.getElementById('cobro-monto').value = '';
            document.getElementById('cobro-metodo').value = 'efectivo';
            document.getElementById('cobro-estado').value = 'pagado';
            document.getElementById('cobro-notas').value = '';
        }
        
        // Cargar pacientes para cobro
        async function cargarPacientesCobro() {
            try {
                const snapshot = await db.collection('patients')
                    .where('assignedDoctor', '==', currentUser.uid)
                    .get();
                
                const select = document.getElementById('cobro-paciente');
                select.innerHTML = '<option value="">Selecciona un paciente...</option>';
                
                snapshot.docs.forEach(doc => {
                    const p = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${p.nombre} ${p.apellido}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando pacientes:', error);
            }
        }
        
        // Cargar productos para cobro
        async function cargarProductosCobro() {
            try {
                const snapshot = await db.collection('servicios')
                    .where('doctorId', '==', currentUser.uid)
                    .where('activo', '==', true)
                    .get();
                
                const select = document.getElementById('cobro-producto');
                select.innerHTML = '<option value="">Selecciona un servicio...</option>';
                
                snapshot.docs.forEach(doc => {
                    const p = doc.data();
                    const option = document.createElement('option');
                    option.value = JSON.stringify({id: doc.id, nombre: p.nombre, precio: p.precio});
                    option.textContent = `${p.nombre} - $${p.precio.toFixed(2)}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando productos:', error);
            }
        }
        
        // Actualizar monto desde producto seleccionado
        function actualizarMontoCobro() {
            const prodJson = document.getElementById('cobro-producto').value;
            if (!prodJson) return;
            
            try {
                const prod = JSON.parse(prodJson);
                document.getElementById('cobro-monto').value = prod.precio.toFixed(2);
            } catch (e) {
                console.error('Error parseando producto:', e);
            }
        }
        
        // Guardar nuevo cobro
        async function guardarNuevoCobro() {
            const pacienteId = document.getElementById('cobro-paciente').value;
            const prodJson = document.getElementById('cobro-producto').value;
            const monto = parseFloat(document.getElementById('cobro-monto').value);
            const metodo = document.getElementById('cobro-metodo').value;
            const estado = document.getElementById('cobro-estado').value;
            const notas = document.getElementById('cobro-notas').value.trim();
            
            if (!pacienteId || !prodJson || !monto) {
                alert('Por favor completa los campos requeridos (*)');
                return;
            }
            
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Registrando...';
                
                const prod = JSON.parse(prodJson);
                
                await db.collection('cobros').doc().set({
                    doctorId: currentUser.uid,
                    pacienteId: pacienteId,
                    productoId: prod.id,
                    producto: prod.nombre,
                    monto: monto,
                    metodo: metodo,
                    estado: estado,
                    notas: notas,
                    fecha: firebase.firestore.Timestamp.now(),
                    createdAt: firebase.firestore.Timestamp.now()
                });
                
                alert('‚úÖ Cobro registrado correctamente');
                cerrarModalNuevoCobro();
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Registrar Cobro';
                cargarCobros();
            } catch (error) {
                console.error('Error registrando cobro:', error);
                alert('Error al registrar cobro: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Registrar Cobro';
            }
        }
        
        // Cargar cobros
        async function cargarCobros() {
            try {
                const snapshot = await db.collection('cobros')
                    .where('doctorId', '==', currentUser.uid)
                    .orderBy('fecha', 'desc')
                    .get();
                
                const tbody = document.getElementById('cobros-tbody');
                let totalHoy = 0, totalMes = 0, totalPendiente = 0;
                const hoy = new Date().toDateString();
                const mesActual = new Date().getMonth();
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No hay cobros registrados</td></tr>';
                } else {
                    tbody.innerHTML = snapshot.docs.map(doc => {
                        const c = doc.data();
                        
                        // Manejar fecha correctamente
                        let fecha;
                        try {
                            if (c.fecha && typeof c.fecha.toDate === 'function') {
                                fecha = c.fecha.toDate();
                            } else if (c.fecha instanceof Date) {
                                fecha = c.fecha;
                            } else {
                                fecha = new Date();
                            }
                        } catch (e) {
                            console.warn('Error parsando fecha de cobro:', e);
                            fecha = new Date();
                        }
                        
                        const fechaStr = fecha.toLocaleDateString('es-MX');
                        const esPagado = c.estado === 'pagado';
                        
                        if (esPagado) {
                            if (fecha.toDateString() === hoy) totalHoy += c.monto;
                            if (fecha.getMonth() === mesActual) totalMes += c.monto;
                        } else {
                            totalPendiente += c.monto;
                        }
                        
                        const estadoBadge = c.estado === 'pagado' ? '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">Pagado</span>' : c.estado === 'pendiente' ? '<span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-xs font-bold">Pendiente</span>' : '<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold">Parcial</span>';
                        
                        return `
                            <tr class="hover:bg-gray-50 transition">
                                <td class="px-6 py-4 text-gray-900 font-bold text-sm">${c.pacienteId.substring(0, 8)}...</td>
                                <td class="px-6 py-4 text-gray-700 text-sm">${c.producto}</td>
                                <td class="px-6 py-4 text-right text-gray-900 font-bold">$${c.monto.toFixed(2)}</td>
                                <td class="px-6 py-4 text-center">${estadoBadge}</td>
                                <td class="px-6 py-4 text-center text-sm text-gray-600">${fechaStr}</td>
                                <td class="px-6 py-4 text-center">
                                    <button onclick="verDetalleCobro('${doc.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs font-bold transition">Ver</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
                
                document.getElementById('total-hoy').textContent = '$' + totalHoy.toFixed(2);
                document.getElementById('total-mes').textContent = '$' + totalMes.toFixed(2);
                document.getElementById('total-pendiente').textContent = '$' + totalPendiente.toFixed(2);
                document.getElementById('total-transacciones').textContent = snapshot.size;
                
            } catch (error) {
                console.error('Error cargando cobros:', error);
            }
        }
        
        function verDetalleCobro(id) {
            alert('Funcionalidad de detalle en desarrollo');
        }

        // Switch View
        function switchView(view) {
            document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
            document.getElementById(view)?.classList.remove('hidden');
            
            // Cargar pacientes si abre recetas o nueva consulta
            if (view === 'recetas') {
                cargarPacientesReceta();
            } else if (view === 'nueva-consulta') {
                cargarPacientesConsulta();
                cargarProductos(); // Cargar servicios para el buscador de cargos
            } else if (view === 'agenda-operativa') {
                agendaState.vistaActual = 'semana'; // Establecer vista semanal por defecto
                setTimeout(async () => {
                    await renderizarAgenda();
                    cargarPacientesAgendaLista();
                }, 100);
            } else if (view === 'mi-cuenta') {
                cargarPerfil();
            } else if (view === 'productos') {
                cargarProductos();
            } else if (view === 'cobros') {
                cargarCobros();
            }
        }

        // ==================== MI CUENTA ====================
        
        // Cargar perfil del m√©dico
        async function cargarPerfil() {
            try {
                const doc = await db.collection('doctors').doc(currentUser.uid).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('med-nombre').value = data.nombre || '';
                    document.getElementById('med-cedula').value = data.cedulaProfesional || '';
                    document.getElementById('med-rfc').value = data.rfc || '';
                    document.getElementById('med-email').value = data.email || '';
                    document.getElementById('med-telefono').value = data.telefono || '';
                    document.getElementById('med-especialidad-primaria').value = data.especialidadPrimaria || '';
                    document.getElementById('med-especialidad-secundaria').value = data.especialidadSecundaria || '';
                    document.getElementById('med-cedula-especialista').value = data.cedulaEspecialista || '';
                    document.getElementById('med-anos-experiencia').value = data.anosExperiencia || '';
                    document.getElementById('perm-recetas').checked = data.permisos?.recetas !== false;
                    document.getElementById('perm-laboratorio').checked = data.permisos?.laboratorio || false;
                    document.getElementById('conf-agenda').checked = data.config?.agenda !== false;
                    document.getElementById('conf-cobros').checked = data.config?.cobros !== false;
                    
                    // Load doctor photo if exists
                    if (data.fotoUrl) {
                        const fotoPreview = document.getElementById('med-foto-preview');
                        if (fotoPreview) fotoPreview.src = data.fotoUrl;
                    }
                } else {
                    // Si no existe, cargar datos del auth
                    const user = await auth.currentUser;
                    document.getElementById('med-email').value = user.email || '';
                }
            } catch (error) {
                console.error('Error cargando perfil:', error);
            }
        }
        
        // Guardar perfil del m√©dico
        async function guardarPerfil() {
            const nombre = document.getElementById('med-nombre').value.trim();
            const cedula = document.getElementById('med-cedula').value.trim();
            const rfc = document.getElementById('med-rfc').value.trim().toUpperCase();
            const email = document.getElementById('med-email').value.trim();
            const telefono = document.getElementById('med-telefono').value.trim();
            const especialidadPrimaria = document.getElementById('med-especialidad-primaria').value;
            const especialidadSecundaria = document.getElementById('med-especialidad-secundaria').value;
            const cedulaEspecialista = document.getElementById('med-cedula-especialista').value.trim();
            const anosExperiencia = parseInt(document.getElementById('med-anos-experiencia').value) || 0;
            
            // Obtener horarios
            const horarioInicio = document.getElementById('horario-inicio').value;
            const horarioFin = document.getElementById('horario-fin').value;
            const diasSemana = Array.from(document.querySelectorAll('.dias-semana:checked')).map(el => el.value);
            
            if (!nombre || !cedula || !rfc || !especialidadPrimaria) {
                alert('Por favor completa los campos requeridos (*)');
                return;
            }
            
            if (rfc.length !== 13) {
                alert('El RFC debe tener 13 caracteres');
                return;
            }
            
            if (!horarioInicio || !horarioFin) {
                alert('Por favor configura los horarios de atenci√≥n');
                return;
            }
            
            if (diasSemana.length === 0) {
                alert('Por favor selecciona al menos un d√≠a laboral');
                return;
            }
            
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Guardando...';
                
                await db.collection('doctors').doc(currentUser.uid).set({
                    nombre: nombre,
                    cedulaProfesional: cedula,
                    rfc: rfc,
                    email: email,
                    telefono: telefono,
                    especialidadPrimaria: especialidadPrimaria,
                    especialidadSecundaria: especialidadSecundaria,
                    cedulaEspecialista: cedulaEspecialista,
                    anosExperiencia: anosExperiencia,
                    horarios: {
                        inicio: horarioInicio,
                        fin: horarioFin,
                        diasLaborales: diasSemana
                    },
                    permisos: {
                        consulta: true,
                        recetas: document.getElementById('perm-recetas').checked,
                        laboratorio: document.getElementById('perm-laboratorio').checked
                    },
                    config: {
                        agenda: document.getElementById('conf-agenda').checked,
                        cobros: document.getElementById('conf-cobros').checked
                    },
                    updatedAt: new Date()
                }, { merge: true });
                
                alert('‚úÖ Perfil y horarios actualizados correctamente');
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Guardar Cambios';
            } catch (error) {
                console.error('Error guardando perfil:', error);
                alert('Error al guardar perfil: ' + error.message);
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-save mr-2"></i> Guardar Cambios';
            }
        }

        // Photo Upload Handler for Doctor
        const medFotoInput = document.getElementById('med-foto-input');
        if (medFotoInput) {
            medFotoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    alert('‚ö†Ô∏è Por favor selecciona una imagen');
                    return;
                }
                
                try {
                    const userId = auth.currentUser.uid;
                    
                    // Read file as base64
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const base64Data = event.target.result;
                            
                            // Update Firestore with base64 image
                            await db.collection('doctors').doc(userId).set({
                                fotoUrl: base64Data,
                                fotoUpdatedAt: new Date()
                            }, { merge: true });
                            
                            // Update preview
                            document.getElementById('med-foto-preview').src = base64Data;
                            alert('‚úÖ Foto actualizada correctamente');
                            
                            console.log('‚úÖ Foto de m√©dico actualizada');
                        } catch (error) {
                            console.error('Error updating doctor photo:', error);
                            alert('‚ùå Error al cargar la foto: ' + error.message);
                        }
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Error uploading doctor photo:', error);
                    alert('‚ùå Error al cargar la foto: ' + error.message);
                }
            });
        }

        // Photo Upload Handler for Patient
        const expFotoInput = document.getElementById('exp-foto-input');
        if (expFotoInput) {
            expFotoInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                if (!file.type.startsWith('image/')) {
                    alert('‚ö†Ô∏è Por favor selecciona una imagen');
                    return;
                }
                
                try {
                    // Use currentPatientId if available (doctor viewing patient), else use current user
                    const patientId = currentRole === 'medico' && currentPatientId ? currentPatientId : auth.currentUser.uid;
                    
                    // Read file as base64
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const base64Data = event.target.result;
                            
                            // Update Firestore with base64 image
                            await db.collection('patients').doc(patientId).set({
                                fotoUrl: base64Data,
                                fotoUpdatedAt: new Date()
                            }, { merge: true });
                            
                            // Update preview
                            document.getElementById('exp-foto-preview').src = base64Data;
                            alert('‚úÖ Foto actualizada correctamente');
                            
                            console.log('‚úÖ Foto de paciente actualizada');
                        } catch (error) {
                            console.error('Error updating patient photo:', error);
                            alert('‚ùå Error al cargar la foto: ' + error.message);
                        }
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('Error uploading patient photo:', error);
                    alert('‚ùå Error al cargar la foto: ' + error.message);
                }
            });
        }

        // Logout
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await auth.signOut();
            currentUser = null;
            currentRole = null;
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('dashboard-screen').classList.add('hidden');
            document.getElementById('login-email').value = '';
            document.getElementById('login-password').value = '';
        });

        console.log('‚úÖ MediCore iniciado correctamente');
    </script>
</body>
</html>
